<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–≤–µ—Ä–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/modern-style.css">
  <link rel="icon" type="image/png"
        href="{{ url_for('static', path='img/omega-logo.png') }}">
  <style>
    :root{
      --brand:#3b82f6;
      --brand-2:#2563eb;
      --ink:#0f172a;
      --muted:#64748b;
      --bg:#f8fafc;
      --card:#ffffff;
    }
    body{background:#f3f4f6}
    .container .card{box-shadow:0 12px 35px rgba(15,23,42,0.08);border-radius:16px}

    /* Top back button */
    .back-top{
      position:fixed;left:12px;top:14px;z-index:1000;
      background:linear-gradient(180deg,#fff,#f8fafc);
      border:1px solid rgba(15,23,42,.08);
      border-left:3px solid var(--brand);
      border-radius:9999px;
      padding:8px 12px;
      display:flex;align-items:center;gap:8px;
      color:var(--ink);font-weight:600;cursor:pointer;
      box-shadow:0 6px 20px rgba(15,23,42,.10);
    }
    .back-top:hover{background:#fff}

    /* AI analysis box (–±–µ–∑ summary/details) */
    .ai-box{
      margin:20px 0;
      background:#f5f7fc;
      border:1px solid #e2e8f0;
      border-left:4px solid var(--brand);
      border-radius:10px;
      padding:16px;
    }
    .toggle-under{
      display:inline-flex;align-items:center;gap:8px;margin-top:10px;
      padding:8px 12px;border-radius:10px;border:1px solid #cbd5e1;background:#eef2ff;
      color:#1e293b;font-weight:600;cursor:pointer;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .toggle-under:hover{background:#e2e8ff}

    /* Mail buttons */
    .mail-buttons{display:flex;gap:15px;margin-top:15px;flex-wrap:wrap}
    .mail-buttons a,.mail-buttons button{
      flex:1;min-width:220px;padding:12px 20px;font-size:16px;cursor:pointer;border:none;border-radius:8px;
      transition:all .3s ease;color:#fff;text-align:center;text-decoration:none;display:flex;align-items:center;justify-content:center;font-weight:500
    }
    .btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb)}
    .btn-success{background:linear-gradient(135deg,#28a745,#20c997)}
    .btn-warning{background:linear-gradient(135deg,#ffc107,#ff9800)}
    .btn-danger{background:linear-gradient(135deg,#dc3545,#c82333)}
    .btn-neutral{background:linear-gradient(135deg,#6b7280,#4b5563)}
    .mail-buttons a:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .hidden{display:none!important}

    /* Loader */
    #mail-loading{display:none;margin-top:16px;min-height:90px;text-align:center}
    .loading-spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:10px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* Mail result */
    #mail-result{display:none;margin-top:20px;background:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,.05);animation:fadeIn .3s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
    #mail-text{white-space:normal;line-height:1.6}

    .mail-toolbar{display:none;justify-content:flex-end;gap:10px;margin-bottom:10px}
    .copy-btn{
      background:linear-gradient(135deg,#10b981,#059669);
      border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600
    }
    .copy-btn:hover{filter:brightness(1.05)}
    .edit-btn{
      background:linear-gradient(135deg,#6366f1,#4f46e5);
      border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600
    }
    .edit-btn:hover{filter:brightness(1.05)}
    .mail-editor{
      width:100%;min-height:260px;padding:12px 14px;border:1px solid #cbd5e1;border-radius:10px;
      font:400 15px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",sans-serif;resize:vertical;
      box-shadow:inset 0 1px 2px rgba(0,0,0,.04);margin-top:10px;
    }

    /* –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ (Telegram / e-mail) –ø–æ–¥ –ø–∏—Å—å–º–æ–º */
    .send-actions{
      display:none;
      margin-top:14px;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .send-btn{
      border:none;
      border-radius:8px;
      padding:9px 14px;
      font-size:0.9rem;
      font-weight:600;
      cursor:pointer;
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 2px 6px rgba(15,23,42,.18);
    }
    .send-btn-tg{
      background:linear-gradient(135deg,#0ea5e9,#0284c7);
    }
    .send-btn-mail{
      background:linear-gradient(135deg,#f97316,#ea580c);
    }
    .send-btn:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }

    /* Clarifications */
    .clarify-wrap{margin-top:18px}
    .clarify-actions{display:none;gap:10px;margin:12px 0}
    .clarify-btn{background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .clarify-form{display:none;margin-top:10px;background:var(--bg);border:1px solid #e2e8f0;border-radius:10px;padding:12px}
    .clarify-form textarea{width:100%;min-height:160px;padding:10px;border:1px solid #cbd5e1;border-radius:8px;font:400 14px/1.55 ui-sans-serif,system-ui,-apple-system,"Segoe UI",sans-serif}
    .clarify-save{margin-top:10px;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    .clarify-hint{color:var(--muted);font-size:13px;margin-top:6px}

    /* Contacts */
    .contacts-block{margin-top:35px;background:#f8fafc;border-left:4px solid var(--brand);border-radius:10px;padding:20px 24px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .contacts-block h3{margin-top:0;color:#1e293b}
    .contacts-block p{margin:6px 0;font-size:15px;line-height:1.6}

    /* --- –Ω–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è WL --- */
    @keyframes pulseWL{
      0%{box-shadow:0 0 0 0 rgba(37,99,235,.55)}
      70%{box-shadow:0 0 0 12px rgba(37,99,235,0)}
      100%{box-shadow:0 0 0 0 rgba(37,99,235,0)}
    }
    .pulse-wl{animation:pulseWL 1.2s ease-out 3;}
  </style>
</head>
<body>
  {# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏ –±–ª–æ–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ #}
  {% set c = contacts or {} %}
  {% set _tg_raw = (c.get('telegram') or '').strip() %}
  {% if not _tg_raw and tg_username %}{% set _tg_raw = tg_username.strip() %}{% endif %}
  {% if _tg_raw and ('–ù–µ—Ç' not in _tg_raw) %}
    {% set _tg_noat = _tg_raw[1:] if _tg_raw[0] == '@' else _tg_raw %}
    {% set _has_tg = True %}
  {% else %}
    {% set _tg_noat = '' %}
    {% set _has_tg = False %}
  {% endif %}

  {% set _email = (c.get('email') or '').strip() %}
  {% if _email and ('–ù–µ—Ç' not in _email) %}
    {% set _has_email = True %}
  {% else %}
    {% set _has_email = False %}
  {% endif %}

  {% set _phone = (c.get('phone') or '').strip() %}
  {% if _phone and ('–ù–µ—Ç' not in _phone) %}
    {% set _has_phone = True %}
  {% else %}
    {% set _has_phone = False %}
  {% endif %}

  {% set _li = (c.get('linkedin') or '').strip() %}
  {% if _li and ('–ù–µ—Ç' not in _li) %}
    {% set _has_li = True %}
  {% else %}
    {% set _has_li = False %}
  {% endif %}

  {% include "auth/header_auth.html" %}
  <button type="button" class="back-top" onclick="history.back()">
    <span>‚¨Ö</span><span>–ù–∞–∑–∞–¥</span>
  </button>

  <div class="container">
    <div class="card">
      <h1>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–≤–µ—Ä–∫–∏</h1>
      <p class="subtitle">–ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–µ–∑—é–º–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –≤–∞–∫–∞–Ω—Å–∏–∏ –æ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</p>

      <!-- –ê–Ω–∞–ª–∏–∑ –ò–ò (–±–µ–∑ summary/details) -->
      <div id="ai-box" class="ai-box">
        <div class="ai-analysis">{{ ai_text|safe }}</div>
      </div>
      <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥ —Å–≤–µ—Ä–∫–æ–π -->
      <button type="button" id="toggle-sverka" class="toggle-under">‚¨Ü –°–∫—Ä—ã—Ç—å —Å–≤–µ—Ä–∫—É</button>

      <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å–µ–º -->
      <div class="result-section">
        <div class="result-header"><h3>‚úâÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å–µ–º</h3></div>

        <div class="mail-buttons" id="mail-buttons">
          <a href="/api/mail/client?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-primary mail-btn" data-type="client">üìù –ü–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É</a>
          <a href="/api/mail/finalist?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-success mail-btn" data-type="finalist">‚úÖ –ü–∏—Å—å–º–æ —Ñ–∏–Ω–∞–ª–∏—Å—Ç—É</a>
          <a href="/api/mail/utochnenie?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-warning mail-btn" data-type="utochnenie">‚ùì –£—Ç–æ—á–Ω—è—é—â–µ–µ –ø–∏—Å—å–º–æ</a>
          <a href="/api/mail/otkaz?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-danger mail-btn" data-type="otkaz">‚ùå –ü–∏—Å—å–º–æ –æ–± –æ—Ç–∫–∞–∑–µ</a>
          <a href="/api/wl/create?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-neutral mail-btn hidden" id="btn-wl" data-type="wl">üìÑ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å WL-—Ä–µ–∑—é–º–µ</a>
        </div>

        <!-- –õ–æ–∞–¥–µ—Ä -->
        <div id="mail-loading">
          <div class="loading-spinner"></div>
          <p style="color:#475569">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è‚Ä¶ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∏—Å–µ–º -->
        <div id="mail-result">
          <div class="mail-toolbar" id="mail-toolbar">
            <button type="button" class="copy-btn" id="copy-btn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button type="button" class="edit-btn" id="edit-btn" data-state="view">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>

          <textarea id="mail-editor" class="mail-editor" style="display:none;"></textarea>

          <h4>üìß –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</h4>
          <div id="mail-text" aria-live="polite"></div>

          <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞ -->
          <div class="send-actions" id="send-actions">
            {% if _has_tg %}
              <button type="button" class="send-btn send-btn-tg" id="send-tg-btn">
                üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
              </button>
            {% endif %}
            {% if _has_email %}
              <button type="button" class="send-btn send-btn-mail" id="send-email-btn">
                üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ e-mail
              </button>
            {% endif %}
          </div>

          <!-- –ë–ª–æ–∫ —É—Ç–æ—á–Ω–µ–Ω–∏–π -->
          <div class="clarify-wrap">
            <div class="clarify-actions" id="clarify-actions">
              <button type="button" class="clarify-btn" id="clarify-add">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è</button>
            </div>

            <form class="clarify-form" id="clarify-form">
              <label for="clarify-text"><strong>–¢–µ–∫—Å—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–π –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ / –≤–æ–ø—Ä–æ—Å—ã:</strong></label>
              <textarea id="clarify-text" name="clarify_text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–æ—Ç–æ–≤ –Ω–∞ full-time —Å 25 –Ω–æ—è–±—Ä—è; —Å—Ç–∞–≤–∫–∞ –æ—Ç 1800; –†–§, –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä; –æ–ø—ã—Ç —Å GraphQL/Apollo ‚Äî –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π, 1,5 –≥–æ–¥–∞; Micro-frontends ‚Äî Module Federation, –≤–Ω–µ–¥—Ä—è–ª shell-app –∏ –æ–±—â–∏–π UI-–∫–∏—Ç."></textarea>
              <div class="clarify-hint">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ç–∫–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç WL-—Ä–µ–∑—é–º–µ –∏ –ø–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É.</div>
              <button type="submit" class="clarify-save" id="clarify-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å WL –∏ –ø–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É)</button>
            </form>
          </div>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
      <div class="contacts-block">
        <h3>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏</h3>

        {% if _has_tg %}
          <p><strong>Telegram:</strong> <a href="https://t.me/{{ _tg_noat }}" target="_blank">@{{ _tg_noat }}</a></p>
        {% endif %}

        {% if _has_email %}
          <p><strong>E-mail:</strong> <a href="mailto:{{ _email }}">{{ _email }}</a></p>
        {% endif %}

        {% if _has_phone %}
          {% set _tel = _phone.replace(' ', '').replace('(', '').replace(')', '').replace('-', '') %}
          <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <a href="tel:{{ _tel }}">{{ _phone }}</a></p>
        {% endif %}

        {% if _has_li %}
          {% set _li_href = _li if 'http' in _li else 'https://www.linkedin.com/in/' + _li %}
          <p><strong>LinkedIn:</strong> <a href="{{ _li_href }}" target="_blank">{{ _li }}</a></p>
        {% endif %}

        {% if not _has_tg and not _has_email and not _has_phone and not _has_li %}
          <p style="color:#64748b">–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏–ª–∏ —Ç—Ä–µ–±—É—é—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è.</p>
        {% endif %}
      </div>

      <div class="navigation" style="margin-top:15px;">
        <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/vacancy"> üì§ –û—Ç–∫—Ä—ã—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏</a>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const mailButtons  = document.getElementById('mail-buttons');
      const wlButton     = document.getElementById('btn-wl');
      const mailLoading  = document.getElementById('mail-loading');
      const mailResult   = document.getElementById('mail-result');
      const mailText     = document.getElementById('mail-text');
      const toolbar      = document.getElementById('mail-toolbar');
      const copyBtn      = document.getElementById('copy-btn');
      const editBtn      = document.getElementById('edit-btn');
      const mailEditor   = document.getElementById('mail-editor');

      const aiBox        = document.getElementById('ai-box');
      const toggleSverkaBtn = document.getElementById('toggle-sverka');

      // –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
      const sendActions   = document.getElementById('send-actions');
      const sendTgBtn     = document.getElementById('send-tg-btn');
      const sendEmailBtn  = document.getElementById('send-email-btn');

      // –£—Ç–æ—á–Ω–µ–Ω–∏—è
      const clarifyActions = document.getElementById('clarify-actions');
      const clarifyAddBtn  = document.getElementById('clarify-add');
      const clarifyForm    = document.getElementById('clarify-form');
      const clarifyText    = document.getElementById('clarify-text');
      const clarifySaveBtn = document.getElementById('clarify-save');

      let currentPlainText = '';
      let hasLetter = false;

      const pageParams = {
        vacancy_id: "{{ vacancy_id }}",
        candidate_fullname: "{{ candidate_fullname }}",
        tg_username: "{{ tg_username }}"
      };

      // –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞)
      const CONTACT_TG    = "{{ _tg_noat if _has_tg else '' }}";
      const CONTACT_EMAIL = "{{ _email  if _has_email else '' }}";


      function setLetter(plainText){
        const html = (plainText || '').replace(/\n/g,'<br>');
        mailText.innerHTML = html;
        currentPlainText   = plainText || '';
        toolbar.style.display = 'flex';
        mailResult.style.display = 'block';
        mailResult.scrollIntoView({behavior:'smooth',block:'nearest'});
        hasLetter = true;
        if (sendActions && (sendTgBtn || sendEmailBtn)) {
          sendActions.style.display = 'flex';
        }
      }
      function showButtons(){ mailButtons.style.display = 'flex'; }
      function normalizeUrl(u){ return String(u || '').replace(/\\/g,'/'); }

      /* === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WL-–∫–Ω–æ–ø–∫–æ–π === */
      function hideWl(){
        wlButton.classList.add('hidden');
        wlButton.classList.remove('btn-primary');
        wlButton.classList.add('btn-neutral');
        wlButton.dataset.type = 'wl';
        wlButton.removeAttribute('download');
        wlButton.textContent = 'üìÑ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å WL-—Ä–µ–∑—é–º–µ';
        wlButton.href = `/api/wl/create?vacancy_id=${encodeURIComponent(pageParams.vacancy_id)}&candidate_fullname=${encodeURIComponent(pageParams.candidate_fullname)}&tg_username=${encodeURIComponent(pageParams.tg_username||'')}`;
      }
      function showWlCreate(){
        wlButton.classList.remove('hidden');
        wlButton.classList.remove('btn-primary');
        wlButton.classList.add('btn-neutral');
        wlButton.dataset.type = 'wl';
        wlButton.removeAttribute('download');
        wlButton.textContent = 'üìÑ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å WL-—Ä–µ–∑—é–º–µ';
        wlButton.href = `/api/wl/create?vacancy_id=${encodeURIComponent(pageParams.vacancy_id)}&candidate_fullname=${encodeURIComponent(pageParams.candidate_fullname)}&tg_username=${encodeURIComponent(pageParams.tg_username||'')}`;
        try{ wlButton.scrollIntoView({behavior:'smooth',block:'center'});}catch(_){}
      }
      function turnWlButtonToDownload(url, filename){
        url = normalizeUrl(url);
        if(!url) return;
        wlButton.classList.remove('hidden');
        wlButton.href = url;
        wlButton.textContent = '‚¨á –°–∫–∞—á–∞—Ç—å WL-—Ä–µ–∑—é–º–µ';
        wlButton.classList.remove('btn-neutral');
        wlButton.classList.add('btn-primary');
        wlButton.dataset.type = 'download';
        if (filename) wlButton.setAttribute('download', filename);
        else wlButton.removeAttribute('download');
        requestAnimationFrame(() => {
          wlButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
          try { wlButton.focus({ preventScroll: true }); } catch(_) {}
          wlButton.classList.add('pulse-wl');
          setTimeout(() => wlButton.classList.remove('pulse-wl'), 2500);
        });
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–≤–µ—Ä–∫–∏
      toggleSverkaBtn.addEventListener('click', () => {
        const hidden = aiBox.style.display === 'none';
        aiBox.style.display = hidden ? 'block' : 'none';
        toggleSverkaBtn.textContent = hidden ? '‚¨Ü –°–∫—Ä—ã—Ç—å —Å–≤–µ—Ä–∫—É' : '‚¨á –†–∞—Å–∫—Ä—ã—Ç—å —Å–≤–µ—Ä–∫—É';
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      async function handleClick(btn){
        // –°–±—Ä–æ—Å UI –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
        clarifyActions.style.display = 'none';     // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—å –±–ª–æ–∫ —É—Ç–æ—á–Ω–µ–Ω–∏–π
        if (btn.dataset.type === 'client') {
          hideWl();
        } else if (btn.dataset.type === 'utochnenie') {
          hideWl();
        } else if (btn.dataset.type === 'finalist' || btn.dataset.type === 'otkaz') {
          hideWl();
        }

        if(btn.dataset.type !== 'wl'){ mailResult.style.display = 'none'; }
        mailButtons.style.display = 'none';
        mailLoading.style.display = 'block';

        try{
          const resp = await fetch(btn.href);
          const data = await (async function parseJsonSafe(r){
            const ct = r.headers.get('content-type') || '';
            if (ct.includes('application/json')) return await r.json();
            const t = await r.text();
            throw new Error(t.slice(0,500));
          })(resp);

          mailLoading.style.display = 'none';
          showButtons();

          if(data.error){
            mailText.innerText = '–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
            toolbar.style.display = 'none';
            mailResult.style.display = 'block';
            return;
          }

          if(btn.dataset.type === 'wl'){
            const url = data.download_link || data.url || data.file_url || '';
            const filename = data.filename || '';
            turnWlButtonToDownload(url, filename);
            if(!hasLetter){ setLetter('WL-—Ä–µ–∑—é–º–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ.'); }
          } else {
            const text =
              (typeof data.mail_text === 'string' && data.mail_text.trim())
                ? data.mail_text
                : (data.message ? String(data.message) : '–ì–æ—Ç–æ–≤–æ. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–ª—É—á–µ–Ω.');
            setLetter(text);

            if(btn.dataset.type === 'client'){
              showWlCreate();
            } else if (btn.dataset.type === 'utochnenie'){
              clarifyActions.style.display = 'flex';
              hideWl();
            } else if (btn.dataset.type === 'finalist' || btn.dataset.type === 'otkaz'){
              hideWl();
            }
          }
        }catch(err){
          mailLoading.style.display = 'none';
          showButtons();
          mailText.innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ' + err.message;
          toolbar.style.display = 'none';
          mailResult.style.display = 'block';
        }
      }

      if(mailButtons){
        mailButtons.addEventListener('click', function(e){
          const target = e.target.closest('.mail-btn');
          if(!target) return;
          const type = target.dataset.type || '';
          if (type === 'download') { return; } // –ü–æ–∑–≤–æ–ª—è–µ–º –æ–±—ã—á–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
          e.preventDefault();
          handleClick(target);
        });
      }

      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
      copyBtn.addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText(currentPlainText);
          copyBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
          setTimeout(()=>{copyBtn.textContent='üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';},1200);
        }catch(e){
          const ta = document.createElement('textarea');
          ta.value = currentPlainText;
          document.body.appendChild(ta);
          ta.select();
          try{ document.execCommand('copy'); }catch{}
          document.body.removeChild(ta);
          copyBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
          setTimeout(()=>{copyBtn.textContent='üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';},1200);
        }
      });

      // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∏—Å—å–º–∞
      function enterEditMode(){
        mailEditor.value = currentPlainText || '';
        mailText.style.display = 'none';
        mailEditor.style.display = 'block';
        editBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        editBtn.dataset.state = 'edit';
      }
      function saveFromEditor(){
        const newText = (mailEditor.value || '').replace(/\r\n/g,'\n');
        currentPlainText = newText;
        mailText.innerHTML = (newText || '').replace(/\n/g,'<br>');
        mailEditor.style.display = 'none';
        mailText.style.display = 'block';
        editBtn.textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        editBtn.dataset.state = 'view';
      }
      editBtn.addEventListener('click',()=>{
        (editBtn.dataset.state||'view')==='view' ? enterEditMode() : saveFromEditor();
      });

      /* === –£—Ç–æ—á–Ω–µ–Ω–∏—è ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ === */
      clarifyAddBtn.addEventListener('click', () => {
        clarifyForm.style.display = 'block';
      });

      clarifyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          vacancy_id: "{{ vacancy_id }}",
          candidate_fullname: "{{ candidate_fullname }}",
          tg_username: "{{ tg_username }}",
          clarifications: (clarifyText.value || '').trim()
        };
        if(!payload.clarifications){ return; }

        clarifySaveBtn.disabled = true;
        clarifySaveBtn.style.opacity = '0.7';
        mailResult.style.display = 'none';
        mailButtons.style.display = 'none';
        mailLoading.style.display = 'block';

        try{
          const resp = await fetch('/api/mail/utochnenie/save', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const ct = resp.headers.get('content-type') || '';
          const data = ct.includes('application/json') ? await resp.json() : JSON.parse(await resp.text());

          const wlLink = data?.wl_download_link;
          if (wlLink) {
            turnWlButtonToDownload(wlLink, data?.filename || '');
          } else {
            await (async function generateWLFallback(){
              const url = `/api/wl/create?vacancy_id=${encodeURIComponent(pageParams.vacancy_id)}&candidate_fullname=${encodeURIComponent(pageParams.candidate_fullname)}&tg_username=${encodeURIComponent(pageParams.tg_username||'')}`;
              const r = await fetch(url);
              const ctt = r.headers.get('content-type') || '';
              const d = ctt.includes('application/json') ? await r.json() : JSON.parse(await r.text());
              if (d.error) throw new Error(d.error);
              turnWlButtonToDownload(d.download_link || d.url || d.file_url || '', d.filename || '');
              if(!hasLetter){ setLetter('WL-—Ä–µ–∑—é–º–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ.'); }
            })();
          }

          const clientText = (typeof data?.client_mail_text==='string' && data.client_mail_text.trim())
            ? data.client_mail_text
            : await (async function generateClientLetterFallback(){
                const url = `/api/mail/client?vacancy_id=${encodeURIComponent(pageParams.vacancy_id)}&candidate_fullname=${encodeURIComponent(pageParams.candidate_fullname)}&tg_username=${encodeURIComponent(pageParams.tg_username||'')}`;
                const r = await fetch(url);
                const ctt = r.headers.get('content-type') || '';
                const d = ctt.includes('application/json') ? await r.json() : JSON.parse(await r.text());
                if (d.error) throw new Error(d.error);
                return (typeof d.mail_text==='string' && d.mail_text.trim())
                  ? d.mail_text : (d.message || '–ü–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É –≥–æ—Ç–æ–≤–æ.');
              })();

          setLetter(clientText);
          clarifyForm.style.display = 'none';
          clarifyActions.style.display = 'flex';

        }catch(err){
          mailText.innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–π: ' + (err.message || err);
          toolbar.style.display = 'none';
          mailResult.style.display = 'block';
          hideWl();
        }finally{
          mailLoading.style.display = 'none';
          showButtons();
          clarifySaveBtn.disabled = false;
          clarifySaveBtn.style.opacity = '1';
        }
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
      if (sendTgBtn) {
        sendTgBtn.addEventListener('click', async () => {
          if (!hasLetter || !currentPlainText.trim()) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞.');
            return;
          }
          try {
            const resp = await fetch('/api/send/telegram', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({
                vacancy_id: pageParams.vacancy_id,
                candidate_fullname: pageParams.candidate_fullname,
                contact: CONTACT_TG,
                message: currentPlainText
              })
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok) {
              alert(data.message || '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram.');
            } else {
              alert(data.detail || data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram.');
            }
          } catch (e) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram: ' + e);
          }
        });
      }

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ e-mail
      if (sendEmailBtn) {
        sendEmailBtn.addEventListener('click', async () => {
          if (!hasLetter || !currentPlainText.trim()) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞.');
            return;
          }
          try {
            const resp = await fetch('/api/send/email', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({
                vacancy_id: pageParams.vacancy_id,
                candidate_fullname: pageParams.candidate_fullname,
                contact: CONTACT_EMAIL,
                message: currentPlainText
              })
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok) {
              alert(data.message || '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ e-mail.');
            } else {
              alert(data.detail || data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ e-mail.');
            }
          } catch (e) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ e-mail: ' + e);
          }
        });
      }

      // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ WL —Å–∫—Ä—ã—Ç
      hideWl();
    });
  </script>
</body>
</html>
