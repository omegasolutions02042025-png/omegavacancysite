{% extends "layouts/base.html" %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–≤–µ—Ä–∫–∏ ‚Äî Omega Hire{% endblock %}

{% block head %}
<style>
  .sverka-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  .sverka-card {
    background: var(--color-bg-surface);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-radius: 16px;
    padding: 40px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1),
      0 0 30px rgba(255, 215, 0, 0.05);
    position: relative;
    overflow: hidden;
  }

  .sverka-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
      transparent 0%, 
      var(--color-accent-gold) 50%, 
      transparent 100%);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
  }

  .sverka-card h1 {
    color: var(--color-text-heading);
    text-shadow: 
      0 0 20px rgba(255, 215, 0, 0.3),
      0 2px 4px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 10;
  }

  .sverka-card h3 {
    color: var(--color-text-heading);
    text-shadow: 
      0 0 15px rgba(255, 215, 0, 0.2),
      0 2px 4px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 10;
  }

  .subtitle {
    color: var(--color-text-primary);
    opacity: 0.9;
    font-size: 1rem;
    margin-bottom: 24px;
  }

  /* Top back button */
  .back-top {
    position: fixed;
    left: 16px;
    top: calc(var(--header-height) + 16px);
    z-index: 1000;
    background: var(--color-bg-surface);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-left: 3px solid var(--color-accent-gold);
    border-radius: 12px;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--color-text-heading);
    font-weight: 600;
    cursor: pointer;
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.3),
      0 0 20px rgba(255, 215, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
  }

  .back-top:hover {
    transform: translateY(-2px);
    border-color: var(--color-accent-gold);
    box-shadow: 
      0 6px 25px rgba(0, 0, 0, 0.4),
      0 0 30px rgba(255, 215, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
    color: var(--color-accent-gold);
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
  }

  /* AI analysis box (–±–µ–∑ summary/details) */
  .ai-box {
    margin: 24px 0;
    background: var(--color-bg-surface-2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-left: 3px solid var(--color-accent-gold);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.05),
      0 0 20px rgba(255, 215, 0, 0.1);
  }

  .ai-analysis {
    color: var(--color-text-heading);
    line-height: 1.7;
  }

  .toggle-under {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: var(--color-bg-surface);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: var(--color-text-heading);
    font-weight: 600;
    cursor: pointer;
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
  }

  .toggle-under:hover {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.08) 100%);
    border-color: var(--color-accent-gold);
    color: var(--color-accent-gold);
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.2),
      0 0 20px rgba(255, 215, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  /* Mail buttons */
  .mail-buttons {
    display: flex;
    gap: 15px;
    margin-top: 15px;
    flex-wrap: wrap;
  }

  .mail-buttons a,
  .mail-buttons button {
    flex: 1;
    min-width: 220px;
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: #fff;
    text-align: center;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    box-shadow: 
      0 4px 15px rgba(0, 0, 0, 0.3),
      0 0 20px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
  }

  .mail-buttons a::before,
  .mail-buttons button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }

  .mail-buttons a:hover::before,
  .mail-buttons button:hover::before {
    width: 300px;
    height: 300px;
  }

  .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
  }

  .btn-success {
    background: linear-gradient(135deg, #2ECC71, #27AE60);
  }

  .btn-warning {
    background: linear-gradient(135deg, var(--color-accent-gold), #E6C200);
    color: #0A1929;
  }

  .btn-danger {
    background: linear-gradient(135deg, #E74C3C, #C0392B);
  }

  .btn-neutral {
    background: linear-gradient(135deg, var(--color-bg-surface-2), var(--color-bg-surface));
    color: var(--color-text-heading);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .mail-buttons a:hover,
  .mail-buttons button:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 6px 25px rgba(0, 0, 0, 0.4),
      0 0 40px rgba(0, 0, 0, 0.2);
  }

  .hidden {
    display: none !important;
  }

  /* Loader */
  #mail-loading {
    display: none;
    margin-top: 16px;
    min-height: 90px;
    text-align: center;
  }

  .loading-spinner {
    border: 4px solid var(--color-bg-surface-2);
    border-top: 4px solid var(--color-accent-gold);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 10px auto;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
  }

  @keyframes spin {
    0% { transform: rotate(0); }
    100% { transform: rotate(360deg); }
  }

  /* Mail result */
  #mail-result {
    display: none;
    margin-top: 20px;
    background: var(--color-bg-surface-2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #mail-result h4 {
    color: var(--color-text-heading);
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
    margin-bottom: 12px;
  }

  #mail-text {
    white-space: normal;
    line-height: 1.6;
    color: var(--color-text-heading);
  }

  .mail-toolbar {
    display: none;
    justify-content: flex-end;
    gap: 10px;
    margin-bottom: 10px;
  }

  .copy-btn {
    background: linear-gradient(135deg, #2ECC71, #27AE60);
    border: none;
    color: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 
      0 2px 8px rgba(46, 204, 113, 0.3),
      0 0 15px rgba(46, 204, 113, 0.2);
  }

  .copy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 4px 15px rgba(46, 204, 113, 0.5),
      0 0 25px rgba(46, 204, 113, 0.3);
  }

  .edit-btn {
    background: linear-gradient(135deg, var(--color-accent-gold), #E6C200);
    border: none;
    color: #0A1929;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 
      0 2px 8px rgba(255, 215, 0, 0.3),
      0 0 15px rgba(255, 215, 0, 0.2);
  }

  .edit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 4px 15px rgba(255, 215, 0, 0.5),
      0 0 25px rgba(255, 215, 0, 0.3);
  }

  .mail-editor {
    width: 100%;
    min-height: 260px;
    padding: 12px 14px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    background: var(--color-bg-surface);
    color: var(--color-text-heading);
    font: 400 15px/1.6 ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
    resize: vertical;
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
    margin-top: 10px;
    transition: all 0.3s ease;
  }

  .mail-editor:focus {
    outline: none;
    border-color: var(--color-accent-gold);
    box-shadow: 
      0 0 0 2px rgba(255, 215, 0, 0.2),
      0 0 20px rgba(255, 215, 0, 0.15),
      0 4px 12px rgba(0, 0, 0, 0.2);
  }

  /* –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ (Telegram / e-mail) –ø–æ–¥ –ø–∏—Å—å–º–æ–º */
  .send-actions {
    display: none;
    margin-top: 14px;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }

  .send-btn {
    border: none;
    border-radius: 8px;
    padding: 9px 14px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    color: #fff;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.3),
      0 0 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .send-btn-tg {
    background: linear-gradient(135deg, #0ea5e9, #0284c7);
  }

  .send-btn-mail {
    background: linear-gradient(135deg, #f97316, #ea580c);
  }

  .send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 4px 15px rgba(0, 0, 0, 0.4),
      0 0 25px rgba(0, 0, 0, 0.2);
  }

  /* Clarifications */
  .clarify-wrap {
    margin-top: 18px;
  }

  .clarify-actions {
    display: none;
    gap: 10px;
    margin: 12px 0;
  }

  .clarify-btn {
    background: linear-gradient(135deg, var(--color-accent-gold), #E6C200);
    border: none;
    color: #0A1929;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 
      0 2px 8px rgba(255, 215, 0, 0.3),
      0 0 15px rgba(255, 215, 0, 0.2);
    transition: all 0.3s ease;
  }

  .clarify-btn:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 4px 15px rgba(255, 215, 0, 0.5),
      0 0 25px rgba(255, 215, 0, 0.3);
  }

  .clarify-form {
    display: none;
    margin-top: 10px;
    background: var(--color-bg-surface-2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 12px;
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  .clarify-form textarea {
    width: 100%;
    min-height: 160px;
    padding: 10px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    background: var(--color-bg-surface);
    color: var(--color-text-heading);
    font: 400 14px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
    transition: all 0.3s ease;
  }

  .clarify-form textarea:focus {
    outline: none;
    border-color: var(--color-accent-gold);
    box-shadow: 
      0 0 0 2px rgba(255, 215, 0, 0.2),
      0 0 20px rgba(255, 215, 0, 0.15);
  }

  .clarify-save {
    margin-top: 10px;
    background: linear-gradient(135deg, #2ECC71, #27AE60);
    border: none;
    color: #fff;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    box-shadow: 
      0 2px 8px rgba(46, 204, 113, 0.3),
      0 0 15px rgba(46, 204, 113, 0.2);
    transition: all 0.3s ease;
  }

  .clarify-save:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 4px 15px rgba(46, 204, 113, 0.5),
      0 0 25px rgba(46, 204, 113, 0.3);
  }

  .clarify-hint {
    color: var(--color-text-primary);
    opacity: 0.8;
    font-size: 13px;
    margin-top: 6px;
  }

  /* Contacts */
  .contacts-block {
    margin-top: 40px;
    background: var(--color-bg-surface-2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-left: 3px solid var(--color-accent-gold);
    border-radius: 12px;
    padding: 24px 28px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.05),
      0 0 20px rgba(255, 215, 0, 0.1);
  }

  .contacts-block h3 {
    margin-top: 0;
    color: var(--color-text-heading);
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
  }

  .contacts-block p {
    margin: 6px 0;
    font-size: 15px;
    line-height: 1.6;
    color: var(--color-text-heading);
  }

  .result-section {
    margin-top: 32px;
  }

  .result-header {
    margin-bottom: 16px;
  }

  /* --- –Ω–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è WL --- */
  @keyframes pulseWL {
    0% {
      box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.55);
    }
    70% {
      box-shadow: 0 0 0 12px rgba(255, 215, 0, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
    }
  }

  .pulse-wl {
    animation: pulseWL 1.2s ease-out 3;
  }
</style>
{% endblock %}

{% block content %}
  {# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏ –±–ª–æ–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ #}
  {% set c = contacts or {} %}
  {% set _tg_raw = (c.get('telegram') or '').strip() %}
  {% if not _tg_raw and tg_username %}{% set _tg_raw = tg_username.strip() %}{% endif %}
  {% if _tg_raw and ('–ù–µ—Ç' not in _tg_raw) %}
    {% set _tg_noat = _tg_raw[1:] if _tg_raw[0] == '@' else _tg_raw %}
    {% set _has_tg = True %}
  {% else %}
    {% set _tg_noat = '' %}
    {% set _has_tg = False %}
  {% endif %}

  {% set _email = (c.get('email') or '').strip() %}
  {% if _email and ('–ù–µ—Ç' not in _email) %}
    {% set _has_email = True %}
  {% else %}
    {% set _has_email = False %}
  {% endif %}

  {% set _phone = (c.get('phone') or '').strip() %}
  {% if _phone and ('–ù–µ—Ç' not in _phone) %}
    {% set _has_phone = True %}
  {% else %}
    {% set _has_phone = False %}
  {% endif %}

  {% set _li = (c.get('linkedin') or '').strip() %}
  {% if _li and ('–ù–µ—Ç' not in _li) %}
    {% set _has_li = True %}
  {% else %}
    {% set _has_li = False %}
  {% endif %}

  {% if is_admin_view %}
  <a href="/admin/user/{{ user_id }}/sverka-history/detail?vacancy_id={{ vacancy_id }}" class="back-top" style="text-decoration: none;">
    <span>‚¨Ö</span><span>–ù–∞–∑–∞–¥ –∫ –∏—Å—Ç–æ—Ä–∏–∏</span>
  </a>
  {% else %}
  <button type="button" class="back-top" onclick="history.back()">
    <span>‚¨Ö</span><span>–ù–∞–∑–∞–¥</span>
  </button>
  {% endif %}

  <div class="sverka-container">
    <div class="sverka-card">
      <h1>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–≤–µ—Ä–∫–∏</h1>
      <p class="subtitle">–ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–µ–∑—é–º–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –≤–∞–∫–∞–Ω—Å–∏–∏ –æ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</p>

      <!-- –ê–Ω–∞–ª–∏–∑ –ò–ò (–±–µ–∑ summary/details) -->
      <div id="ai-box" class="ai-box">
        <div class="ai-analysis">{{ ai_text|safe }}</div>
      </div>
      <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥ —Å–≤–µ—Ä–∫–æ–π -->
      <button type="button" id="toggle-sverka" class="toggle-under">‚¨Ü –°–∫—Ä—ã—Ç—å —Å–≤–µ—Ä–∫—É</button>

      <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å–µ–º -->
      <div class="result-section">
        <div class="result-header"><h3>‚úâÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å–µ–º</h3></div>

        <div class="mail-buttons" id="mail-buttons">
          <a href="/api/mail/client?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-primary mail-btn" data-type="client">üìù –ü–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É</a>
          <a href="/api/mail/finalist?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-success mail-btn" data-type="finalist">‚úÖ –ü–∏—Å—å–º–æ —Ñ–∏–Ω–∞–ª–∏—Å—Ç—É</a>
          <a href="/api/mail/utochnenie?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-warning mail-btn" data-type="utochnenie">‚ùì –£—Ç–æ—á–Ω—è—é—â–µ–µ –ø–∏—Å—å–º–æ</a>
          <a href="/api/mail/otkaz?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-danger mail-btn" data-type="otkaz">‚ùå –ü–∏—Å—å–º–æ –æ–± –æ—Ç–∫–∞–∑–µ</a>
          <a href="/api/wl/create?vacancy_id={{ vacancy_id }}&candidate_fullname={{ candidate_fullname }}&tg_username={{tg_username}}" class="btn-neutral mail-btn hidden" id="btn-wl" data-type="wl">üìÑ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å WL-—Ä–µ–∑—é–º–µ</a>
        </div>

        <!-- –õ–æ–∞–¥–µ—Ä -->
        <div id="mail-loading">
          <div class="loading-spinner"></div>
          <p style="color:#475569">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è‚Ä¶ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∏—Å–µ–º -->
        <div id="mail-result">
          <div class="mail-toolbar" id="mail-toolbar">
            <button type="button" class="copy-btn" id="copy-btn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button type="button" class="edit-btn" id="edit-btn" data-state="view">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>

          <textarea id="mail-editor" class="mail-editor" style="display:none;"></textarea>

          <h4>üìß –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</h4>
          <div id="mail-text" aria-live="polite"></div>

          <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞ -->
          <div class="send-actions" id="send-actions">
            {% if _has_tg %}
              <button type="button" class="send-btn send-btn-tg" id="send-tg-btn">
                üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
              </button>
            {% endif %}
            {% if _has_email %}
              <button type="button" class="send-btn send-btn-mail" id="send-email-btn">
                üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ e-mail
              </button>
            {% endif %}
          </div>

          <!-- –ë–ª–æ–∫ —É—Ç–æ—á–Ω–µ–Ω–∏–π -->
          <div class="clarify-wrap">
            <div class="clarify-actions" id="clarify-actions">
              <button type="button" class="clarify-btn" id="clarify-add">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è</button>
            </div>

            <form class="clarify-form" id="clarify-form">
              <label for="clarify-text"><strong>–¢–µ–∫—Å—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–π –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ / –≤–æ–ø—Ä–æ—Å—ã:</strong></label>
              <textarea id="clarify-text" name="clarify_text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–æ—Ç–æ–≤ –Ω–∞ full-time —Å 25 –Ω–æ—è–±—Ä—è; —Å—Ç–∞–≤–∫–∞ –æ—Ç 1800; –†–§, –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä; –æ–ø—ã—Ç —Å GraphQL/Apollo ‚Äî –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π, 1,5 –≥–æ–¥–∞; Micro-frontends ‚Äî Module Federation, –≤–Ω–µ–¥—Ä—è–ª shell-app –∏ –æ–±—â–∏–π UI-–∫–∏—Ç."></textarea>
              <div class="clarify-hint">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ç–∫–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç WL-—Ä–µ–∑—é–º–µ –∏ –ø–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É.</div>
              <button type="submit" class="clarify-save" id="clarify-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å WL –∏ –ø–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É)</button>
            </form>
          </div>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
      <div class="contacts-block">
        <h3>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏</h3>

        {% if _has_tg %}
          <p><strong>Telegram:</strong> <a href="https://t.me/{{ _tg_noat }}" target="_blank">@{{ _tg_noat }}</a></p>
        {% endif %}

        {% if _has_email %}
          <p><strong>E-mail:</strong> <a href="mailto:{{ _email }}">{{ _email }}</a></p>
        {% endif %}

        {% if _has_phone %}
          {% set _tel = _phone.replace(' ', '').replace('(', '').replace(')', '').replace('-', '') %}
          <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <a href="tel:{{ _tel }}">{{ _phone }}</a></p>
        {% endif %}

        {% if _has_li %}
          {% set _li_href = _li if 'http' in _li else 'https://www.linkedin.com/in/' + _li %}
          <p><strong>LinkedIn:</strong> <a href="{{ _li_href }}" target="_blank">{{ _li }}</a></p>
        {% endif %}

        {% if not _has_tg and not _has_email and not _has_phone and not _has_li %}
          <p style="color:#64748b">–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏–ª–∏ —Ç—Ä–µ–±—É—é—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è.</p>
        {% endif %}
      </div>

      <div class="navigation" style="margin-top:15px;">
        {% if is_admin_view %}
        <a href="/admin/user/{{ user_id }}/sverka-history/detail?vacancy_id={{ vacancy_id }}">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º</a>
        <a href="/admin/user/{{ user_id }}/sverka-history">üìä –ò—Å—Ç–æ—Ä–∏—è —Å–≤–µ—Ä–æ–∫</a>
        <a href="/admin/dashboard">üè† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
        {% else %}
        <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/vacancy"> üì§ –û—Ç–∫—Ä—ã—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏</a>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const mailButtons  = document.getElementById('mail-buttons');
      const wlButton     = document.getElementById('btn-wl');
      const mailLoading  = document.getElementById('mail-loading');
      const mailResult   = document.getElementById('mail-result');
      const mailText     = document.getElementById('mail-text');
      const toolbar      = document.getElementById('mail-toolbar');
      const copyBtn      = document.getElementById('copy-btn');
      const editBtn      = document.getElementById('edit-btn');
      const mailEditor   = document.getElementById('mail-editor');

      const aiBox        = document.getElementById('ai-box');
      const toggleSverkaBtn = document.getElementById('toggle-sverka');

      // –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
      const sendActions   = document.getElementById('send-actions');
      const sendTgBtn     = document.getElementById('send-tg-btn');
      const sendEmailBtn  = document.getElementById('send-email-btn');

      // –£—Ç–æ—á–Ω–µ–Ω–∏—è
      const clarifyActions = document.getElementById('clarify-actions');
      const clarifyAddBtn  = document.getElementById('clarify-add');
      const clarifyForm    = document.getElementById('clarify-form');
      const clarifyText    = document.getElementById('clarify-text');
      const clarifySaveBtn = document.getElementById('clarify-save');

      let currentPlainText = '';
      let hasLetter = false;

      const pageParams = {
        vacancy_id: "{{ vacancy_id }}",
        candidate_fullname: "{{ candidate_fullname }}",
        tg_username: "{{ tg_username }}"
      };

      // –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞)
      const CONTACT_TG    = "{{ _tg_noat if _has_tg else '' }}";
      const CONTACT_EMAIL = "{{ _email  if _has_email else '' }}";


      function setLetter(plainText){
        const html = (plainText || '').replace(/\n/g,'<br>');
        mailText.innerHTML = html;
        currentPlainText   = plainText || '';
        toolbar.style.display = 'flex';
        mailResult.style.display = 'block';
        mailResult.scrollIntoView({behavior:'smooth',block:'nearest'});
        hasLetter = true;
        if (sendActions && (sendTgBtn || sendEmailBtn)) {
          sendActions.style.display = 'flex';
        }
      }
      function showButtons(){ mailButtons.style.display = 'flex'; }
      function normalizeUrl(u){ return String(u || '').replace(/\\/g,'/'); }

      /* === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WL-–∫–Ω–æ–ø–∫–æ–π === */
      function hideWl(){
        wlButton.classList.add('hidden');
        wlButton.classList.remove('btn-primary');
        wlButton.classList.add('btn-neutral');
        wlButton.dataset.type = 'wl';
        wlButton.removeAttribute('download');
        wlButton.textContent = 'üìÑ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å WL-—Ä–µ–∑—é–º–µ';
        wlButton.href = `/api/wl/create?vacancy_id=${encodeURIComponent(pageParams.vacancy_id)}&candidate_fullname=${encodeURIComponent(pageParams.candidate_fullname)}&tg_username=${encodeURIComponent(pageParams.tg_username||'')}`;
      }
      function showWlCreate(){
        wlButton.classList.remove('hidden');
        wlButton.classList.remove('btn-primary');
        wlButton.classList.add('btn-neutral');
        wlButton.dataset.type = 'wl';
        wlButton.removeAttribute('download');
        wlButton.textContent = 'üìÑ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å WL-—Ä–µ–∑—é–º–µ';
        wlButton.href = `/api/wl/create?vacancy_id=${encodeURIComponent(pageParams.vacancy_id)}&candidate_fullname=${encodeURIComponent(pageParams.candidate_fullname)}&tg_username=${encodeURIComponent(pageParams.tg_username||'')}`;
        try{ wlButton.scrollIntoView({behavior:'smooth',block:'center'});}catch(_){}
      }
      function turnWlButtonToDownload(url, filename){
        url = normalizeUrl(url);
        if(!url) return;
        wlButton.classList.remove('hidden');
        wlButton.href = url;
        wlButton.textContent = '‚¨á –°–∫–∞—á–∞—Ç—å WL-—Ä–µ–∑—é–º–µ';
        wlButton.classList.remove('btn-neutral');
        wlButton.classList.add('btn-primary');
        wlButton.dataset.type = 'download';
        if (filename) wlButton.setAttribute('download', filename);
        else wlButton.removeAttribute('download');
        requestAnimationFrame(() => {
          wlButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
          try { wlButton.focus({ preventScroll: true }); } catch(_) {}
          wlButton.classList.add('pulse-wl');
          setTimeout(() => wlButton.classList.remove('pulse-wl'), 2500);
        });
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–≤–µ—Ä–∫–∏
      toggleSverkaBtn.addEventListener('click', () => {
        const hidden = aiBox.style.display === 'none';
        aiBox.style.display = hidden ? 'block' : 'none';
        toggleSverkaBtn.textContent = hidden ? '‚¨Ü –°–∫—Ä—ã—Ç—å —Å–≤–µ—Ä–∫—É' : '‚¨á –†–∞—Å–∫—Ä—ã—Ç—å —Å–≤–µ—Ä–∫—É';
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
      async function handleClick(btn){
        // –°–±—Ä–æ—Å UI –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
        clarifyActions.style.display = 'none';     // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—å –±–ª–æ–∫ —É—Ç–æ—á–Ω–µ–Ω–∏–π
        if (btn.dataset.type === 'client') {
          hideWl();
        } else if (btn.dataset.type === 'utochnenie') {
          hideWl();
        } else if (btn.dataset.type === 'finalist' || btn.dataset.type === 'otkaz') {
          hideWl();
        }

        if(btn.dataset.type !== 'wl'){ mailResult.style.display = 'none'; }
        mailButtons.style.display = 'none';
        mailLoading.style.display = 'block';

        // –î–ª—è WL-—Ä–µ–∑—é–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        if(btn.dataset.type === 'wl'){
          try{
            const resp = await fetch(btn.href);
            const data = await (async function parseJsonSafe(r){
              const ct = r.headers.get('content-type') || '';
              if (ct.includes('application/json')) return await r.json();
              const t = await r.text();
              throw new Error(t.slice(0,500));
            })(resp);

            mailLoading.style.display = 'none';
            showButtons();

            if(data.error){
              mailText.innerText = '–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
              toolbar.style.display = 'none';
              mailResult.style.display = 'block';
              return;
            }

            const url = data.download_link || data.url || data.file_url || '';
            const filename = data.filename || '';
            turnWlButtonToDownload(url, filename);
            if(!hasLetter){ setLetter('WL-—Ä–µ–∑—é–º–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ.'); }
          }catch(err){
            mailLoading.style.display = 'none';
            showButtons();
            mailText.innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ' + err.message;
            toolbar.style.display = 'none';
            mailResult.style.display = 'block';
          }
          return;
        }

        // –î–ª—è –ø–∏—Å–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–∏–º–∏–Ω–≥ —á–µ—Ä–µ–∑ fetch —Å ReadableStream
        try {
          // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
          // –ü—Ä–∏–º–µ—Ä: /api/mail/client?... -> /api/mail/client/stream?...
          const originalUrl = new URL(btn.href, window.location.origin);
          const streamUrl = originalUrl.pathname + '/stream' + originalUrl.search;
          
          // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
          // mailLoading.style.display = 'none'; // –£–ë–†–ê–õ–ò: –°–∫—Ä–æ–µ–º –ª–æ–∞–¥–µ—Ä —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø—Ä–∏–¥–µ—Ç –ø–µ—Ä–≤—ã–π —á–∞–Ω–∫
          mailLoading.style.display = 'block';
          
          mailResult.style.display = 'block';
          // toolbar.style.display = 'flex'; // –ü–æ–∫–∞–∂–µ–º —Ç—É–ª–±–∞—Ä —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏–º –∏–ª–∏ –Ω–∞—á–Ω–µ–º (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
          toolbar.style.display = 'none'; // –õ—É—á—à–µ —Å–∫—Ä—ã—Ç—å —Ç—É–ª–±–∞—Ä –ø–æ–∫–∞ –ø–∏—à–µ—Ç—Å—è
          
          mailText.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
          currentPlainText = '';
          
          let accumulatedText = '';
          
          // –û–ß–ï–†–ï–î–¨ –î–õ–Ø –≠–§–§–ï–ö–¢–ê –ü–ï–ß–ê–¢–ù–û–ô –ú–ê–®–ò–ù–ö–ò
          let textBuffer = '';         // –í–µ—Å—å —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –ø—Ä–∏—à–µ–ª, –Ω–æ –µ—â–µ –Ω–µ –≤–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω
          let displayedTextLength = 0; // –°–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –º—ã —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ –≤ DOM
          let isTyping = false;
          let typeInterval = null;
          
          // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ "–ø–µ—á–∞—Ç–∞–ª–∫–∏"
          function startTypingEffect() {
            if (isTyping) return;
            isTyping = true;
            
            // –°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ (–º—Å –Ω–∞ —Å–∏–º–≤–æ–ª). –ß–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º –º–µ–¥–ª–µ–Ω–Ω–µ–µ.
            // –°—Ç–∞–≤–∏–º 20–º—Å (—á—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ), —á—Ç–æ–±—ã –±—ã–ª–æ —á–∏—Ç–∞–µ–º–æ.
            const TYPE_SPEED_MS = 20; 
            
            typeInterval = setInterval(() => {
               // –ï—Å–ª–∏ –æ—Ç–æ–±—Ä–∞–∑–∏–ª–∏ –≤—Å—ë, —á—Ç–æ –µ—Å—Ç—å –≤ –±—É—Ñ–µ—Ä–µ
               if (displayedTextLength >= accumulatedText.length) {
                 // –ï—Å–ª–∏ —Å—Ç—Ä–∏–º –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∏ –±—É—Ñ–µ—Ä –ø—É—Å—Ç (–∏–ª–∏ —Ä–∞–≤–µ–Ω) ‚Äî –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è
                 // –ù–æ –º—ã —É–∑–Ω–∞–µ–º –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Å—Ç—Ä–∏–º–∞ –∏–∑ —Ñ–ª–∞–≥–∞ done
                 return; 
               }
               
               // –ë–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫—É—Å–æ—á–µ–∫.
               // –ï—Å–ª–∏ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å –º–Ω–æ–≥–æ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è ‚Äî –ø–ª–∞–≤–Ω–æ —É—Å–∫–æ—Ä—è–µ–º—Å—è, –Ω–æ —Å—Ç–∞—Ä–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–∏—Ç–∞–µ–º–æ—Å—Ç—å.
               let charsToAdd = 1;
               const lag = accumulatedText.length - displayedTextLength;
               
               // –ï—Å–ª–∏ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ –±–æ–ª—å—à–µ 150 —Å–∏–º–≤–æ–ª–æ–≤ (~5 —Å—Ç—Ä–æ–∫), —á—É—Ç—å —É—Å–∫–æ—Ä—è–µ–º—Å—è (2 —Å–∏–º–≤–æ–ª–∞ –∑–∞ —Ç–∞–∫—Ç)
               if (lag > 150) charsToAdd = 2;
               // –ï—Å–ª–∏ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–µ (>500 —Å–∏–º–≤–æ–ª–æ–≤), —É—Å–∫–æ—Ä—è–µ–º—Å—è —Å–∏–ª—å–Ω–µ–µ (5 —Å–∏–º–≤–æ–ª–æ–≤ –∑–∞ —Ç–∞–∫—Ç)
               if (lag > 500) charsToAdd = 5;

               const nextChunk = accumulatedText.substr(displayedTextLength, charsToAdd);
               displayedTextLength += nextChunk.length;
               
               // –û–±–Ω–æ–≤–ª—è–µ–º DOM (–∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å HTML-—Ç–µ–≥–∞–º–∏, –Ω–æ —É –Ω–∞—Å plain text, –∫–æ—Ç–æ—Ä—ã–π –º—ã –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º –Ω–∞ <br>)
               // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –±–µ—Ä–µ–º accumulatedText —Ü–µ–ª–∏–∫–æ–º –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
               const visibleSubstr = accumulatedText.substr(0, displayedTextLength);
               mailText.innerHTML = visibleSubstr.replace(/\n/g, '<br>');
               mailText.scrollTop = mailText.scrollHeight;
               
            }, TYPE_SPEED_MS);
          }

          // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π cookies
          console.log('Starting stream from:', streamUrl);
          const response = await fetch(streamUrl, {
            method: 'GET',
            headers: {
              'Accept': 'text/event-stream',
            },
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let buffer = '';
          let firstChunkReceived = false;

          while (true) {
            const { done, value } = await reader.read();
            
            if (done) {
              console.log('Stream complete');
              
              // –ñ–¥–µ–º, –ø–æ–∫–∞ "–ø–µ—á–∞—Ç–∞–ª–∫–∞" –¥–æ–ø–µ—á–∞—Ç–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫
              const waitFinish = setInterval(() => {
                  if (displayedTextLength >= accumulatedText.length) {
                      clearInterval(waitFinish);
                      clearInterval(typeInterval);
                      isTyping = false;
                      
                      // –§–∏–Ω–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                      currentPlainText = accumulatedText;
                      mailText.innerHTML = accumulatedText.replace(/\n/g, '<br>');
                      if (sendActions) sendActions.style.display = 'flex';
                      toolbar.style.display = 'flex';
                      showButtons();
                      hasLetter = true;
                      
                      // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞
                      if(btn.dataset.type === 'client') showWlCreate();
                      else if (btn.dataset.type === 'utochnenie') { clarifyActions.style.display = 'flex'; hideWl(); }
                      else hideWl();
                  }
              }, 100);
              
              break;
            }

            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º —á–∞–Ω–∫
            const chunkStr = decoder.decode(value, { stream: true });
            buffer += chunkStr;
            
            let lines = buffer.split(/\r?\n/);
            buffer = lines.pop();

            for (const line of lines) {
              if (line.trim().startsWith('data:')) {
                const jsonStr = line.replace('data:', '').trim();
                if (!jsonStr) continue;

                try {
                  const data = JSON.parse(jsonStr);
                  
                  if (data.error) {
                    console.error('Backend error:', data.error);
                    mailText.innerText = '–û—à–∏–±–∫–∞: ' + data.error;
                    clearInterval(typeInterval);
                    mailLoading.style.display = 'none';
                    toolbar.style.display = 'none'; 
                    showButtons(); 
                    throw new Error(data.error);
                  }

                  if (data.type === 'chunk' && data.chunk) {
                     // –ü–ï–†–í–´–ô –ß–ê–ù–ö –ü–†–ò–®–ï–õ
                     if (!firstChunkReceived) {
                         firstChunkReceived = true;
                         mailLoading.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫—Ä—É—Ç–∏–ª–∫—É
                         startTypingEffect();                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—á–∞—Ç—å
                     }
                     
                     accumulatedText += data.chunk;
                     // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º DOM –Ω–∞–ø—Ä—è–º—É—é –∑–¥–µ—Å—å, —ç—Ç–æ –¥–µ–ª–∞–µ—Ç setInterval
                  } 
                  else if (data.type === 'done') {
                     console.log('Done received');
                     if (data.full_text) accumulatedText = data.full_text;
                     // –¶–∏–∫–ª done –≤ while –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                  }
                } catch (e) {
                  console.warn('JSON parse error for line:', line, e);
                }
              }
            }
          }
        } catch(err){
          console.error('–û—à–∏–±–∫–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞:', err);
          mailLoading.style.display = 'none';
          
          // Fallback: –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø–∏—Å—å–º–æ –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
          try {
            const resp = await fetch(btn.href);
            const data = await resp.json();
            
            if(data.error){
              mailText.innerText = '–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
              toolbar.style.display = 'none';
            } else {
              const text = (typeof data.mail_text === 'string' && data.mail_text.trim())
                ? data.mail_text
                : (data.message ? String(data.message) : '–ì–æ—Ç–æ–≤–æ. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–ª—É—á–µ–Ω.');
              setLetter(text);
              
              if(btn.dataset.type === 'client'){
                showWlCreate();
              } else if (btn.dataset.type === 'utochnenie'){
                clarifyActions.style.display = 'flex';
                hideWl();
              } else if (btn.dataset.type === 'finalist' || btn.dataset.type === 'otkaz'){
                hideWl();
              }
            }
          } catch(fallbackErr) {
            mailText.innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ' + (err.message || fallbackErr.message);
            toolbar.style.display = 'none';
          }
          
          showButtons();
          mailResult.style.display = 'block';
        }
      }

      if(mailButtons){
        mailButtons.addEventListener('click', function(e){
          const target = e.target.closest('.mail-btn');
          if(!target) return;
          const type = target.dataset.type || '';
          if (type === 'download') { return; } // –ü–æ–∑–≤–æ–ª—è–µ–º –æ–±—ã—á–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
          e.preventDefault();
          handleClick(target);
        });
      }

      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
      copyBtn.addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText(currentPlainText);
          copyBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
          setTimeout(()=>{copyBtn.textContent='üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';},1200);
        }catch(e){
          const ta = document.createElement('textarea');
          ta.value = currentPlainText;
          document.body.appendChild(ta);
          ta.select();
          try{ document.execCommand('copy'); }catch{}
          document.body.removeChild(ta);
          copyBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
          setTimeout(()=>{copyBtn.textContent='üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';},1200);
        }
      });

      // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∏—Å—å–º–∞
      function enterEditMode(){
        mailEditor.value = currentPlainText || '';
        mailText.style.display = 'none';
        mailEditor.style.display = 'block';
        editBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        editBtn.dataset.state = 'edit';
      }
      function saveFromEditor(){
        const newText = (mailEditor.value || '').replace(/\r\n/g,'\n');
        currentPlainText = newText;
        mailText.innerHTML = (newText || '').replace(/\n/g,'<br>');
        mailEditor.style.display = 'none';
        mailText.style.display = 'block';
        editBtn.textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        editBtn.dataset.state = 'view';
      }
      editBtn.addEventListener('click',()=>{
        (editBtn.dataset.state||'view')==='view' ? enterEditMode() : saveFromEditor();
      });

      /* === –£—Ç–æ—á–Ω–µ–Ω–∏—è ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ === */
      clarifyAddBtn.addEventListener('click', () => {
        clarifyForm.style.display = 'block';
      });

      clarifyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          vacancy_id: "{{ vacancy_id }}",
          candidate_fullname: "{{ candidate_fullname }}",
          tg_username: "{{ tg_username }}",
          clarifications: (clarifyText.value || '').trim()
        };
        if(!payload.clarifications){ return; }

        clarifySaveBtn.disabled = true;
        clarifySaveBtn.style.opacity = '0.7';
        mailResult.style.display = 'none';
        mailButtons.style.display = 'none';
        mailLoading.style.display = 'block';

        try{
          const resp = await fetch('/api/mail/utochnenie/save', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const ct = resp.headers.get('content-type') || '';
          const data = ct.includes('application/json') ? await resp.json() : JSON.parse(await resp.text());

          const wlLink = data?.wl_download_link;
          if (wlLink) {
            turnWlButtonToDownload(wlLink, data?.filename || '');
          } else {
            await (async function generateWLFallback(){
              const url = `/api/wl/create?vacancy_id=${encodeURIComponent(pageParams.vacancy_id)}&candidate_fullname=${encodeURIComponent(pageParams.candidate_fullname)}&tg_username=${encodeURIComponent(pageParams.tg_username||'')}`;
              const r = await fetch(url);
              const ctt = r.headers.get('content-type') || '';
              const d = ctt.includes('application/json') ? await r.json() : JSON.parse(await r.text());
              if (d.error) throw new Error(d.error);
              turnWlButtonToDownload(d.download_link || d.url || d.file_url || '', d.filename || '');
              if(!hasLetter){ setLetter('WL-—Ä–µ–∑—é–º–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ.'); }
            })();
          }

          const clientText = (typeof data?.client_mail_text==='string' && data.client_mail_text.trim())
            ? data.client_mail_text
            : await (async function generateClientLetterFallback(){
                const url = `/api/mail/client?vacancy_id=${encodeURIComponent(pageParams.vacancy_id)}&candidate_fullname=${encodeURIComponent(pageParams.candidate_fullname)}&tg_username=${encodeURIComponent(pageParams.tg_username||'')}`;
                const r = await fetch(url);
                const ctt = r.headers.get('content-type') || '';
                const d = ctt.includes('application/json') ? await r.json() : JSON.parse(await r.text());
                if (d.error) throw new Error(d.error);
                return (typeof d.mail_text==='string' && d.mail_text.trim())
                  ? d.mail_text : (d.message || '–ü–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É –≥–æ—Ç–æ–≤–æ.');
              })();

          setLetter(clientText);
          clarifyForm.style.display = 'none';
          clarifyActions.style.display = 'flex';

        }catch(err){
          mailText.innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–π: ' + (err.message || err);
          toolbar.style.display = 'none';
          mailResult.style.display = 'block';
          hideWl();
        }finally{
          mailLoading.style.display = 'none';
          showButtons();
          clarifySaveBtn.disabled = false;
          clarifySaveBtn.style.opacity = '1';
        }
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
      if (sendTgBtn) {
        sendTgBtn.addEventListener('click', async () => {
          if (!hasLetter || !currentPlainText.trim()) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞.');
            return;
          }
          try {
            const resp = await fetch('/api/send/telegram', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({
                vacancy_id: pageParams.vacancy_id,
                candidate_fullname: pageParams.candidate_fullname,
                contact: CONTACT_TG,
                message: currentPlainText
              })
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok) {
              alert(data.message || '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram.');
            } else {
              alert(data.detail || data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram.');
            }
          } catch (e) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram: ' + e);
          }
        });
      }

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ e-mail
      if (sendEmailBtn) {
        sendEmailBtn.addEventListener('click', async () => {
          if (!hasLetter || !currentPlainText.trim()) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞.');
            return;
          }
          try {
            const resp = await fetch('/api/send/email', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({
                vacancy_id: pageParams.vacancy_id,
                candidate_fullname: pageParams.candidate_fullname,
                contact: CONTACT_EMAIL,
                message: currentPlainText
              })
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok) {
              alert(data.message || '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ e-mail.');
            } else {
              alert(data.detail || data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ e-mail.');
            }
          } catch (e) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ e-mail: ' + e);
          }
        });
      }

      // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ WL —Å–∫—Ä—ã—Ç
      hideWl();
    });
  </script>
{% endblock %}
