<!-- --- HTML: страница статуса (polling /api/status/{job_id}) --- -->
<html lang="ru"><head>
  <meta charset="utf-8">
  <title>Статус обработки</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,Arial;margin:24px;background:#0b1020;color:#e8eefc}
    .card{max-width:900px;margin:auto;background:#121a35;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .muted{color:#a8b3d6}
    .result{margin-top:16px;border-top:1px solid rgba(255,255,255,.08);padding-top:12px}
    pre{white-space:pre-wrap;background:#0c1226;padding:12px;border-radius:10px;overflow:auto}
  </style>
</head><body>
  <div class="card">
    <h1>Статус обработки файла</h1>
    <p id="status" class="muted">Идёт обработка…</p>
    <div id="result" class="result"></div>
    <p class="muted"><small>Job ID: {job_id}</small></p>
  </div>

  <script>
    const jobId = "{job_id}";
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');

    async function poll(){
      try{
        const r = await fetch(`/api/status/${jobId}`, {cache:'no-store'});
        if(!r.ok){ statusEl.textContent = 'Ошибка сервера'; return; }
        const data = await r.json();
        statusEl.textContent = 'Статус: ' + data.status + (data.progress != null ? ` (${data.progress}%)` : '');
        if(data.status === 'done'){
          resultEl.innerHTML = data.result_html || '<p>Результат пуст.</p>';
          return; // стоп
        }
        if(data.status === 'error'){
          resultEl.innerHTML = `<pre>${(data.error || 'Неизвестная ошибка')}</pre>`;
          return; // стоп
        }
      }catch(e){
        statusEl.textContent = 'Ошибка запроса: ' + e.message;
      }
      setTimeout(poll, 900); // повторный опрос
    }
    poll();
  </script>
</body></html>
