<header class="topbar">
  <style>
    .topbar {
      background:#020617;
      color:#e5e7eb;
      padding:10px 24px;
      box-shadow:0 6px 18px rgba(15,23,42,.45);
      position:sticky;
      top:0;
      z-index:50;
    }
    .topbar-inner{
      max-width:1240px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }

    .topbar-left{
      display:flex;
      align-items:center;
      gap:18px;
    }

    .topbar-brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      letter-spacing:.08em;
      font-size:.95rem;
      text-transform:uppercase;
      color:#fbbf24;
      text-decoration:none;
    }
    .topbar-brand img{
      height:26px;
      width:26px;
      border-radius:999px;
      object-fit:contain;
      background:transparent;
    }

    .topbar-section-upload{
      padding:7px 18px;
      border-radius:10px;
      background:linear-gradient(135deg,#facc15,#f97316);
      color:#111827;
      font-size:.9rem;
      font-weight:700;
      text-decoration:none;
      box-shadow:0 8px 18px rgba(248,181,0,.45);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
    }
    .topbar-section-upload:hover{
      filter:brightness(1.06);
      transform:translateY(-1px);
    }
    .topbar-section-vacancy{
      padding:7px 18px;
      border-radius:10px;
      background:linear-gradient(135deg,#facc15,#f97316);
      color:#111827;
      font-size:.9rem;
      font-weight:700;
      text-decoration:none;
      box-shadow:0 8px 18px rgba(248,181,0,.45);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
    }
    .topbar-section-vacancy:hover{
      filter:brightness(1.06);
      transform:translateY(-1px);
    }

    .topbar-nav{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .topbar-link{
      font-size:.9rem;
      color:#e5e7eb;
      text-decoration:none;
    }
    .topbar-btn{
      padding:7px 16px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,#facc15,#f97316);
      color:#111827;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
      box-shadow:0 8px 18px rgba(248,181,0,.45);
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .topbar-btn:hover{
      filter:brightness(1.06);
      transform:translateY(-1px);
    }

    .topbar-btn.secondary{
      background:linear-gradient(135deg,#38bdf8,#0ea5e9);
      box-shadow:0 8px 18px rgba(56,189,248,.45);
      color:#0b1120;
    }

    .notif-wrapper{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .notif-bell{
      position:relative;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
    }
    .notif-bell:hover{
      background:#020617;
      box-shadow:0 6px 18px rgba(15,23,42,.6);
      transform:translateY(-1px);
    }
    .notif-badge{
      position:absolute;
      top:-4px;
      right:-2px;
      min-width:16px;
      height:16px;
      border-radius:999px;
      background:#ef4444;
      color:#f9fafb;
      font-size:10px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 4px;
    }

    .notif-dropdown{
      position:absolute;
      right:0;
      top:120%;
      width:320px;
      max-height:340px;
      overflow-y:auto;
      background:#020617;
      border:1px solid rgba(148,163,184,.45);
      border-radius:12px;
      box-shadow:0 16px 35px rgba(15,23,42,.85);
      padding:8px 0;
      display:none;
    }
    .notif-dropdown.open{
      display:block;
    }
    .notif-header{
      padding:6px 12px 4px;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9ca3af;
      border-bottom:1px solid rgba(31,41,55,.85);
    }
    .notif-empty{
      padding:10px 12px;
      font-size:.85rem;
      color:#9ca3af;
    }
    .notif-list{
      list-style:none;
      margin:0;
      padding:0;
    }
    .notif-item{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:8px 12px;
      border-bottom:1px solid rgba(31,41,55,.85);
      font-size:.85rem;
      color:#e5e7eb;
    }
    .notif-item:last-child{
      border-bottom:none;
    }
    .notif-item-text{
      flex:1;
      line-height:1.4;
      cursor:pointer;
    }
    .notif-item-text:hover{
      text-decoration:underline;
    }
    .notif-close{
      border:none;
      background:transparent;
      color:#9ca3af;
      cursor:pointer;
      font-size:.8rem;
      padding:2px;
    }
    .notif-close:hover{
      color:#f87171;
    }

    .notif-toast{
      position:fixed;
      left:20px;
      bottom:20px;
      max-width:360px;
      background:rgba(15,23,42,0.96);
      color:#f9fafb;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 12px 25px rgba(15,23,42,.75);
      font-size:.9rem;
      line-height:1.4;
      opacity:0;
      transform:translateY(10px);
      pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
      z-index:9999;
    }
    .notif-toast-visible{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }

    @media (max-width:640px){
      .topbar-inner{padding-inline:4px;}
      .topbar-brand span{font-size:.8rem;}
      .topbar-left{gap:10px;}
      .topbar-section-vacancy{padding:6px 12px;font-size:.8rem;}
      .notif-dropdown{
        width:260px;
        right:-40px;
      }
      .notif-toast{
        left:10px;
        right:10px;
        max-width:none;
      }
    }
  </style>

  <audio id="notif-sound" src="/static/sounds/notification.wav" preload="auto"></audio>

  <div class="topbar-inner">
    <div class="topbar-left">
      <a href="/" class="topbar-brand">
        <img src="/static/img/omega-logo.png" alt="Omega Hire">
        <span>OMEGA HIRE</span>
      </a>
      <a href="/vacancy" class="topbar-section-vacancy">–í–∞–∫–∞–Ω—Å–∏–∏</a>
      <a href="/candidate" class="topbar-section-upload">–ú–æ–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã</a>
    </div>

    <nav class="topbar-nav">
      {% if user_email %}
        <div class="notif-wrapper">
          <a href="/chat" class="notif-bell" id="chat-bell" title="–°–æ–æ–±—â–µ–Ω–∏—è" style="text-decoration:none;">
            üí¨
            <span class="notif-badge" id="chat-badge" style="display:none;">0</span>
          </a>
          <div class="notif-dropdown" id="chat-dropdown">
            <div class="notif-header">–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
            <div class="notif-empty" id="chat-empty">–ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>
            <ul class="notif-list" id="chat-list"></ul>
            <div style="padding:8px 12px;border-top:1px solid rgba(31,41,55,.85);">
              <a href="/chat" style="color:#facc15;text-decoration:none;font-size:.85rem;font-weight:600;">
                –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ —á–∞—Ç—ã ‚Üí
              </a>
            </div>
          </div>
        </div>

        <span class="topbar-link">{{ user_email }}</span>
        <a href="/auth/profile" class="topbar-btn">–ü—Ä–æ—Ñ–∏–ª—å</a>
      {% else %}
        <a href="/auth/login" class="topbar-btn">–í–æ–π—Ç–∏</a>
      {% endif %}
    </nav>
  </div>

  {% if user_email %}
  <div id="notif-toast" class="notif-toast"></div>

  <script>
    (function(){
      const bell      = document.getElementById("chat-bell");
      const badge     = document.getElementById("chat-badge");
      const dropdown  = document.getElementById("chat-dropdown");
      const listEl    = document.getElementById("chat-list");
      const emptyEl   = document.getElementById("chat-empty");
      const toastEl   = document.getElementById("notif-toast");
      const soundEl   = document.getElementById("notif-sound");

      if (!bell || !badge || !dropdown || !listEl || !emptyEl || !toastEl) {
        return;
      }

      let unreadChats = [];
      let toastTimer = null;

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
      async function loadUnreadChats(){
        try{
          const resp = await fetch("/chat/chats-list", {cache:"no-store"});
          if(!resp.ok){
            console.warn("chats-list status", resp.status);
            return;
          }
          const data = await resp.json();
          
          // –û–±—ä–µ–¥–∏–Ω—è–µ–º telegram –∏ email —á–∞—Ç—ã, —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
          const allChats = [
            ...(data.telegram_chats || []),
            ...(data.email_chats || [])
          ];
          
          unreadChats = allChats.filter(chat => chat.unread_count > 0);
          renderUnreadChats();
        }catch(e){
          console.error("chats-list error", e);
        }
      }

      function renderUnreadChats(){
        listEl.innerHTML = "";
        
        if(!unreadChats.length){
          emptyEl.style.display = "block";
          badge.style.display   = "none";
          return;
        }
        
        emptyEl.style.display = "none";
        badge.style.display   = "flex";
        
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        const totalUnread = unreadChats.reduce((sum, chat) => sum + chat.unread_count, 0);
        badge.textContent = totalUnread > 9 ? "9+" : String(totalUnread);

        unreadChats.forEach(function(chat){
          const li = document.createElement("li");
          li.className = "notif-item";
          li.style.cursor = "pointer";

          const textDiv = document.createElement("div");
          textDiv.className = "notif-item-text";
          
          const icon = chat.message_type === 'telegram' ? 'üì±' : '‚úâÔ∏è';
          const preview = chat.last_message ? chat.last_message.substring(0, 40) + '...' : '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
          
          textDiv.innerHTML = `
            <div style="font-weight:600;margin-bottom:2px;">${icon} ${chat.candidate_fullname}</div>
            <div style="font-size:0.8rem;color:#9ca3af;">${preview}</div>
          `;
          
          // –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
          li.addEventListener("click", function(){
            window.location.href = "/chat";
          });

          li.appendChild(textDiv);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
          if (chat.unread_count > 0) {
            const countSpan = document.createElement("span");
            countSpan.style.cssText = "background:#ef4444;color:#fff;font-size:0.7rem;font-weight:700;padding:2px 6px;border-radius:999px;min-width:18px;text-align:center;";
            countSpan.textContent = chat.unread_count;
            li.appendChild(countSpan);
          }
          
          listEl.appendChild(li);
        });
      }

      function showToast(message){
        if(!toastEl) return;

        if(toastTimer){
          clearTimeout(toastTimer);
          toastTimer = null;
        }

        const msg = message.message || {};
        const candidate = msg.candidate_fullname || "–∫–∞–Ω–¥–∏–¥–∞—Ç–∞";
        const vacancy = msg.vacancy_id || "";
        const messageType = msg.message_type === 'telegram' ? 'Telegram' : 'Email';
        
        let text = `üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ ${messageType} –æ—Ç ${candidate}`;
        if (vacancy) {
          text += ` (${vacancy})`;
        }

        toastEl.textContent = text;
        toastEl.classList.add("notif-toast-visible");

        toastTimer = setTimeout(function(){
          toastEl.classList.remove("notif-toast-visible");
        }, 5000);
      }

      function playSound(){
        if (!soundEl) return;
        try{
          soundEl.currentTime = 0;
          soundEl.play().catch(function(e){
            console.warn("cannot play sound", e);
          });
        }catch(e){
          console.warn("cannot play sound", e);
        }
      }

      // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ dropdown
      bell.addEventListener("click", async function(e){
        e.preventDefault();
        e.stopPropagation();
        const isOpen = dropdown.classList.contains("open");
        if(!isOpen){
          await loadUnreadChats();
          dropdown.classList.add("open");
        }else{
          dropdown.classList.remove("open");
        }
      });

      document.addEventListener("click", function(e){
        if(!dropdown.contains(e.target) && !bell.contains(e.target)){
          dropdown.classList.remove("open");
        }
      });

      const USER_ID_RAW = "{{ user_id }}";
      const USER_ID = Number(USER_ID_RAW || "0") || 0;

      // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket –¥–ª—è —á–∞—Ç–∞
      if (USER_ID > 0) {
        try{
          const proto = (window.location.protocol === "https:") ? "wss://" : "ws://";
          const wsUrl = proto + window.location.host + "/chat/ws/" + USER_ID;
          const ws = new WebSocket(wsUrl);

          ws.onopen = function(){
            console.log("‚úÖ [HEADER] Chat WebSocket connected");
          };
          
          ws.onclose = function(){
            console.log("üîå [HEADER] Chat WebSocket closed, reconnecting...");
            // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(function(){
              window.location.reload();
            }, 5000);
          };
          
          ws.onerror = function(ev){
            console.error("‚ùå [HEADER] Chat WebSocket error", ev);
          };
          
          ws.onmessage = async function(event){
            try{
              const data = JSON.parse(event.data);
              console.log("üì® [HEADER] New message from chat WS:", data);

              // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
              if (data.type === 'new_message') {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
                await loadUnreadChats();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showToast(data);
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                playSound();
              }
            }catch(e){
              console.error("‚ùå [HEADER] Chat WS parse error", e);
            }
          };
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
          setInterval(function(){
            if (ws.readyState === WebSocket.OPEN) {
              ws.send('ping');
            }
          }, 30000);
          
        }catch(e){
          console.error("‚ùå [HEADER] Chat WebSocket init error", e);
        }
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —á–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      loadUnreadChats();
    })();
  </script>
  {% endif %}
</header>
