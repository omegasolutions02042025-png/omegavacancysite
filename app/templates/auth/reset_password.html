{% extends "layouts/auth_layout.html" %}

{% block title %}Восстановление пароля — Omega Hire{% endblock %}

{% block content %}
<div class="mb-5">
    <h1 class="mb-2">Новый пароль</h1>
    <p class="text-muted">Введите новый пароль дважды для подтверждения</p>
</div>

<div id="error-message" class="alert alert-danger d-none mb-4" role="alert"></div>
<div id="success-message" class="alert alert-success d-none mb-4" role="alert"></div>

<form id="reset_form">
    <div class="mb-4">
        <label class="form-label d-block mb-2 text-muted small fw-bold">НОВЫЙ ПАРОЛЬ</label>
        <input 
            name="new_password" 
            type="password" 
            placeholder="Введите новый пароль" 
            class="form-input" 
            required
            autocomplete="new-password"
            minlength="6"
            id="new_password"
        >
    </div>
    
    <div class="mb-4">
        <label class="form-label d-block mb-2 text-muted small fw-bold">ПОДТВЕРДИТЕ ПАРОЛЬ</label>
        <input 
            name="confirm_password" 
            type="password" 
            placeholder="Подтвердите пароль" 
            class="form-input" 
            required
            autocomplete="new-password"
            minlength="6"
            id="confirm_password"
        >
    </div>

    <button type="submit" class="btn btn-primary w-100 mb-4">
        Изменить пароль
    </button>

    <div class="text-center">
        <a href="/auth/login" class="text-gold text-decoration-none">← Назад к входу</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById("reset_form");
    const errorMessage = document.getElementById("error-message");
    const successMessage = document.getElementById("success-message");
    const newPasswordInput = document.getElementById("new_password");
    const confirmPasswordInput = document.getElementById("confirm_password");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMessage.classList.add("d-none");
        successMessage.classList.add("d-none");
        
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (newPassword.length < 6) {
            errorMessage.textContent = "Пароль должен содержать минимум 6 символов";
            errorMessage.classList.remove("d-none");
            return;
        }

        if (newPassword !== confirmPassword) {
            errorMessage.textContent = "Пароли не совпадают";
            errorMessage.classList.remove("d-none");
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");

        if (!token) {
            errorMessage.textContent = "Неверная ссылка для восстановления пароля";
            errorMessage.classList.remove("d-none");
            return;
        }

        try {
            const formData = new FormData();
            formData.append("token", token);
            formData.append("new_password", newPassword);

            const resp = await fetch("/auth/reset-password", {
                method: "POST",
                body: formData
            });

            if (resp.status === 400 || resp.status === 404) {
                let errorText = "Ссылка недействительна или истекла";
                try {
                    const data = await resp.json();
                    errorText = data.detail || errorText;
                } catch {}
                errorMessage.textContent = errorText;
                errorMessage.classList.remove("d-none");
                return;
            }

            if (resp.ok) {
                successMessage.textContent = "Пароль успешно изменен! Перенаправление на страницу входа...";
                successMessage.classList.remove("d-none");
                setTimeout(() => {
                    window.location.href = "/auth/login?password_reset=success";
                }, 2000);
            } else {
                errorMessage.textContent = "Произошла ошибка при изменении пароля";
                errorMessage.classList.remove("d-none");
            }
        } catch (error) {
            errorMessage.textContent = "Ошибка сети. Попробуйте позже.";
            errorMessage.classList.remove("d-none");
        }
    });
</script>
{% endblock %}
