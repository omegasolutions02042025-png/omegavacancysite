{% extends "layouts/auth_layout.html" %}

{% block title %}Вход — Omega Hire{% endblock %}

{% block content %}
<div class="mb-5">
    <h1 class="mb-2">С возвращением</h1>
    <p class="text-muted">Введите свои учетные данные для входа в платформу</p>
</div>

{% if request.query_params.get("password_reset") == "success" %}
<div class="alert alert-success d-flex align-items-center mb-4" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i>
    <div>Пароль успешно изменен! Теперь вы можете войти.</div>
</div>
{% endif %}

<div id="login-error" class="alert alert-danger d-none mb-4" role="alert"></div>

<form id="login_form">
    <div class="mb-4">
        <label class="form-label d-block mb-2 text-muted small fw-bold">EMAIL</label>
        <input name="email" type="email" placeholder="name@company.com" class="form-input" required autocomplete="email">
    </div>
    
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label text-muted small fw-bold mb-0">ПАРОЛЬ</label>
            <a href="/auth/forgot-password" class="text-gold small text-decoration-none">Забыли пароль?</a>
        </div>
        <div class="position-relative">
            <input id="password-input" name="password" type="password" placeholder="Введите пароль" class="form-input" required autocomplete="current-password" style="padding-right: 40px;">
            <button type="button" id="toggle-password" class="btn-ghost position-absolute top-50 end-0 translate-middle-y p-2" style="color: var(--color-text-muted);">
                <i class="bi bi-eye"></i>
            </button>
        </div>
    </div>

    <button type="submit" class="btn btn-primary w-100 mb-4">
        Войти в систему
    </button>

    <div class="text-center text-muted">
        Нет аккаунта? <a href="/auth/register" class="text-gold fw-bold">Зарегистрироваться</a>
    </div>
</form>

<script>
    const form = document.getElementById("login_form");
    const errorBox = document.getElementById("login-error");
    const passwordInput = document.getElementById("password-input");
    const togglePasswordBtn = document.getElementById("toggle-password");

    togglePasswordBtn.addEventListener("click", () => {
        const isPassword = passwordInput.type === "password";
        passwordInput.type = isPassword ? "text" : "password";
        togglePasswordBtn.innerHTML = isPassword ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
    });

    function showError(message) {
        if (!message) return;
        errorBox.textContent = message;
        errorBox.classList.remove("d-none");
    }

    function hideError() {
        errorBox.classList.add("d-none");
        errorBox.textContent = "";
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideError();
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Вход...';

        try {
            const resp = await fetch("/auth/login", {
                method: "POST",
                body: formData
            });

            if (resp.redirected) {
                window.location.href = resp.url;
                return;
            }

            let data;
            try {
                data = await resp.json();
            } catch {
                showError("Сервер вернул некорректный ответ. Попробуйте позже.");
                submitBtn.disabled = false;
                submitBtn.textContent = "Войти в систему";
                return;
            }

            if (!resp.ok) {
                showError(data?.detail || "Ошибка авторизации. Попробуйте снова.");
                submitBtn.disabled = false;
                submitBtn.textContent = "Войти в систему";
                return;
            }

            if (data?.access_token) {
                document.cookie = `access_token=${data.access_token}; path=/;`;
                // Redirect to dashboard instead of profile usually, but keeping existing logic
                window.location.href = "/auth/profile"; 
            } else {
                showError("Не удалось авторизоваться. Попробуйте позже.");
                submitBtn.disabled = false;
                submitBtn.textContent = "Войти в систему";
            }
        } catch (error) {
            showError("Не удалось отправить запрос. Проверьте подключение к интернету.");
            submitBtn.disabled = false;
            submitBtn.textContent = "Войти в систему";
        }
    });
</script>
{% endblock %}
