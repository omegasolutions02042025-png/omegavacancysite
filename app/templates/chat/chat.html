{% extends "layouts/base.html" %}

{% block title %}–ß–∞—Ç—ã —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏ ‚Äî Omega Hire{% endblock %}

{% block head %}
<style>
  .chat-page {
    max-width: 1600px;
    margin: 0 auto;
  }

  .page-header {
    margin-bottom: 32px;
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text-heading);
    margin: 0 0 12px;
    text-shadow: 
      0 0 20px rgba(255, 215, 0, 0.3),
      0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .chat-layout {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 24px;
    height: calc(100vh - 200px);
    min-height: 600px;
  }

  @media (max-width: 1024px) {
    .chat-layout {
      grid-template-columns: 1fr;
    }
    .chat-sidebar {
      display: none;
    }
    .chat-sidebar.mobile-visible {
      display: flex;
    }
  }

  /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å–ø–∏—Å–∫–æ–º —á–∞—Ç–æ–≤ */
  .chat-sidebar {
    background: var(--color-bg-surface);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1),
      0 0 30px rgba(255, 215, 0, 0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .chat-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 12px;
  }

  .add-chat-btn {
    width: 100%;
    padding: 12px;
    margin-bottom: 16px;
    background: var(--gradient-gold);
    color: #0A1929;
    border: none;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 
      0 4px 15px rgba(255, 215, 0, 0.4),
      0 0 20px rgba(255, 215, 0, 0.2);
    position: relative;
    overflow: hidden;
  }

  .add-chat-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }

  .add-chat-btn:hover::before {
    width: 300px;
    height: 300px;
  }

  .add-chat-btn:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 6px 25px rgba(255, 215, 0, 0.6),
      0 0 40px rgba(255, 215, 0, 0.4);
  }

  .chat-tab {
    flex: 1;
    padding: 10px 16px;
    border-radius: 8px;
    background: var(--color-bg-surface-2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text-primary);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-decoration: none;
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  .chat-tab.active {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
    border-color: var(--color-accent-gold);
    color: var(--color-accent-gold);
    box-shadow: 
      0 0 20px rgba(255, 215, 0, 0.4),
      0 4px 12px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
  }

  .chat-tab:hover:not(.active) {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 215, 0, 0.3);
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.2),
      0 0 15px rgba(255, 215, 0, 0.1);
  }

  .tab-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background: #E74C3C;
    color: white;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 700;
    margin-left: 6px;
    box-shadow: 
      0 2px 8px rgba(231, 76, 60, 0.4),
      0 0 10px rgba(231, 76, 60, 0.2);
  }

  .chat-tab.active .tab-badge {
    background: var(--color-accent-gold);
    color: #0A1929;
    box-shadow: 
      0 2px 8px rgba(255, 215, 0, 0.5),
      0 0 15px rgba(255, 215, 0, 0.3);
  }

  .chat-list {
    flex: 1;
    overflow-y: auto;
    margin: 0 -12px;
    padding: 0 12px;
  }

  .chat-list::-webkit-scrollbar {
    width: 6px;
  }

  .chat-list::-webkit-scrollbar-track {
    background: transparent;
  }

  .chat-list::-webkit-scrollbar-thumb {
    background: var(--color-bg-surface-2);
    border-radius: 3px;
  }

  .chat-list::-webkit-scrollbar-thumb:hover {
    background: var(--color-accent-gold);
  }

  .chat-item {
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.05);
    background: var(--color-bg-surface-2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
    position: relative;
    overflow: hidden;
  }

  .chat-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
      transparent 0%, 
      rgba(255, 215, 0, 0.1) 50%, 
      transparent 100%);
    transition: left 0.5s ease;
  }

  .chat-item:hover {
    background: var(--color-bg-surface);
    border-color: rgba(255, 215, 0, 0.3);
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.2),
      0 0 20px rgba(255, 215, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transform: translateX(2px);
  }

  .chat-item:hover::before {
    left: 100%;
  }

  .chat-item.active {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.08) 100%);
    border-color: var(--color-accent-gold);
    box-shadow: 
      0 0 25px rgba(255, 215, 0, 0.3),
      0 4px 12px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
  }

    .chat-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      position: relative;
    }

  .chat-item-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-text-heading);
    flex: 1;
  }

    .chat-item-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-item-delete {
      background: none !important;
      border: none !important;
      color: #ef4444 !important; /* üî¥ –ö—Ä–∞—Å–Ω–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      cursor: pointer !important;
      padding: 4px 6px !important;
      font-size: 1rem !important;
      transition: all 0.2s !important;
      opacity: 0 !important;
      border-radius: 4px !important;
      outline: none !important;
    }

    .chat-item:hover .chat-item-delete {
      opacity: 1 !important;
    }

    .chat-item-delete:hover {
      background: rgba(239, 68, 68, 0.1) !important; /* –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
      transform: scale(1.15) !important;
    }

    .chat-item-delete:active {
      transform: scale(0.95) !important;
      background: rgba(239, 68, 68, 0.2) !important;
    }

  .chat-item-time {
    font-size: 0.75rem;
    color: var(--color-text-primary);
    opacity: 0.8;
  }

  .chat-item-preview {
    font-size: 0.85rem;
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
    line-height: 1.4;
  }

  .preview-text {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 400;
    color: var(--color-text-primary);
    opacity: 0.9;
  }

  .chat-item:hover .preview-text {
    color: var(--color-text-heading);
    opacity: 1;
  }

  .chat-item.active .preview-text {
    font-weight: 500;
    color: var(--color-accent-gold);
    text-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
  }

  .chat-item-badge {
    display: inline-block;
    background: #E74C3C;
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 999px;
    min-width: 20px;
    text-align: center;
    flex-shrink: 0;
    box-shadow: 
      0 2px 8px rgba(231, 76, 60, 0.4),
      0 0 15px rgba(231, 76, 60, 0.2);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .no-chats {
    text-align: center;
    padding: 40px 20px;
    color: var(--color-text-primary);
    opacity: 0.8;
    font-size: 0.9rem;
  }

  /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ */
  .chat-main {
    background: var(--color-bg-surface);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1),
      0 0 30px rgba(255, 215, 0, 0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .chat-header {
    padding: 20px 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(15, 23, 42, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    position: relative;
    min-height: 70px;
  }

    .chat-header * {
      text-decoration: none;
    }

  .chat-header-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-text-heading);
    margin: 0;
    text-decoration: none;
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
  }

  .chat-header-subtitle {
    font-size: 0.85rem;
    color: var(--color-text-primary);
    opacity: 0.9;
    margin: 0;
    text-decoration: none;
  }

    #chat-title-link {
      transition: all 0.2s;
    }

  #chat-title-link:hover {
    color: var(--color-accent-gold) !important;
    text-decoration: underline !important;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
  }

    #chat-vacancy-link {
      transition: all 0.2s;
      padding: 4px 8px;
      border-radius: 6px;
    }

  #chat-vacancy-link:hover {
    background: rgba(255, 215, 0, 0.1);
    text-decoration: none;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
  }

  #chat-vacancy-link:hover #chat-vacancy-id,
  #chat-vacancy-link:hover #chat-vacancy-title {
    color: var(--color-accent-gold);
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    position: relative;
    background: rgba(15, 23, 42, 0.2);
  }

  .chat-messages::-webkit-scrollbar {
    width: 6px;
  }

  .chat-messages::-webkit-scrollbar-track {
    background: transparent;
  }

  .chat-messages::-webkit-scrollbar-thumb {
    background: var(--color-bg-surface-2);
    border-radius: 3px;
  }

  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: var(--color-accent-gold);
  }

  /* –ü–ª–∞—à–∫–∞ "–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" */
  .new-message-badge {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--color-accent-gold) 0%, #E6C200 100%);
    color: #0A1929;
    padding: 12px 24px;
    border-radius: 24px;
    box-shadow: 
      0 4px 15px rgba(255, 215, 0, 0.5),
      0 0 30px rgba(255, 215, 0, 0.3);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    z-index: 10;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 8px;
    animation: slideUp 0.3s ease-out;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
  }

  .new-message-badge:hover {
    background: linear-gradient(135deg, #FFE066 0%, var(--color-accent-gold) 100%);
    transform: translateX(-50%) translateY(-2px);
    box-shadow: 
      0 6px 25px rgba(255, 215, 0, 0.7),
      0 0 40px rgba(255, 215, 0, 0.4);
  }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .message {
      display: flex;
      gap: 12px;
      max-width: 70%;
      position: relative;
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.candidate.unread {
      animation: pulseUnread 2s ease-in-out;
    }

  .message.candidate.unread .message-bubble {
    border-left: 4px solid #E74C3C;
    background: rgba(231, 76, 60, 0.15);
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.2),
      0 0 20px rgba(231, 76, 60, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

    @keyframes pulseUnread {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .message-content {
      flex: 1;
    }

  .message-bubble {
    padding: 12px 16px;
    border-radius: 16px;
    background: var(--color-bg-surface-2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: var(--color-text-heading);
    font-size: 0.9rem;
    line-height: 1.5;
    word-wrap: break-word;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  .message.user .message-bubble {
    background: linear-gradient(135deg, var(--color-accent-gold) 0%, #E6C200 100%);
    color: #0A1929;
    border-color: rgba(255, 215, 0, 0.3);
    box-shadow: 
      0 4px 12px rgba(255, 215, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

    .message-media {
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .message-media img {
      display: block;
      max-width: 300px;
      max-height: 300px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .message-media img:hover {
      transform: scale(1.02);
    }

    .media-download-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #f3f4f6;
      border-radius: 12px;
      text-decoration: none;
      color: #111827;
      font-size: 0.9rem;
      transition: background-color 0.2s;
    }

    .message.user .media-download-link {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .media-download-link:hover {
      background: #e5e7eb;
    }

    .message.user .media-download-link:hover {
      background: rgba(255, 255, 255, 0.3);
    }

  .message-time {
    font-size: 0.75rem;
    color: var(--color-text-primary);
    opacity: 0.8;
    margin-top: 4px;
    padding: 0 4px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

    .mark-unread-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .mark-unread-btn:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .mark-unread-btn:active {
      transform: translateY(0);
    }

  .chat-input-area {
    padding: 20px 24px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(15, 23, 42, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

    .chat-input-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

  .chat-input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: var(--color-bg-surface-2);
    color: var(--color-text-heading);
    font-size: 0.9rem;
    resize: none;
    min-height: 48px;
    max-height: 120px;
    font-family: inherit;
    transition: all 0.3s ease;
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  .chat-input:focus {
    outline: none;
    border-color: var(--color-accent-gold);
    box-shadow: 
      0 0 0 2px rgba(255, 215, 0, 0.2),
      0 0 20px rgba(255, 215, 0, 0.15),
      0 4px 12px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  .chat-send-btn {
    padding: 12px 24px;
    border-radius: 12px;
    background: var(--gradient-gold);
    color: #0A1929;
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    box-shadow: 
      0 4px 15px rgba(255, 215, 0, 0.4),
      0 0 20px rgba(255, 215, 0, 0.2);
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
  }

  .chat-send-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }

  .chat-send-btn:hover::before {
    width: 300px;
    height: 300px;
  }

  .chat-send-btn:hover {
    background: linear-gradient(135deg, #FFE066 0%, var(--color-accent-gold) 100%);
    transform: translateY(-2px);
    box-shadow: 
      0 6px 25px rgba(255, 215, 0, 0.6),
      0 0 40px rgba(255, 215, 0, 0.4);
  }

    .chat-send-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

  .empty-chat {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    color: var(--color-text-primary);
    opacity: 0.8;
    gap: 12px;
  }

    .empty-chat-icon {
      font-size: 4rem;
    }

    .empty-chat-text {
      font-size: 1.1rem;
      font-weight: 600;
    }

  /* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤—ã—à–µ */

  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤ */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px) saturate(150%);
    -webkit-backdrop-filter: blur(10px) saturate(150%);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    background: linear-gradient(135deg, 
      var(--color-bg-surface) 0%, 
      var(--color-bg-surface-2) 100%);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border-radius: 16px;
    padding: 32px;
    max-width: 600px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 
      0 20px 60px rgba(0, 0, 0, 0.5),
      0 0 60px rgba(255, 215, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
    position: relative;
    overflow: hidden;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from { 
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to { 
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
      transparent 0%, 
      var(--color-accent-gold) 50%, 
      transparent 100%);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
  }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

  .modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-heading);
    margin: 0;
    text-shadow: 
      0 0 15px rgba(255, 215, 0, 0.3),
      0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .modal-close {
    background: transparent;
    border: none;
    font-size: 1.5rem;
    color: var(--color-text-primary);
    cursor: pointer;
    padding: 4px 8px;
    line-height: 1;
    border-radius: 8px;
    transition: all 0.3s ease;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--color-accent-gold);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
  }

    .dialog-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

  .dialog-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--color-bg-surface-2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }
    .dialog-item * {
      text-decoration: none !important;
    }
    .dialog-item h1,
    .dialog-item h2,
    .dialog-item h3,
    .dialog-item h4,
    .dialog-item h5,
    .dialog-item h6 {
      border-bottom: none !important;
      border-top: none !important;
      text-decoration: none !important;
    }

  .dialog-item:hover {
    background: var(--color-bg-surface);
    border-color: rgba(255, 215, 0, 0.3);
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.2),
      0 0 20px rgba(255, 215, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transform: translateY(-1px);
  }

  .dialog-item.selected {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.08) 100%);
    border-color: var(--color-accent-gold);
    box-shadow: 
      0 0 25px rgba(255, 215, 0, 0.3),
      0 4px 12px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
  }

    .dialog-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }

  .modal-actions {
    display: flex !important;
    gap: 12px;
    margin-top: 24px;
    padding-top: 24px;
    padding-bottom: 8px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    justify-content: space-between;
    visibility: visible !important;
    opacity: 1 !important;
    position: sticky;
    bottom: 0;
    background: linear-gradient(to bottom, 
      transparent 0%, 
      var(--color-bg-surface) 20%);
    z-index: 10;
  }

    .modal-action-btn {
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
    }

  .btn-add-selected {
    background: var(--gradient-gold);
    color: #0A1929;
    box-shadow: 
      0 4px 15px rgba(255, 215, 0, 0.4),
      0 0 20px rgba(255, 215, 0, 0.2);
  }

  .btn-add-selected:hover {
    background: linear-gradient(135deg, #FFE066 0%, var(--color-accent-gold) 100%);
    transform: translateY(-2px);
    box-shadow: 
      0 6px 25px rgba(255, 215, 0, 0.6),
      0 0 40px rgba(255, 215, 0, 0.4);
  }

  .btn-add-selected:disabled {
    background: var(--color-bg-surface-2);
    color: var(--color-text-muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-hide-selected {
    background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
    color: white;
    box-shadow: 
      0 4px 15px rgba(231, 76, 60, 0.4),
      0 0 20px rgba(231, 76, 60, 0.2);
  }

  .btn-hide-selected:hover {
    background: linear-gradient(135deg, #C0392B 0%, #A93226 100%);
    transform: translateY(-2px);
    box-shadow: 
      0 6px 25px rgba(231, 76, 60, 0.6),
      0 0 40px rgba(231, 76, 60, 0.4);
  }

  .btn-hide-selected:disabled {
    background: var(--color-bg-surface-2);
    color: var(--color-text-muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .selected-count {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--color-text-primary);
    opacity: 0.9;
    font-size: 0.9rem;
    font-weight: 500;
  }

    .dialog-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .dialog-info {
      flex: 1;
      min-width: 0;
    }
    .dialog-info * {
      text-decoration: none !important;
      border-bottom: none !important;
      border-top: none !important;
    }

  .dialog-name {
    font-weight: 600;
    color: var(--color-text-heading);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-decoration: none !important;
    border-bottom: none !important;
    border-top: none !important;
  }

  .dialog-username {
    font-size: 0.85rem;
    color: var(--color-text-primary);
    opacity: 0.8;
    text-decoration: none !important;
    border-bottom: none !important;
    border-top: none !important;
  }

    .dialog-add-btn {
      padding: 8px 16px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .dialog-add-btn:hover {
      background: #059669;
      transform: scale(1.05);
    }

    .dialog-add-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    .dialog-input-group {
      margin-top: 12px;
      display: none;
    }

    .dialog-input-group.active {
      display: block;
    }

  .dialog-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    background: var(--color-bg-surface-2);
    color: var(--color-text-heading);
    font-size: 0.9rem;
    margin-bottom: 8px;
    transition: all 0.3s ease;
  }

  .dialog-input:focus {
    outline: none;
    border-color: var(--color-accent-gold);
    box-shadow: 
      0 0 0 2px rgba(255, 215, 0, 0.2),
      0 0 20px rgba(255, 215, 0, 0.15);
  }

    .dialog-save-btn {
      width: 100%;
      padding: 10px;
      background: #1d4ed8;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dialog-save-btn:hover {
      background: #1e40af;
    }

  .loading-spinner {
    text-align: center;
    padding: 32px;
    color: var(--color-text-primary);
    opacity: 0.9;
    font-size: 1.1rem;
  }

    /* –ü–æ–∏—Å–∫ –¥–∏–∞–ª–æ–≥–æ–≤ */
    .dialog-search-container {
      position: relative;
      margin-bottom: 16px;
    }

  .dialog-search-input {
    width: 100%;
    padding: 12px 40px 12px 16px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    background: var(--color-bg-surface-2);
    color: var(--color-text-heading);
    font-size: 0.95rem;
    transition: all 0.3s ease;
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  .dialog-search-input:focus {
    outline: none;
    border-color: var(--color-accent-gold);
    box-shadow: 
      0 0 0 2px rgba(255, 215, 0, 0.2),
      0 0 20px rgba(255, 215, 0, 0.15),
      0 4px 12px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

    .dialog-search-clear {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
      display: none;
    }

    .dialog-search-clear.visible {
      display: block;
    }

  .dialog-search-clear:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--color-accent-gold);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
  }

    .dialog-item.hidden {
      display: none !important;
    }

  .no-results-message {
    text-align: center;
    padding: 40px 20px;
    color: var(--color-text-primary);
    opacity: 0.8;
    font-size: 0.95rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="chat-page">
  <div class="page-header">
    <h1 class="page-title">
      <i class="bi bi-chat-dots me-2"></i>–ß–∞—Ç—ã —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏
    </h1>
  </div>

    <div class="chat-layout">
      <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å–ø–∏—Å–∫–æ–º —á–∞—Ç–æ–≤ -->
      <div class="chat-sidebar">
        <div class="chat-tabs">
          <button class="chat-tab active" data-type="telegram" onclick="switchTab('telegram')">
            üì± Telegram
            <span class="tab-badge" id="telegram-tab-badge" style="display:none;">0</span>
          </button>
          <button class="chat-tab" data-type="email" onclick="switchTab('email')">
            ‚úâÔ∏è Email
            <span class="tab-badge" id="email-tab-badge" style="display:none;">0</span>
          </button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è Telegram) -->
        <button class="add-chat-btn" id="add-chat-btn" onclick="openAddChatModal()">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç—ã –∏–∑ Telegram
        </button>

        <!-- –°–ø–∏—Å–æ–∫ Telegram —á–∞—Ç–æ–≤ -->
        <div class="chat-list" id="telegram-chats">
          {% if telegram_chats %}
            {% for chat in telegram_chats %}
            <div class="chat-item" 
                 data-candidate="{{ chat.candidate_fullname }}" 
                 data-type="telegram"
                 data-vacancy="{{ chat.vacancy_id or '' }}"
                 data-vacancy-title="{{ chat.vacancy_title or '' }}"
                 data-candidate-id="{{ chat.candidate_id or '' }}"
                 onclick="openChat('telegram', this.dataset.candidate, this.dataset.vacancy, this.dataset.vacancyTitle, this)">
              <div class="chat-item-header">
                <span class="chat-item-name">{{ chat.candidate_fullname }}</span>
                <div class="chat-item-actions">
                  <button class="chat-item-delete" 
                          onclick="event.stopPropagation(); deleteDialog('telegram', '{{ chat.candidate_fullname }}')" 
                          title="–£–¥–∞–ª–∏—Ç—å –¥–∏–∞–ª–æ–≥">üóëÔ∏è</button>
                  <span class="chat-item-time">{{ chat.last_timestamp[:16] if chat.last_timestamp else '' }}</span>
                </div>
              </div>
              {% if chat.vacancy_id %}
              <div style="font-size:0.75rem;color:var(--color-accent-gold);font-weight:600;margin:2px 0;">
                ID: {{ chat.vacancy_id }}
              </div>
              {% endif %}
              {% if chat.vacancy_title %}
              <div style="font-size:0.75rem;color:var(--color-text-primary);opacity:0.9;margin:2px 0 4px 0;">
                {{ chat.vacancy_title[:40] }}{% if chat.vacancy_title|length > 40 %}...{% endif %}
              </div>
              {% endif %}
              <div class="chat-item-preview">
                <span class="preview-text">
                  {% if chat.last_message %}
                    {{ chat.last_message[:70] }}{% if chat.last_message|length > 70 %}...{% endif %}
                  {% else %}
                    –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
                  {% endif %}
                </span>
                {% if chat.unread_count > 0 %}
                <span class="chat-item-badge">{{ chat.unread_count }}</span>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="no-chats">
              <p>üì± –ù–µ—Ç —á–∞—Ç–æ–≤ –≤ Telegram</p>
              <p style="font-size:0.8rem;margin-top:8px;">–ß–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
            </div>
          {% endif %}
        </div>

        <!-- –°–ø–∏—Å–æ–∫ Email —á–∞—Ç–æ–≤ -->
        <div class="chat-list" id="email-chats" style="display:none;">
          {% if email_chats %}
            {% for chat in email_chats %}
            <div class="chat-item" 
                 data-candidate="{{ chat.candidate_fullname }}" 
                 data-type="email"
                 data-vacancy="{{ chat.vacancy_id or '' }}"
                 data-vacancy-title="{{ chat.vacancy_title or '' }}"
                 data-candidate-id="{{ chat.candidate_id or '' }}"
                 onclick="openChat('email', this.dataset.candidate, this.dataset.vacancy, this.dataset.vacancyTitle, this)">
              <div class="chat-item-header">
                <span class="chat-item-name">{{ chat.candidate_fullname }}</span>
                <div class="chat-item-actions">
                  <button class="chat-item-delete" 
                          onclick="event.stopPropagation(); deleteDialog('email', '{{ chat.candidate_fullname }}')" 
                          title="–£–¥–∞–ª–∏—Ç—å –¥–∏–∞–ª–æ–≥">üóëÔ∏è</button>
                  <span class="chat-item-time">{{ chat.last_timestamp[:16] if chat.last_timestamp else '' }}</span>
                </div>
              </div>
              {% if chat.vacancy_id %}
              <div style="font-size:0.75rem;color:var(--color-accent-gold);font-weight:600;margin:2px 0;">
                ID: {{ chat.vacancy_id }}
              </div>
              {% endif %}
              {% if chat.vacancy_title %}
              <div style="font-size:0.75rem;color:var(--color-text-primary);opacity:0.9;margin:2px 0 4px 0;">
                {{ chat.vacancy_title[:40] }}{% if chat.vacancy_title|length > 40 %}...{% endif %}
              </div>
              {% endif %}
              <div class="chat-item-preview">
                <span class="preview-text">
                  {% if chat.last_message %}
                    {{ chat.last_message[:70] }}{% if chat.last_message|length > 70 %}...{% endif %}
                  {% else %}
                    –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
                  {% endif %}
                </span>
                {% if chat.unread_count > 0 %}
                <span class="chat-item-badge">{{ chat.unread_count }}</span>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="no-chats">
              <p>‚úâÔ∏è –ù–µ—Ç —á–∞—Ç–æ–≤ –≤ Email</p>
              <p style="font-size:0.8rem;margin-top:8px;">–ß–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ -->
      <div class="chat-main">
        <div class="empty-chat" id="empty-chat">
          <div class="empty-chat-icon">üí¨</div>
          <div class="empty-chat-text">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏</div>
        </div>

        <div id="chat-content" style="display:none; flex-direction:column; height:100%;">
          <div class="chat-header">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
              <div style="flex:1;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <h2 class="chat-header-title" id="chat-title" style="margin:0;">
                  <a href="#" id="chat-title-link" style="color:inherit;text-decoration:none;cursor:pointer;" onclick="openCandidateCard(event)">
                    –ò–º—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
                  </a>
                </h2>
                <div id="chat-vacancy-info" style="display:none;">
                  <a href="#" id="chat-vacancy-link" style="text-decoration:none;cursor:pointer;display:flex;align-items:center;gap:4px;" onclick="openVacancyCard(event)">
                    <span id="chat-vacancy-id" style="font-size:0.85rem;font-weight:600;color:var(--color-accent-gold);"></span>
                    <span id="chat-vacancy-title" style="font-size:0.85rem;color:var(--color-text-primary);opacity:0.9;"></span>
                  </a>
                </div>
                <a href="#" id="last-sverka-link" style="display:none;padding:8px 16px;background:var(--gradient-gold);color:#0A1929;border-radius:8px;text-decoration:none;font-size:0.85rem;font-weight:600;transition:all 0.3s;box-shadow:0 4px 15px rgba(255,215,0,0.4),0 0 20px rgba(255,215,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #FFE066 0%, var(--color-accent-gold) 100%)';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 25px rgba(255,215,0,0.6),0 0 40px rgba(255,215,0,0.4)'" onmouseout="this.style.background='var(--gradient-gold)';this.style.transform='none';this.style.boxShadow='0 4px 15px rgba(255,215,0,0.4),0 0 20px rgba(255,215,0,0.2)'" title="–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—Ä–∫—É —ç—Ç–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏ –≤–∞–∫–∞–Ω—Å–∏–∏">
                  üìã –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—Ä–∫–µ
                </a>
              </div>
              <button class="mark-unread-btn" onclick="markChatAsUnread(event)" title="–ü–æ–º–µ—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥ –∫–∞–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π">
                ‚óã –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
              </button>
            </div>
            <p class="chat-header-subtitle" id="chat-subtitle" style="margin-top:4px;">Telegram</p>
          </div>

          <div class="chat-messages" id="messages-container">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
          </div>

          <!-- –ü–ª–∞—à–∫–∞ "–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" -->
          <div class="new-message-badge" id="new-message-badge" style="display:none;" onclick="scrollToBottom()">
            <span id="new-message-text">‚Üì 1 –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
          </div>

          <div class="chat-input-area">
            <form class="chat-input-form" id="message-form" onsubmit="sendMessage(event)">
              <textarea 
                class="chat-input" 
                id="message-input" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                rows="1"
                required
              ></textarea>
              <button type="submit" class="chat-send-btn" id="send-btn">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤ -->
  <div class="modal-overlay" id="add-chat-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üì± –î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç—ã –∏–∑ Telegram</h2>
        <button class="modal-close" onclick="closeAddChatModal()">‚úï</button>
      </div>
      
      <!-- –ü–æ–∏—Å–∫ –¥–∏–∞–ª–æ–≥–æ–≤ -->
      <div class="dialog-search-container">
        <input 
          type="text" 
          id="dialog-search-input" 
          class="dialog-search-input" 
          placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ username..."
          oninput="filterDialogs(this.value)"
        >
        <button class="dialog-search-clear" onclick="clearDialogSearch()" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫">‚úï</button>
      </div>
      
      <div id="dialog-list-container">
        <div class="loading-spinner">
          –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤...
        </div>
      </div>
      <div class="modal-actions" id="modal-actions">
        <div class="selected-count">
          <span id="selected-count-text">–í—ã–±—Ä–∞–Ω–æ: 0</span>
        </div>
        <div style="display:flex;gap:12px;">
          <button class="modal-action-btn btn-hide-selected" onclick="hideSelectedDialogs()" disabled>
            üóëÔ∏è –°–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
          </button>
          <button class="modal-action-btn btn-add-selected" onclick="addSelectedDialogs()" disabled>
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentChatType = 'telegram';
    let currentCandidate = null;
    let currentVacancyId = null;
    let currentVacancyTitle = null;
    let currentCandidateId = null; // ID –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (number_for_user)
    let ws = null;
    const userId = Number('{{ user_id|default(0) }}') || 0;
    let unreadMessagesCount = 0; // –°—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ
    let lastReadMessageId = null; // ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

    function switchTab(type) {
      currentChatType = type;
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–∞–±—ã
      document.querySelectorAll('.chat-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.chat-tab[data-type="${type}"]`).classList.add('active');

      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–ø–∏—Å–∫–∏ —á–∞—Ç–æ–≤
      document.getElementById('telegram-chats').style.display = type === 'telegram' ? 'block' : 'none';
      document.getElementById('email-chats').style.display = type === 'email' ? 'block' : 'none';

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç—ã"
      const addChatBtn = document.getElementById('add-chat-btn');
      if (addChatBtn) {
        addChatBtn.style.display = type === 'telegram' ? 'block' : 'none';
      }

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω
      document.getElementById('empty-chat').style.display = 'flex';
      document.getElementById('chat-content').style.display = 'none';
      currentCandidate = null;
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–≤–µ—Ä–∫–∏
      const lastSverkaLink = document.getElementById('last-sverka-link');
      if (lastSverkaLink) {
        lastSverkaLink.style.display = 'none';
      }
    }

    async function openChat(type, candidate, vacancyId, vacancyTitle, eventElement) {
      currentChatType = type;
      currentCandidate = candidate;
      currentVacancyId = vacancyId;
      currentVacancyTitle = vacancyTitle;

      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
        // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–æ data-–∞—Ç—Ä–∏–±—É—Ç–∞–º
        if (item.dataset.candidate === candidate && item.dataset.type === type) {
          item.classList.add('active');
        }
      });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —á–∞—Ç–∞
      document.getElementById('empty-chat').style.display = 'none';
      document.getElementById('chat-content').style.display = 'flex';

      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      const chatTitleLink = document.getElementById('chat-title-link');
      chatTitleLink.textContent = candidate;
      document.getElementById('chat-subtitle').textContent = type === 'telegram' ? 'üì± Telegram' : '‚úâÔ∏è Email';
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º ID –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –¥–ª—è —Å—Å—ã–ª–∫–∏
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ candidate_id –≤ –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞
      const chatItem = document.querySelector(`.chat-item[data-candidate="${candidate}"][data-type="${type}"]`);
      let candidateIdFromChat = null;
      if (chatItem && chatItem.dataset.candidateId) {
        candidateIdFromChat = chatItem.dataset.candidateId.trim();
      }
      
      // –ï—Å–ª–∏ candidate_id –µ—Å—Ç—å –≤ —á–∞—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ API
      if (candidateIdFromChat) {
        currentCandidateId = parseInt(candidateIdFromChat);
        if (!isNaN(currentCandidateId)) {
          chatTitleLink.href = `/candidate/open/${currentCandidateId}`;
          chatTitleLink.style.color = 'var(--color-accent-gold)';
          chatTitleLink.style.textDecoration = 'underline';
        } else {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ API
          loadCandidateIdFromAPI();
        }
      } else {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ API
        (async function() {
          try {
            const candidateResponse = await fetch(`/chat/candidate-id/${encodeURIComponent(candidate)}`);
            if (candidateResponse.ok) {
              const candidateData = await candidateResponse.json();
              currentCandidateId = candidateData.candidate_id;
              if (currentCandidateId) {
                chatTitleLink.href = `/candidate/open/${currentCandidateId}`;
                chatTitleLink.style.color = 'var(--color-accent-gold)';
                chatTitleLink.style.textDecoration = 'underline';
              } else {
                chatTitleLink.href = '#';
                chatTitleLink.style.color = 'inherit';
                chatTitleLink.style.textDecoration = 'none';
              }
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ID –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', error);
            chatTitleLink.href = '#';
            chatTitleLink.style.color = 'inherit';
            chatTitleLink.style.textDecoration = 'none';
          }
        })();
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ —à–∞–ø–∫–µ
      const vacancyInfo = document.getElementById('chat-vacancy-info');
      if (vacancyId) {
        vacancyInfo.style.display = 'block';
        document.getElementById('chat-vacancy-id').textContent = `ID: ${vacancyId}`;
        const vacancyLink = document.getElementById('chat-vacancy-link');
        vacancyLink.href = `/vacancy/${encodeURIComponent(vacancyId)}`;
        vacancyLink.style.color = 'inherit';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—Ä–∫—É
        await loadLastSverkaLink(candidate, vacancyId);
      } else {
        vacancyInfo.style.display = 'none';
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–≤–µ—Ä–∫–∏, –µ—Å–ª–∏ –Ω–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–∏
        const lastSverkaLink = document.getElementById('last-sverka-link');
        if (lastSverkaLink) {
          lastSverkaLink.style.display = 'none';
        }
      }
      
      if (vacancyTitle) {
        document.getElementById('chat-vacancy-title').textContent = vacancyTitle;
      } else {
        document.getElementById('chat-vacancy-title').textContent = '';
      }

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
      unreadMessagesCount = 0;
      hideNewMessageBadge();

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
      await loadMessages(type, candidate);
      
      // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
      await markMessagesAsRead(type, candidate);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
    function openCandidateCard(event) {
      event.preventDefault();
      if (currentCandidateId) {
        window.open(`/candidate/open/${currentCandidateId}`, '_blank');
      } else {
        console.warn('ID –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–∏
    function openVacancyCard(event) {
      event.preventDefault();
      if (currentVacancyId) {
        window.open(`/vacancy/${encodeURIComponent(currentVacancyId)}`, '_blank');
      } else {
        console.warn('ID –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—Ä–∫—É
    async function loadLastSverkaLink(candidateFullname, vacancyId) {
      if (!candidateFullname || !vacancyId) {
        const lastSverkaLink = document.getElementById('last-sverka-link');
        if (lastSverkaLink) {
          lastSverkaLink.style.display = 'none';
        }
        return;
      }

      try {
        const response = await fetch(`/chat/last-sverka/${encodeURIComponent(candidateFullname)}/${encodeURIComponent(vacancyId)}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const lastSverkaLink = document.getElementById('last-sverka-link');
        
        if (data.found && lastSverkaLink) {
          lastSverkaLink.href = data.url;
          lastSverkaLink.style.display = 'inline-flex';
          lastSverkaLink.target = '_blank';
        } else {
          if (lastSverkaLink) {
            lastSverkaLink.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—Ä–∫—É:', error);
        const lastSverkaLink = document.getElementById('last-sverka-link');
        if (lastSverkaLink) {
          lastSverkaLink.style.display = 'none';
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑
    function scrollToBottom() {
      const container = document.getElementById('messages-container');
      container.scrollTo({
        top: container.scrollHeight,
        behavior: 'smooth'
      });
      hideNewMessageBadge();
      
      // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      if (currentCandidate && currentChatType) {
        setTimeout(() => {
          console.log('üìñ –ü—Ä–æ–∫—Ä—É—Ç–∏–ª–∏ –≤–Ω–∏–∑, –ø–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ');
          markMessagesAsRead(currentChatType, currentCandidate);
        }, 600); // –ó–∞–¥–µ—Ä–∂–∫–∞ —á—É—Ç—å –±–æ–ª—å—à–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∞—à–∫—É "–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
    function showNewMessageBadge(count = 1) {
      const badge = document.getElementById('new-message-badge');
      const text = document.getElementById('new-message-text');
      
      if (count === 1) {
        text.textContent = '‚Üì 1 –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
      } else {
        text.textContent = `‚Üì ${count} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π`;
      }
      
      badge.style.display = 'flex';
    }

    // –°–∫—Ä—ã—Ç—å –ø–ª–∞—à–∫—É "–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
    function hideNewMessageBadge() {
      const badge = document.getElementById('new-message-badge');
      badge.style.display = 'none';
      unreadMessagesCount = 0;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–∏–∑—É —á–∞—Ç–∞
    function isUserAtBottom() {
      const container = document.getElementById('messages-container');
      return container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è –ø–ª–∞—à–∫–∏
    function setupScrollHandler() {
      const container = document.getElementById('messages-container');
      let scrollTimeout;
      
      container.addEventListener('scroll', () => {
        if (isUserAtBottom()) {
          hideNewMessageBadge();
          
          // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
          // —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º —Å–∫—Ä–æ–ª–ª–µ
          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(() => {
            if (currentCandidate && currentChatType) {
              console.log('üìñ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∏—Å—Ç–∞–ª –¥–æ –Ω–∏–∑–∞, –ø–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ');
              markMessagesAsRead(currentChatType, currentCandidate);
            }
          }, 500); // –ó–∞–¥–µ—Ä–∂–∫–∞ 500ms
        }
      });
    }

    // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    async function markMessagesAsRead(type, candidate) {
      try {
        await fetch(`/chat/mark-read/${type}/${encodeURIComponent(candidate)}`, {
          method: 'POST'
        });
        console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Å—á–µ—Ç—á–∏–∫
        await updateChatList(type);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:', error);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
    async function updateChatList(messageType) {
      try {
        console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤...');
        
        // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
        const response = await fetch('/chat/chats-list');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º Telegram —á–∞—Ç—ã (–≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π)
        const telegramChatsContainer = document.getElementById('telegram-chats');
        if (telegramChatsContainer) {
          if (data.telegram_chats && data.telegram_chats.length > 0) {
            renderChatList(telegramChatsContainer, data.telegram_chats, 'telegram');
          } else {
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π
            telegramChatsContainer.innerHTML = '';
          }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º Email —á–∞—Ç—ã (–≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π)
        const emailChatsContainer = document.getElementById('email-chats');
        if (emailChatsContainer) {
          if (data.email_chats && data.email_chats.length > 0) {
            renderChatList(emailChatsContainer, data.email_chats, 'email');
          } else {
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π
            emailChatsContainer.innerHTML = '';
          }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞ —Ç–∞–±–∞—Ö
        updateTabBadges(data.telegram_chats || [], data.email_chats || []);
        
        console.log('‚úÖ –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω');
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤:', error);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –Ω–∞ —Ç–∞–±–∞—Ö
    function updateTabBadges(telegramChats, emailChats) {
      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è Telegram
      const telegramUnreadCount = telegramChats.reduce((sum, chat) => sum + (chat.unread_count || 0), 0);
      const telegramBadge = document.getElementById('telegram-tab-badge');
      
      if (telegramUnreadCount > 0) {
        telegramBadge.textContent = telegramUnreadCount > 99 ? '99+' : telegramUnreadCount;
        telegramBadge.style.display = 'inline-flex';
      } else {
        telegramBadge.style.display = 'none';
      }
      
      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è Email
      const emailUnreadCount = emailChats.reduce((sum, chat) => sum + (chat.unread_count || 0), 0);
      const emailBadge = document.getElementById('email-tab-badge');
      
      if (emailUnreadCount > 0) {
        emailBadge.textContent = emailUnreadCount > 99 ? '99+' : emailUnreadCount;
        emailBadge.style.display = 'inline-flex';
      } else {
        emailBadge.style.display = 'none';
      }
      
      console.log(`üìä –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å—á–µ—Ç—á–∏–∫–∏ —Ç–∞–±–æ–≤: Telegram=${telegramUnreadCount}, Email=${emailUnreadCount}`);
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
    function renderChatList(container, chats, type) {
      container.innerHTML = '';
      
      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        if (currentCandidate === chat.candidate_fullname && currentChatType === type) {
          chatItem.classList.add('active');
        }
        
        chatItem.dataset.candidate = chat.candidate_fullname;
        chatItem.dataset.type = type;
        chatItem.dataset.vacancy = chat.vacancy_id || '';
        chatItem.dataset.vacancyTitle = chat.vacancy_title || '';
        chatItem.dataset.candidateId = chat.candidate_id || '';
        chatItem.onclick = () => openChat(type, chat.candidate_fullname, chat.vacancy_id || '', chat.vacancy_title || '', chatItem);
        
        let vacancyHTML = '';
        if (chat.vacancy_id) {
          vacancyHTML += `<div style="font-size:0.75rem;color:var(--color-accent-gold);font-weight:600;margin:2px 0;">ID: ${chat.vacancy_id}</div>`;
        }
        if (chat.vacancy_title) {
          const truncatedTitle = chat.vacancy_title.length > 40 ? chat.vacancy_title.substring(0, 40) + '...' : chat.vacancy_title;
          vacancyHTML += `<div style="font-size:0.75rem;color:var(--color-text-primary);opacity:0.9;margin:2px 0 4px 0;">${truncatedTitle}</div>`;
        }
        
        const unreadBadge = chat.unread_count > 0 ? `<span class="chat-item-badge">${chat.unread_count}</span>` : '';
        const timestamp = chat.last_timestamp ? chat.last_timestamp.substring(0, 16) : '';
        
        // –£–º–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é —Å–æ–æ–±—â–µ–Ω–∏—è
        let previewText = '';
        if (chat.last_message) {
          const maxLength = 70;
          if (chat.last_message.length > maxLength) {
            previewText = chat.last_message.substring(0, maxLength) + '...';
          } else {
            previewText = chat.last_message;
          }
        } else {
          previewText = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
        }
        
        chatItem.innerHTML = `
          <div class="chat-item-header">
            <span class="chat-item-name">${chat.candidate_fullname}</span>
            <div class="chat-item-actions">
              <button class="chat-item-delete" 
                      onclick="event.stopPropagation(); deleteDialog('${type}', '${chat.candidate_fullname}')" 
                      title="–£–¥–∞–ª–∏—Ç—å –¥–∏–∞–ª–æ–≥">üóëÔ∏è</button>
              <span class="chat-item-time">${timestamp}</span>
            </div>
          </div>
          ${vacancyHTML}
          <div class="chat-item-preview">
            <span class="preview-text">${previewText}</span>
            ${unreadBadge}
          </div>
        `;
        
        container.appendChild(chatItem);
      });
    }

    // WebSocket –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/chat/ws/${userId}`);

      ws.onopen = () => {
        console.log('‚úÖ [CHAT_WS] WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —á–∞—Ç—É');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        setInterval(() => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send('ping');
          }
        }, 30000);
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('üì® [CHAT_WS] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
        if (data.type === 'new_message') {
          const msg = data.message;
          const messageType = msg.message_type;
          
          console.log(`üì¨ [CHAT_WS] –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${msg.candidate_fullname} (${messageType})`);
          
          // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π —á–∞—Ç - –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ UI
          if (currentCandidate === msg.candidate_fullname && currentChatType === messageType) {
            console.log('‚úÖ [CHAT_WS] –≠—Ç–æ —Ç–µ–∫—É—â–∏–π —á–∞—Ç! –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ UI...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–∏–∑—É
            const wasAtBottom = isUserAtBottom();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ UI
            addMessageToUI(msg);
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤–Ω–∏–∑—É - —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—Ç–∏—Ç –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ)
            if (wasAtBottom) {
              setTimeout(() => {
                scrollToBottom();
              }, 100);
            } else {
              // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤–Ω–∏–∑—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É "–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
              unreadMessagesCount++;
              showNewMessageBadge(unreadMessagesCount);
              console.log(`üì¨ [CHAT_WS] –ü–æ–∫–∞–∑–∞–Ω–∞ –ø–ª–∞—à–∫–∞: ${unreadMessagesCount} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π`);
            }
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å)
          updateChatList(messageType);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ pong (–æ—Ç–≤–µ—Ç –Ω–∞ ping)
        if (data.type === 'pong') {
          console.log('üèì [CHAT_WS] Pong –ø–æ–ª—É—á–µ–Ω');
        }
      };

      ws.onerror = (error) => {
        console.error('‚ùå [CHAT_WS] WebSocket –æ—à–∏–±–∫–∞:', error);
      };

      ws.onclose = () => {
        console.log('üîå [CHAT_WS] WebSocket –æ—Ç–∫–ª—é—á–µ–Ω, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫...');
        setTimeout(connectWebSocket, 5000);
      };
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
    function addMessageToUI(msg) {
      const container = document.getElementById('messages-container');
      const messageDiv = document.createElement('div');
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
      let messageClasses = `message ${msg.sender}`;
      if (msg.sender === 'candidate' && !msg.is_read) {
        messageClasses += ' unread';
      }
      messageDiv.className = messageClasses;
      messageDiv.dataset.messageId = msg.id;
      
      const avatar = msg.sender === 'user' ? '–Ø' : (msg.candidate_fullname ? msg.candidate_fullname[0].toUpperCase() : '?');
      
      let mediaHTML = '';
      if (msg.has_media && msg.media_path) {
        if (msg.media_type === 'photo') {
          mediaHTML = `
            <div class="message-media">
              <a href="${msg.media_path}" target="_blank">
                <img src="${msg.media_path}" alt="–§–æ—Ç–æ" style="max-width:300px;max-height:300px;border-radius:8px;cursor:pointer;">
              </a>
            </div>
          `;
        } else {
          const icon = msg.media_type === 'video' ? 'üé•' : msg.media_type === 'audio' ? 'üéµ' : 'üìé';
          mediaHTML = `
            <div class="message-media">
              <a href="${msg.media_path}" download="${msg.media_filename}" class="media-download-link">
                ${icon} ${msg.media_filename || '–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª'}
              </a>
            </div>
          `;
        }
      }
      
      // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
          const unreadIndicator = (msg.sender === 'candidate' && !msg.is_read) ? 
        '<span style="color:#E74C3C;font-weight:bold;margin-left:8px;text-shadow:0 0 10px rgba(231,76,60,0.5);" title="–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ">‚óè</span>' : '';
      
      messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
          ${msg.message_text ? `<div class="message-bubble">${escapeHtml(msg.message_text)}</div>` : ''}
          ${mediaHTML}
          <div class="message-time">
            ${formatTime(msg.timestamp)}
            ${unreadIndicator}
          </div>
        </div>
      `;
      
      container.appendChild(messageDiv);
      console.log('‚úÖ [CHAT_WS] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ UI');
    }

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    connectWebSocket();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞
    setupScrollHandler();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞ —Ç–∞–±–∞—Ö
    (async function initTabBadges() {
      try {
        const response = await fetch('/chat/chats-list');
        if (response.ok) {
          const data = await response.json();
          updateTabBadges(data.telegram_chats || [], data.email_chats || []);
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤ —Ç–∞–±–æ–≤:', error);
      }
    })();

    // === Polling (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –æ—Ç–∫–ª—é—á–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WebSocket) ===
    let pollingInterval = null;

    function startPolling() {
      // Polling –æ—Ç–∫–ª—é—á–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WebSocket
      console.log('‚ÑπÔ∏è Polling –æ—Ç–∫–ª—é—á–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WebSocket –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π');
      return;
      
      /* –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WebSocket
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }

      pollingInterval = setInterval(() => {
        // 1. –ï—Å–ª–∏ —á–∞—Ç –æ—Ç–∫—Ä—ã—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–æ—Ö—Ä–∞–Ω—è—è —Å–∫—Ä–æ–ª–ª!)
        if (currentCandidate && currentChatType) {
          // console.log('üîÑ Polling: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –≤ –∫–æ–Ω—Å–æ–ª—å
          loadMessages(currentChatType, currentCandidate, true); // true = preserveScroll
        }

        // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (—á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Ç–∞—Ö)
        // –ë–µ—Ä–µ–º —Ç–∏–ø —á–∞—Ç–∞ –∏–∑ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
        const activeTab = document.querySelector('.chat-tab.active');
        if (activeTab) {
           updateChatList(activeTab.dataset.type);
        }
      }, 3000); // –ö–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
      */
    }

    // Polling –æ—Ç–∫–ª—é—á–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WebSocket
    // startPolling();

    async function loadMessages(type, candidate, preserveScroll = false, markRead = true) {
      try {
        const container = document.getElementById('messages-container');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
        const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
        const oldScrollHeight = container.scrollHeight;
        const oldScrollTop = container.scrollTop;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä mark_read
        const url = `/chat/messages/${type}/${encodeURIComponent(candidate)}?mark_read=${markRead}`;
        const response = await fetch(url);
        const data = await response.json();

        container.innerHTML = '';

        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => {
            const messageDiv = document.createElement('div');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            let messageClasses = `message ${msg.sender}`;
            if (msg.sender === 'candidate' && !msg.is_read) {
              messageClasses += ' unread';
            }
            messageDiv.className = messageClasses;

            const initials = candidate.split(' ').map(n => n[0]).join('').toUpperCase();
            const avatar = msg.sender === 'user' ? '–Ø' : initials;

            let mediaHTML = '';
            if (msg.has_media && msg.media_path) {
              if (msg.media_type === 'photo') {
                mediaHTML = `
                  <div class="message-media">
                    <a href="${msg.media_path}" target="_blank">
                      <img src="${msg.media_path}" alt="–§–æ—Ç–æ" style="max-width:300px;max-height:300px;border-radius:8px;cursor:pointer;">
                    </a>
                  </div>
                `;
              } else {
                const icon = msg.media_type === 'video' ? 'üé•' : msg.media_type === 'audio' ? 'üéµ' : 'üìé';
                mediaHTML = `
                  <div class="message-media">
                    <a href="${msg.media_path}" download="${msg.media_filename}" class="media-download-link">
                      ${icon} ${msg.media_filename || '–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª'}
                    </a>
                  </div>
                `;
              }
            }

            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
          const unreadIndicator = (msg.sender === 'candidate' && !msg.is_read) ? 
        '<span style="color:#E74C3C;font-weight:bold;margin-left:8px;text-shadow:0 0 10px rgba(231,76,60,0.5);" title="–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ">‚óè</span>' : '';

            messageDiv.innerHTML = `
              <div class="message-avatar">${avatar}</div>
              <div class="message-content">
                ${msg.message_text ? `<div class="message-bubble">${escapeHtml(msg.message_text)}</div>` : ''}
                ${mediaHTML}
                <div class="message-time">
                  ${formatTime(msg.timestamp)}
                  ${unreadIndicator}
                </div>
              </div>
            `;
            
            messageDiv.dataset.messageId = msg.id;

            container.appendChild(messageDiv);
          });

          // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–æ–º
          if (preserveScroll) {
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
            if (wasAtBottom) {
              // –ï—Å–ª–∏ –±—ã–ª –≤–Ω–∏–∑—É - —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑
              container.scrollTop = container.scrollHeight;
            } else {
              // –ï—Å–ª–∏ –±—ã–ª –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
              const newScrollHeight = container.scrollHeight;
              const scrollDiff = newScrollHeight - oldScrollHeight;
              container.scrollTop = oldScrollTop + scrollDiff;
            }
          } else {
            // –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ - —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑
            container.scrollTop = container.scrollHeight;
          }
        } else {
          container.innerHTML = '<div style="text-align:center;color:var(--color-text-primary);opacity:0.8;padding:40px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
      }
    }

    async function deleteDialog(messageType, candidateFullname) {
      console.log(`üóëÔ∏è [DELETE] –í—ã–∑–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è deleteDialog: type=${messageType}, candidate=${candidateFullname}`);
      
      if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–∏–∞–ª–æ–≥ —Å ${candidateFullname}?\n\n–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.`)) {
        console.log(`üóëÔ∏è [DELETE] –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º`);
        return;
      }

      try {
        const url = `/chat/delete-dialog/${messageType}/${encodeURIComponent(candidateFullname)}`;
        console.log(`üóëÔ∏è [DELETE] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞: ${url}`);
        
        const response = await fetch(url, {
          method: 'DELETE',
        });

        console.log(`üóëÔ∏è [DELETE] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error(`üóëÔ∏è [DELETE] –û—à–∏–±–∫–∞ HTTP ${response.status}: ${errorText}`);
          alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${response.status}`);
          return;
        }

        const data = await response.json();
        console.log(`üóëÔ∏è [DELETE] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:`, data);

        if (data.success) {
          console.log(`‚úÖ [DELETE] –î–∏–∞–ª–æ–≥ —É–¥–∞–ª–µ–Ω: ${data.message}`);
          
          // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º –¥–∏–∞–ª–æ–≥ –∏–∑ DOM
          const chatItems = document.querySelectorAll('.chat-item');
          chatItems.forEach(item => {
            if (item.dataset.candidate === candidateFullname && item.dataset.type === messageType) {
              console.log(`üóëÔ∏è [DELETE] –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM`);
              item.remove();
            }
          });
          
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
          if (currentCandidate === candidateFullname && currentChatType === messageType) {
            console.log(`üóëÔ∏è [DELETE] –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–π —á–∞—Ç`);
            currentCandidate = null;
            currentChatType = null;
            currentVacancyId = null;
            currentVacancyTitle = null;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ –∏—Ö —Å–≤–æ–π—Å—Ç–≤–∞–º
            const chatWindow = document.getElementById('chat-window');
            const chatPlaceholder = document.getElementById('chat-placeholder');
            
            if (chatWindow) {
              chatWindow.style.display = 'none';
            }
            if (chatPlaceholder) {
              chatPlaceholder.style.display = 'flex';
            }
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
          console.log(`üóëÔ∏è [DELETE] –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤`);
          await updateChatList(messageType);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞ —Ç–∞–±–∞—Ö
          const response = await fetch('/chat/chats-list');
          if (response.ok) {
            const chatData = await response.json();
            updateTabBadges(chatData.telegram_chats || [], chatData.email_chats || []);
          }
          
          alert(`‚úÖ –î–∏–∞–ª–æ–≥ —Å ${candidateFullname} —É–¥–∞–ª–µ–Ω`);
        } else {
          console.error(`üóëÔ∏è [DELETE] –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª success=false`);
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞');
        }
      } catch (error) {
        console.error('‚ùå [DELETE] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ:', error);
        console.error('‚ùå [DELETE] Stack:', error.stack);
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞: ${error.message}`);
      }
    }

    async function sendMessage(event) {
      event.preventDefault();

      if (!currentCandidate) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');
        return;
      }

      const input = document.getElementById('message-input');
      const messageText = input.value.trim();

      if (!messageText) return;

      const sendBtn = document.getElementById('send-btn');
      sendBtn.disabled = true;
      sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

      try {
        const formData = new FormData();
        formData.append('candidate_fullname', currentCandidate);
        formData.append('message_type', currentChatType);
        formData.append('message_text', messageText);
        if (currentVacancyId) {
          formData.append('vacancy_id', currentVacancyId);
        }

        const response = await fetch('/chat/send', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
          input.value = '';
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É textarea
          input.style.height = 'auto';

          // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ UI –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
          const container = document.getElementById('messages-container');
          const messageDiv = document.createElement('div');
          messageDiv.className = 'message user';

          messageDiv.innerHTML = `
            <div class="message-avatar">–Ø</div>
            <div class="message-content">
              <div class="message-bubble">${escapeHtml(messageText)}</div>
              <div class="message-time">${formatTime(new Date().toISOString())}</div>
            </div>
          `;

          container.appendChild(messageDiv);
          
          // –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑
          container.scrollTop = container.scrollHeight;
        } else {
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
      }
    }

    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;

      // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è
      if (diff < 86400000 && date.getDate() === now.getDate()) {
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      }

      // –ï—Å–ª–∏ –≤—á–µ—Ä–∞
      if (diff < 172800000 && date.getDate() === now.getDate() - 1) {
        return '–í—á–µ—Ä–∞ ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      }

      // –ò–Ω–∞—á–µ –ø–æ–ª–Ω–∞—è –¥–∞—Ç–∞
      return date.toLocaleString('ru-RU', { 
        day: '2-digit', 
        month: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
    document.getElementById('message-input').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
    document.getElementById('message-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
        document.getElementById('message-form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
      }
    });

    // ==================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ß–ê–¢–û–í ====================

    async function openAddChatModal() {
      const modal = document.getElementById('add-chat-modal');
      const modalActions = document.getElementById('modal-actions');
      
      modal.classList.add('active');
      
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –≤–∏–¥–Ω–∞ —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      if (modalActions) {
        modalActions.style.display = 'flex';
        modalActions.style.visibility = 'visible';
        modalActions.style.opacity = '1';
        updateSelectedCount(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
      await loadTelegramDialogs();
    }

    function closeAddChatModal() {
      const modal = document.getElementById('add-chat-modal');
      modal.classList.remove('active');
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('add-chat-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeAddChatModal();
      }
    });

    async function loadTelegramDialogs() {
      const container = document.getElementById('dialog-list-container');
      const modalActions = document.getElementById('modal-actions');
      
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –≤–∏–¥–Ω–∞ —Å—Ä–∞–∑—É
      if (modalActions) {
        modalActions.style.display = 'flex';
        modalActions.style.visibility = 'visible';
        modalActions.style.opacity = '1';
      }
      
      container.innerHTML = '<div class="loading-spinner">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤...</div>';
      
      try {
        const response = await fetch('/chat/telegram-dialogs');
        
        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤');
        }
        
        const data = await response.json();
        
        if (!data.dialogs || data.dialogs.length === 0) {
          container.innerHTML = '<div class="loading-spinner">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤</div>';
          // –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º–æ–π
          if (modalActions) {
            modalActions.style.display = 'flex';
          }
          updateSelectedCount();
          return;
        }
        
        renderDialogs(data.dialogs);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤:', error);
        container.innerHTML = `
          <div class="loading-spinner" style="color:#E74C3C;">
            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤<br>
            <span style="font-size:0.85rem;">${error.message}</span>
          </div>
        `;
        // –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º–æ–π –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (modalActions) {
          modalActions.style.display = 'flex';
        }
        updateSelectedCount();
      }
    }

    let selectedDialogs = new Set(); // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
    let allDialogs = []; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

    function renderDialogs(dialogs) {
      allDialogs = dialogs; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø–æ–∏—Å–∫–∞
      const container = document.getElementById('dialog-list-container');
      const modalActions = document.getElementById('modal-actions');
      
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞
      if (modalActions) {
        modalActions.style.display = 'flex';
        modalActions.style.visibility = 'visible';
        modalActions.style.opacity = '1';
      }
      
      selectedDialogs.clear(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      updateSelectedCount();
      
      if (dialogs.length === 0) {
        container.innerHTML = '<div class="loading-spinner">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤</div>';
        // –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞, –Ω–æ –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
        if (modalActions) {
          modalActions.style.display = 'flex';
        }
        updateSelectedCount();
        return;
      }
      
      const html = `
        <div class="dialog-list">
          ${dialogs.map(dialog => `
            <div class="dialog-item" id="dialog-${dialog.id}" data-chat-id="${dialog.id}">
              <input 
                type="checkbox" 
                class="dialog-checkbox" 
                id="checkbox-${dialog.id}"
                onchange="toggleDialogSelection(${dialog.id})"
              >
              <div class="dialog-avatar">
                ${dialog.initials || 'üë§'}
              </div>
              <div class="dialog-info" style="flex:1;">
                <div class="dialog-name">${escapeHtml(dialog.name)}</div>
                ${dialog.username ? `<div class="dialog-username">@${escapeHtml(dialog.username)}</div>` : ''}
              </div>
              <input 
                type="text" 
                class="dialog-input" 
                id="candidate-name-${dialog.id}" 
                placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ"
                value="${escapeHtml(dialog.name)}"
                style="flex:1;max-width:300px;"
              >
            </div>
          `).join('')}
        </div>
      `;
      
      container.innerHTML = html;
      
      // –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
      if (modalActions) {
        modalActions.style.display = 'flex';
        modalActions.style.visibility = 'visible';
        modalActions.style.opacity = '1';
      }
      
      updateSelectedCount();
    }

    function toggleDialogSelection(dialogId) {
      const checkbox = document.getElementById(`checkbox-${dialogId}`);
      const dialogItem = document.getElementById(`dialog-${dialogId}`);
      
      if (checkbox.checked) {
        selectedDialogs.add(dialogId);
        dialogItem.classList.add('selected');
      } else {
        selectedDialogs.delete(dialogId);
        dialogItem.classList.remove('selected');
      }
      
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const count = selectedDialogs.size;
      document.getElementById('selected-count-text').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;
      
      const addBtn = document.querySelector('.btn-add-selected');
      const hideBtn = document.querySelector('.btn-hide-selected');
      
      if (addBtn) addBtn.disabled = count === 0;
      if (hideBtn) hideBtn.disabled = count === 0;
    }

    async function addSelectedDialogs() {
      if (selectedDialogs.size === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–∏–∞–ª–æ–≥');
        return;
      }

      const dialogs = [];
      let hasEmptyName = false;

      for (const dialogId of selectedDialogs) {
        const nameInput = document.getElementById(`candidate-name-${dialogId}`);
        const candidateName = nameInput ? nameInput.value.trim() : '';
        
        if (!candidateName) {
          hasEmptyName = true;
          continue;
        }

        dialogs.push({
          telegram_chat_id: dialogId,
          candidate_fullname: candidateName
        });
      }

      if (hasEmptyName) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤');
        return;
      }

      if (dialogs.length === 0) {
        alert('–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        return;
      }

      const addBtn = document.querySelector('.btn-add-selected');
      addBtn.disabled = true;
      addBtn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';

      try {
        const response = await fetch('/chat/add-telegram-dialogs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ dialogs }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }

        const data = await response.json();
        
        if (data.success) {
          alert(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${data.added_count} –¥–∏–∞–ª–æ–≥–æ–≤${data.errors.length > 0 ? `\n–û—à–∏–±–æ–∫: ${data.errors.length}` : ''}`);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
          await updateChatList('telegram');
          closeAddChatModal();
        } else {
          alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤:', error);
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
      } finally {
        addBtn.disabled = false;
        addBtn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
      }
    }

    async function hideSelectedDialogs() {
      if (selectedDialogs.size === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–∏–∞–ª–æ–≥');
        return;
      }

      if (!confirm(`–°–∫—Ä—ã—Ç—å ${selectedDialogs.size} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤? –û–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ.`)) {
        return;
      }

      const hideBtn = document.querySelector('.btn-hide-selected');
      hideBtn.disabled = true;
      hideBtn.textContent = '–°–∫—Ä—ã—Ç–∏–µ...';

      try {
        const response = await fetch('/chat/hide-telegram-dialogs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ chat_ids: Array.from(selectedDialogs) }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–∫—Ä—ã—Ç–∏—è');
        }

        const data = await response.json();
        
        if (data.success) {
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤
          await loadTelegramDialogs();
        } else {
          alert('–û—à–∏–±–∫–∞ —Å–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–æ–≤');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–æ–≤:', error);
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
      } finally {
        hideBtn.disabled = false;
        hideBtn.textContent = 'üóëÔ∏è –°–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
      }
    }


    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
    function filterDialogs(searchQuery) {
      const query = searchQuery.toLowerCase().trim();
      const clearBtn = document.querySelector('.dialog-search-clear');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
      if (query) {
        clearBtn.classList.add('visible');
      } else {
        clearBtn.classList.remove('visible');
      }
      
      const dialogItems = document.querySelectorAll('.dialog-item');
      let visibleCount = 0;
      
      dialogItems.forEach(item => {
        const dialogId = parseInt(item.dataset.chatId);
        const dialog = allDialogs.find(d => d.id === dialogId);
        
        if (!dialog) {
          item.classList.add('hidden');
          return;
        }
        
        // –ò—â–µ–º –ø–æ –∏–º–µ–Ω–∏ –∏ username
        const name = (dialog.name || '').toLowerCase();
        const username = (dialog.username || '').toLowerCase();
        
        if (name.includes(query) || username.includes(query)) {
          item.classList.remove('hidden');
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
      const container = document.getElementById('dialog-list-container');
      let noResultsMsg = container.querySelector('.no-results-message');
      
      if (visibleCount === 0 && query) {
        if (!noResultsMsg) {
          noResultsMsg = document.createElement('div');
          noResultsMsg.className = 'no-results-message';
          noResultsMsg.textContent = 'üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
          container.appendChild(noResultsMsg);
        }
      } else {
        if (noResultsMsg) {
          noResultsMsg.remove();
        }
      }
      
      console.log(`üîç –ü–æ–∏—Å–∫ "${query}": –Ω–∞–π–¥–µ–Ω–æ ${visibleCount} –∏–∑ ${dialogItems.length} –¥–∏–∞–ª–æ–≥–æ–≤`);
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–∏—Å–∫–∞
    function clearDialogSearch() {
      const searchInput = document.getElementById('dialog-search-input');
      searchInput.value = '';
      filterDialogs('');
      searchInput.focus();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
    async function markChatAsUnread(event) {
      if (!currentCandidate || !currentChatType) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');
        return;
      }

      const btn = event.target;
      const originalText = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';

        const response = await fetch(`/chat/mark-unread/${currentChatType}/${encodeURIComponent(currentCandidate)}`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ –∫–∞–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ');
        }

        const data = await response.json();
        
        if (data.success) {
          if (data.count > 0) {
            console.log(`‚úÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${currentCandidate} –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ`);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ë–ï–ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
            await loadMessages(currentChatType, currentCandidate, true, false);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            await updateChatList(currentChatType);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            btn.innerHTML = '‚úì –ü–æ–º–µ—á–µ–Ω–æ';
            
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.disabled = false;
            }, 2000);
          } else {
            alert('–ù–µ—Ç –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–º–µ—Ç–∫–∏');
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ –∫–∞–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  switchTab('telegram');
</script>
{% endblock %}

