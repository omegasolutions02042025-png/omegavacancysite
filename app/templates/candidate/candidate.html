{% extends "layouts/base.html" %}

{% block title %}–ú–æ–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã ‚Äî Omega Hire{% endblock %}

{% block head %}
<style>
  .candidates-page {
    max-width: 1400px;
    margin: 0 auto;
  }

  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .candidates-count {
    background: var(--color-bg-surface);
    padding: 10px 18px;
    border-radius: 12px;
    color: var(--color-text-heading);
    font-size: 0.95rem;
    font-weight: 500;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .filters-card {
    margin-bottom: 24px;
  }

  .filters-form {
    display: flex;
    gap: 20px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .filter-group {
    flex: 1;
    min-width: 200px;
  }

  .filter-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .candidates-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .candidate-item {
    padding: 24px;
    margin-bottom: 16px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    background: var(--color-bg-surface);
    transition: all 0.2s;
    border-left: 3px solid transparent;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .candidate-item:hover {
    background-color: rgba(255, 255, 255, 0.03);
    border-left-color: var(--color-accent-gold);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }

  .candidate-item:last-child {
    margin-bottom: 0;
  }

  .candidate-left {
    display: flex;
    align-items: flex-start;
    gap: 20px;
    flex: 1;
    min-width: 0;
  }

  .candidate-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--color-bg-surface-2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-heading);
    flex-shrink: 0;
    overflow: hidden;
    position: relative;
  }

  .candidate-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
  }

  .candidate-avatar.has-photo img {
    display: block;
  }

  .candidate-info {
    flex: 1;
    min-width: 0;
  }

  .candidate-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-text-heading);
    margin: 0 0 6px;
  }

  .candidate-position {
    font-size: 0.95rem;
    color: var(--color-text-primary);
    margin: 0 0 8px;
  }

  .candidate-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }

  .empty-state {
    padding: 80px 40px;
    text-align: center;
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 20px;
  }

  .empty-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-heading);
    margin: 0 0 12px;
  }

  .empty-text {
    font-size: 1rem;
    color: var(--color-text-muted);
    margin: 0 0 24px;
  }

  .candidate-rate-block {
    background: rgba(255, 215, 0, 0.1);
    border: 1px solid rgba(255, 215, 0, 0.2);
  }

  .candidate-rate-chip {
    background: rgba(255, 255, 255, 0.15);
    color: var(--color-text-heading);
    font-weight: 600;
    border: 1px solid rgba(255, 215, 0, 0.3);
  }

  @media (max-width: 768px) {
    .candidate-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .candidate-actions {
      width: 100%;
      justify-content: space-between;
    }
    
    .filters-form {
      flex-direction: column;
      gap: 16px;
    }
    
    .filter-group {
      width: 100%;
      min-width: 100%;
    }
    
    .filters-card .d-flex {
      width: 100%;
    }
    
    .filters-card .btn {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="candidates-page">
  <header class="page-header">
    <h1 class="h2 mb-0">üë• –ú–æ–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã</h1>
    <div class="d-flex align-items-center gap-3">
      <div class="candidates-count">
        {{ candidates|length if candidates is defined else 0 }} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
      </div>
      <a href="/candidate/add" class="btn btn-primary">
        <i class="bi bi-plus-lg me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
      </a>
    </div>
  </header>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="card filters-card">
    <form id="filter-form" method="get" action="/candidate" class="filters-form">
      <div class="filter-group">
        <label for="search-input" class="filter-label">üîç –ü–æ–∏—Å–∫</label>
        <input
          type="text"
          id="search-input"
          name="search"
          class="form-input"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏..."
          value="{{ current_search }}"
        >
      </div>
      <div class="filter-group">
        <label for="specialization-select" class="filter-label">üéØ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</label>
        <select
          id="specialization-select"
          name="specialization"
          class="form-input"
        >
          <option value="">–í—Å–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</option>
          {% for spec in specializations %}
            <option value="{{ spec }}" {% if current_specialization == spec %}selected{% endif %}>
              {{ spec }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label for="grade-select" class="filter-label">üìä –ì—Ä–µ–π–¥</label>
        <select
          id="grade-select"
          name="grade"
          class="form-input"
        >
          <option value="">–í—Å–µ –≥—Ä–µ–π–¥—ã</option>
          <option value="Junior">Junior</option>
          <option value="Junior+">Junior+</option>
          <option value="Middle">Middle</option>
          <option value="Middle+">Middle+</option>
          <option value="Senior">Senior</option>
          <option value="Senior+">Senior+</option>
          <option value="Lead">Lead</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="work_format-select" class="filter-label">üíº –§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã</label>
        <select
          id="work_format-select"
          name="work_format"
          class="form-input"
        >
          <option value="">–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</option>
          <option value="office">Office</option>
          <option value="remote">Remote</option>
          <option value="hybrid">Hybrid</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="employment_type-select" class="filter-label">‚è∞ –¢–∏–ø –∑–∞–Ω—è—Ç–æ—Å—Ç–∏</label>
        <select
          id="employment_type-select"
          name="employment_type"
          class="form-input"
        >
          <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
          <option value="full-time">Full-time</option>
          <option value="part-time">Part-time</option>
          <option value="project">Project</option>
          <option value="internship">Internship</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="english_level-select" class="filter-label">üåê –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</label>
        <select
          id="english_level-select"
          name="english_level"
          class="form-input"
        >
          <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
          <option value="A1">A1</option>
          <option value="A2">A2</option>
          <option value="B1">B1</option>
          <option value="B2">B2</option>
          <option value="C1">C1</option>
          <option value="C2">C2</option>
        </select>
      </div>
      <div class="d-flex align-items-end">
        <a href="/candidate" class="btn btn-secondary">
          <i class="bi bi-arrow-clockwise me-2"></i>–°–±—Ä–æ—Å–∏—Ç—å
        </a>
      </div>
    </form>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ -->
  <div class="card">
    {% if candidates and candidates|length > 0 %}
      <div class="table-container">
        <ul class="candidates-list">
          {% for item in candidates %}
            {% set c = item.candidate %}
            {% set completeness = item.completeness %}
            <li class="candidate-item">
              <div class="d-flex align-items-start justify-content-between gap-4 flex-wrap">
                <div class="candidate-left">
                  <div class="candidate-avatar {% if c.photo_path %}has-photo{% endif %}">
                    {% if c.photo_path %}
                      <img src="{{ c.photo_path }}" alt="{{ c.first_name or '' }} {{ c.last_name or '' }}" onerror="this.style.display='none'; this.parentElement.classList.remove('has-photo');">
                    {% endif %}
                    {% set initials = (c.first_name[0] if c.first_name else "") ~ (c.last_name[0] if c.last_name else "") %}
                    <span {% if c.photo_path %}style="display:none;"{% endif %}>{{ initials if initials else "üë§" }}</span>
                  </div>
                  <div class="candidate-info">
                    <h3 class="candidate-name">
                      {% if c.first_name and c.last_name and c.middle_name %}
                        {{ c.first_name ~ " " ~ c.last_name ~ " " ~ c.middle_name }}
                      {% elif c.first_name and c.last_name %}
                        {{ c.first_name ~ " " ~ c.last_name }}
                      {% else %}
                        {{ c.first_name or c.last_name or "–ë–µ–∑ –∏–º–µ–Ω–∏" }}
                      {% endif %}
                    </h3>
                    {% if c.title %}
                      <p class="candidate-position">{{ c.title }}</p>
                    {% endif %}
                    
                    <!-- –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ -->
                    {% if c.specializations %}
                    <div class="d-flex gap-2 flex-wrap align-items-center mb-2">
                      {% set specs = c.specializations.split(',') %}
                      {% for spec in specs %}
                        <span class="chip chip-neutral">{{ spec.strip() }}</span>
                      {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- –°–∫–∏–ª–ª—ã -->
                    {% if c.skills %}
                    <div class="d-flex gap-2 flex-wrap align-items-center mb-2">
                      {% set skills_list = c.skills.split(',') %}
                      {% for skill in skills_list[:5] %}
                        <span class="chip chip-neutral" style="font-size: 0.75rem;">{{ skill.strip() }}</span>
                      {% endfor %}
                      {% if skills_list|length > 5 %}
                        <span class="chip chip-neutral" style="font-size: 0.75rem;">+{{ skills_list|length - 5 }}</span>
                      {% endif %}
                    </div>
                    {% endif %}

                    <!-- –°—Ç–∞—Ç—É—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ -->
                    <div class="d-flex gap-2 flex-wrap align-items-center mb-2">
                      {% if completeness == "complete" %}
                        <span class="chip chip-success">
                          <i class="bi bi-check-circle me-1"></i>–í—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
                        </span>
                      {% elif completeness == "incomplete" %}
                        <span class="chip chip-warning">
                          <i class="bi bi-exclamation-triangle me-1"></i>–ï—Å—Ç—å –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è
                        </span>
                      {% endif %}
                    </div>
                    
                    <!-- –°—Ç–∞—Ç—É—Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ -->
                    {% if c.status %}
                    <div class="d-flex gap-2 flex-wrap align-items-center mb-2">
                      {% if c.status == "–í –∞–∫—Ç–∏–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ" %}
                        <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                          <i class="bi bi-search me-1"></i>–í –∞–∫—Ç–∏–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ
                        </span>
                      {% elif c.status == "–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è" %}
                        <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                          <i class="bi bi-eye me-1"></i>–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                        </span>
                      {% elif c.status == "–ù–µ –∏—â–µ—Ç —Ä–∞–±–æ—Ç—É" %}
                        <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                          <i class="bi bi-pause-circle me-1"></i>–ù–µ –∏—â–µ—Ç —Ä–∞–±–æ—Ç—É
                        </span>
                      {% elif c.status == "–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω" %}
                        <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                          <i class="bi bi-clock me-1"></i>–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
                          {% if c.status_until %}
                            <span style="font-size: 0.85em; opacity: 0.9;">(–¥–æ {{ c.status_until[:10] }})</span>
                          {% endif %}
                        </span>
                      {% else %}
                        <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                          {{ c.status }}
                        </span>
                      {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
                    <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
                      {% if c.email %}
                        <div class="d-flex align-items-center gap-2 bg-surface p-2 rounded" style="font-size: 0.85rem;">
                          <i class="bi bi-envelope text-gold"></i>
                          <span>{{ c.email }}</span>
                          <button 
                            class="btn btn-ghost btn-sm p-1" 
                            style="font-size: 0.75rem;"
                            data-candidate-id="{{ c.number_for_user }}"
                            data-message-type="email"
                            onclick="addChat(this)"
                            title="–°–æ–∑–¥–∞—Ç—å —á–∞—Ç (Email)">
                            <b>+ –ß–∞—Ç</b>
                          </button>
                        </div>
                      {% endif %}
                      
                      {% if c.telegram %}
                        <div class="d-flex align-items-center gap-2 bg-surface p-2 rounded" style="font-size: 0.85rem;">
                          <i class="bi bi-telegram text-gold"></i>
                          <span>{{ c.telegram }}</span>
                          <button 
                            class="btn btn-ghost btn-sm p-1" 
                            style="font-size: 0.75rem;"
                            data-candidate-id="{{ c.number_for_user }}"
                            data-message-type="telegram"
                            onclick="addChat(this)"
                            title="–°–æ–∑–¥–∞—Ç—å —á–∞—Ç (Telegram)">
                            <b>+ –ß–∞—Ç</b>
                          </button>
                        </div>
                      {% endif %}

                      {% if c.phone %}
                        <div class="d-flex align-items-center gap-2 bg-surface p-2 rounded" 
                             style="font-size: 0.85rem; cursor: pointer;" 
                             onclick="copyToClipboard('{{ c.phone }}', this)" 
                             title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                          <i class="bi bi-telephone text-gold"></i>
                          <span>{{ c.phone }}</span>
                        </div>
                      {% endif %}
                    </div>

                    <!-- –°—Ç–∞–≤–∫–∞ -->
                    {% if c.base_rate_amount is not none or c.rate_rub is not none or c.rate_usd is not none or c.rate_eur is not none or c.rate_byn is not none or c.salary_usd is not none %}
                    <div class="mt-3 p-2 rounded candidate-rate-block">
                      <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-currency-exchange text-gold" style="font-size: 1.1rem;"></i>
                        <strong class="text-gold" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">–°—Ç–∞–≤–∫–∞</strong>
                      </div>
                      <div class="d-flex gap-2 flex-wrap">
                        {% if c.rate_rub is not none %}
                          <span class="chip candidate-rate-chip">
                            ‚ÇΩ {{ c.rate_rub|round|int }} RUB
                          </span>
                        {% endif %}
                        {% if c.rate_usd is not none %}
                          <span class="chip candidate-rate-chip">
                            $ {{ c.rate_usd|round|int }} USD
                          </span>
                        {% elif c.salary_usd is not none %}
                          <span class="chip candidate-rate-chip">
                            $ {{ c.salary_usd|round|int }} USD
                          </span>
                        {% endif %}
                        {% if c.rate_eur is not none %}
                          <span class="chip candidate-rate-chip">
                            ‚Ç¨ {{ c.rate_eur|round|int }} EUR
                          </span>
                        {% endif %}
                        {% if c.rate_byn is not none %}
                          <span class="chip candidate-rate-chip">
                            Br {{ c.rate_byn|round|int }} BYN
                          </span>
                        {% endif %}
                        {% if c.base_rate_amount is not none and c.base_rate_currency and c.rate_rub is none and c.rate_usd is none and c.rate_eur is none and c.rate_byn is none and c.salary_usd is none %}
                          <span class="chip candidate-rate-chip">
                            {% if c.base_rate_currency == "RUB" %}‚ÇΩ{% elif c.base_rate_currency == "USD" %}${% elif c.base_rate_currency == "EUR" %}‚Ç¨{% elif c.base_rate_currency == "BYN" %}Br{% endif %}
                            {{ c.base_rate_amount|round|int }} {{ c.base_rate_currency }}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                    {% endif %}
                  </div>
                </div>
                <div class="candidate-actions">
                  <a href="/candidate/open/{{ c.number_for_user }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-eye me-1"></i>–û—Ç–∫—Ä—ã—Ç—å
                  </a>
                  <a href="/candidate/edit/{{ c.number_for_user }}" class="btn btn-secondary btn-sm">
                    <i class="bi bi-pencil me-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                  </a>
                  <button class="btn btn-ghost btn-sm text-danger" type="button" data-id="{{ c.number_for_user }}" onclick="deleteCandidate(this.dataset.id)">
                    <i class="bi bi-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å
                  </button>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <h3 class="empty-title">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</h3>
        <p class="empty-text">–ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</p>
        <a href="/candidate/add" class="btn btn-primary">
          <i class="bi bi-plus-lg me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        </a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  async function deleteCandidate(id) {
    if (!id) return;
    if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞?")) return;
    try {
      const resp = await fetch("/candidate/delete/" + encodeURIComponent(id), {
        method: "DELETE",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      if (resp.ok) {
        location.reload();
      } else {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞");
      }
    } catch (e) {
      console.error(e);
      alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞");
    }
  }

  // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
  (function() {
    const filterForm = document.getElementById('filter-form');
    const searchInput = document.getElementById('search-input');
    const specializationSelect = document.getElementById('specialization-select');
    const gradeSelect = document.getElementById('grade-select');
    const workFormatSelect = document.getElementById('work_format-select');
    const employmentTypeSelect = document.getElementById('employment_type-select');
    const englishLevelSelect = document.getElementById('english_level-select');
    
    let searchTimeout = null;
    let allCandidates = []; // –•—Ä–∞–Ω–∏–º –≤—Å–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const candidateItems = document.querySelectorAll('.candidate-item');
    candidateItems.forEach(item => {
      const candidateData = {
        element: item,
        name: item.querySelector('.candidate-name')?.textContent?.toLowerCase() || '',
        title: item.querySelector('.candidate-position')?.textContent?.toLowerCase() || '',
        specialization: Array.from(item.querySelectorAll('.chip')).map(chip => chip.textContent.toLowerCase()),
        grade: extractGrade(item),
        workFormat: extractWorkFormat(item),
        employmentType: extractEmploymentType(item),
        englishLevel: extractEnglishLevel(item)
      };
      allCandidates.push(candidateData);
    });
    
    function extractGrade(item) {
      // –ò—â–µ–º –≥—Ä–µ–π–¥ –≤ —Ç–µ–∫—Å—Ç–µ –∏–ª–∏ —Ç–µ–≥–∞—Ö
      const text = item.textContent.toLowerCase();
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å "+" –ø–µ—Ä–≤—ã–º–∏
      if (text.includes('senior+') || text.includes('senior +')) return 'senior+';
      if (text.includes('middle+') || text.includes('middle +')) return 'middle+';
      if (text.includes('junior+') || text.includes('junior +')) return 'junior+';
      if (text.includes('junior')) return 'junior';
      if (text.includes('middle')) return 'middle';
      if (text.includes('senior')) return 'senior';
      if (text.includes('lead')) return 'lead';
      return '';
    }
    
    function extractWorkFormat(item) {
      const text = item.textContent.toLowerCase();
      if (text.includes('office')) return 'office';
      if (text.includes('remote')) return 'remote';
      if (text.includes('hybrid')) return 'hybrid';
      return '';
    }
    
    function extractEmploymentType(item) {
      const text = item.textContent.toLowerCase();
      if (text.includes('full-time') || text.includes('fulltime')) return 'full-time';
      if (text.includes('part-time') || text.includes('parttime')) return 'part-time';
      if (text.includes('project')) return 'project';
      if (text.includes('internship')) return 'internship';
      return '';
    }
    
    function extractEnglishLevel(item) {
      const text = item.textContent.toLowerCase();
      const levels = ['a1', 'a2', 'b1', 'b2', 'c1', 'c2'];
      for (const level of levels) {
        if (text.includes(level)) return level.toUpperCase();
      }
      return '';
    }
    
    function filterCandidates() {
      const searchQuery = (searchInput?.value || '').toLowerCase().trim();
      const specialization = (specializationSelect?.value || '').toLowerCase();
      const grade = (gradeSelect?.value || '').toLowerCase();
      const workFormat = (workFormatSelect?.value || '').toLowerCase();
      const employmentType = (employmentTypeSelect?.value || '').toLowerCase();
      const englishLevel = (englishLevelSelect?.value || '').toLowerCase();
      
      let visibleCount = 0;
      
      allCandidates.forEach(candidate => {
        let visible = true;
        
        // –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/–¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        if (searchQuery) {
          const matchesSearch = 
            candidate.name.includes(searchQuery) || 
            candidate.title.includes(searchQuery);
          if (!matchesSearch) visible = false;
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        if (specialization && visible) {
          const matchesSpec = candidate.specialization.some(spec => 
            spec.includes(specialization) || specialization.includes(spec)
          );
          if (!matchesSpec) visible = false;
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä–µ–π–¥—É
        if (grade && visible) {
          if (candidate.grade !== grade) visible = false;
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ñ–æ—Ä–º–∞—Ç—É —Ä–∞–±–æ—Ç—ã
        if (workFormat && visible) {
          if (candidate.workFormat !== workFormat) visible = false;
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
        if (employmentType && visible) {
          if (candidate.employmentType !== employmentType) visible = false;
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É
        if (englishLevel && visible) {
          if (candidate.englishLevel !== englishLevel) visible = false;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
        candidate.element.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
      const countElement = document.querySelector('.candidates-count');
      if (countElement) {
        countElement.textContent = `${visibleCount} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤`;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
      const emptyState = document.querySelector('.empty-state');
      const candidatesList = document.querySelector('.candidates-list');
      if (visibleCount === 0 && candidatesList) {
        if (!emptyState || emptyState.style.display === 'none') {
          const newEmptyState = document.createElement('div');
          newEmptyState.className = 'empty-state';
          newEmptyState.innerHTML = `
            <div class="empty-icon">üîç</div>
            <h3 class="empty-title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
            <p class="empty-text">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
          `;
          candidatesList.parentElement.appendChild(newEmptyState);
        }
      } else if (emptyState && emptyState.parentElement) {
        emptyState.remove();
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterCandidates, 300);
      });
    }
    
    [specializationSelect, gradeSelect, workFormatSelect, employmentTypeSelect, englishLevelSelect].forEach(select => {
      if (select) {
        select.addEventListener('change', filterCandidates);
      }
    });
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('grade') && gradeSelect) {
      gradeSelect.value = urlParams.get('grade');
    }
    if (urlParams.has('work_format') && workFormatSelect) {
      workFormatSelect.value = urlParams.get('work_format');
    }
    if (urlParams.has('employment_type') && employmentTypeSelect) {
      employmentTypeSelect.value = urlParams.get('employment_type');
    }
    if (urlParams.has('english_level') && englishLevelSelect) {
      englishLevelSelect.value = urlParams.get('english_level');
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    setTimeout(filterCandidates, 100);
  })();

  async function copyToClipboard(text, el) {
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      const originalBg = el.style.backgroundColor;
      el.style.backgroundColor = 'rgba(46, 204, 113, 0.2)';
      el.style.transition = 'all 0.2s';
      setTimeout(() => {
        el.style.backgroundColor = originalBg;
      }, 500);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  }
  
  async function addChat(buttonElement) {
    const candidateId = buttonElement.dataset.candidateId;
    const messageType = buttonElement.dataset.messageType;
    
    if (!candidateId || !messageType) {
      alert('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏–ª–∏ —Ç–∏–ø —á–∞—Ç–∞');
      return;
    }

    const originalContent = buttonElement.innerHTML;
    buttonElement.disabled = true;
    buttonElement.innerHTML = '<span>‚è≥</span>';

    try {
      const response = await fetch(`/candidate/add-chat/${candidateId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message_type: messageType }),
      });

      const data = await response.json();

      if (response.ok) {
        if (data.already_exists) {
          alert(`–ß–∞—Ç ${messageType === 'telegram' ? 'Telegram' : 'Email'} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞`);
          buttonElement.innerHTML = originalContent;
          buttonElement.disabled = false;
        } else {
          buttonElement.innerHTML = '<span>‚úì</span>';
          buttonElement.classList.add('text-success');
          buttonElement.disabled = true;
        }
      } else {
        throw new Error(data.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
      alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞: ${error.message}`);
      buttonElement.innerHTML = originalContent;
      buttonElement.disabled = false;
    }
  }
</script>
{% endblock %}
