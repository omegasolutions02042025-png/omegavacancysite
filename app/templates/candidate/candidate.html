{% extends "layouts/base.html" %}

{% block title %}–ú–æ–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã ‚Äî Omega Hire{% endblock %}

{% block head %}
<style>
  /* Page Layout */
  .candidates-page {
    max-width: 1400px;
    margin: 0 auto;
  }

  .layout-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 992px) {
    .layout-grid {
      grid-template-columns: 1fr;
    }
    
    .filters-sidebar {
      position: static;
      margin-bottom: 24px;
      max-height: none;
      overflow-y: visible;
    }
  }

  /* Filters Sidebar */
  .filters-sidebar {
    background: var(--color-bg-surface);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    position: sticky;
    top: 90px;
    max-height: calc(100vh - 110px);
    overflow-y: auto;
  }

  .filter-section {
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .filter-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .filter-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text-heading);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Custom MultiSelect Dropdown */
  .custom-dropdown {
    position: relative;
    width: 100%;
  }

  .dropdown-header {
    background-color: var(--color-bg-surface-2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    min-height: 38px;
  }
  
  .dropdown-header::after {
    content: '';
    border: solid white;
    border-width: 0 2px 2px 0;
    display: inline-block;
    padding: 3px;
    transform: rotate(45deg);
    transition: transform 0.2s;
    margin-left: 8px;
  }
  
  .custom-dropdown.open .dropdown-header::after {
    transform: rotate(-135deg);
  }

  .selected-chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    min-height: 24px;
  }

  .selected-chip {
    display: inline-flex;
    align-items: center;
    background: rgba(255, 215, 0, 0.15);
    border: 1px solid var(--color-accent-gold);
    color: var(--color-accent-gold);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 0.8rem;
    gap: 6px;
  }

  .selected-chip .close-btn {
    cursor: pointer;
    font-weight: bold;
    font-size: 1.1rem;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    transition: background 0.2s;
  }
  
  .selected-chip .close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .dropdown-body {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    width: 100%;
    z-index: 1000;
    background-color: var(--color-bg-surface);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    display: none;
    max-height: 300px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  }
  
  .custom-dropdown.open .dropdown-body {
    display: flex;
    flex-direction: column;
  }

  .dropdown-search {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: sticky;
    top: 0;
    background-color: var(--color-bg-surface);
    z-index: 1;
  }
  
  .dropdown-search input {
    width: 100%;
    background: var(--color-bg-surface-2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 8px 12px;
    color: white;
    font-size: 0.9rem;
    outline: none;
  }

  .dropdown-search input:focus {
    border-color: var(--color-accent-gold);
    box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.1);
  }

  .dropdown-list {
    overflow-y: auto;
    max-height: 240px;
  }

  .dropdown-list-item {
    padding: 10px 12px;
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
    color: var(--color-text-primary);
    font-size: 0.9rem;
    user-select: none;
  }
  
  .dropdown-list-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }
  
  .dropdown-list-item input[type="checkbox"] {
    margin-right: 10px;
    cursor: pointer;
    width: 18px;
    height: 18px;
    accent-color: var(--color-accent-gold);
  }

  .dropdown-list-item.selected {
    background-color: rgba(255, 215, 0, 0.1);
  }

  .dropdown-loading {
    padding: 12px;
    text-align: center;
    color: var(--color-text-primary);
    font-size: 0.85rem;
  }

  .dropdown-empty {
    padding: 12px;
    text-align: center;
    color: var(--color-text-muted);
    font-size: 0.85rem;
  }

  /* Main Content */
  .candidates-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .search-sort-container {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
    flex: 1;
  }

  .search-input-wrapper {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .search-input-wrapper i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
  }

  .search-input-wrapper input {
    padding-left: 36px;
    width: 100%;
  }

  .sort-controls {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .candidates-count {
    background: var(--color-bg-surface);
    padding: 10px 18px;
    border-radius: 12px;
    color: var(--color-text-heading);
    font-size: 0.95rem;
    font-weight: 500;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .candidates-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .candidate-item {
    padding: 24px;
    margin-bottom: 16px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    background: var(--color-bg-surface);
    transition: all 0.2s;
    border-left: 3px solid transparent;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }

  .candidate-item:hover {
    background-color: rgba(255, 255, 255, 0.03);
    border-left-color: var(--color-accent-gold);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }

  .candidate-item:last-child {
    margin-bottom: 0;
  }

  .candidate-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--color-bg-surface-2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-heading);
    flex-shrink: 0;
    overflow: hidden;
    position: relative;
  }

  .candidate-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
  }

  .candidate-avatar.has-photo img {
    display: block;
  }

  .candidate-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .candidate-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 4px;
  }

  .candidate-header-info {
    flex: 1;
    min-width: 0;
  }

  .candidate-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-text-heading);
    margin: 0 0 4px;
  }

  .candidate-position {
    font-size: 0.95rem;
    color: var(--color-text-primary);
    margin: 0;
  }

  .candidate-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .candidate-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .candidate-row.single-line {
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-bottom: 4px;
  }

  .candidate-row.single-line::-webkit-scrollbar {
    height: 4px;
  }

  .candidate-row.single-line::-webkit-scrollbar-track {
    background: transparent;
  }

  .candidate-row.single-line::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
  }

  .empty-state {
    padding: 80px 40px;
    text-align: center;
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 20px;
  }

  .empty-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-heading);
    margin: 0 0 12px;
  }

  .empty-text {
    font-size: 1rem;
    color: var(--color-text-muted);
    margin: 0 0 24px;
  }

  .candidate-rate-block {
    background: rgba(255, 215, 0, 0.1);
    border: 1px solid rgba(255, 215, 0, 0.2);
  }

  .candidate-rate-chip {
    background: rgba(255, 255, 255, 0.15);
    color: var(--color-text-heading);
    font-weight: 600;
    border: 1px solid rgba(255, 215, 0, 0.3);
  }
</style>
{% endblock %}

{% block content %}
<div class="candidates-page">
  <div class="layout-grid">
    <!-- Sidebar -->
    <aside class="filters-sidebar">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h5 mb-0 text-white">–§–∏–ª—å—Ç—Ä—ã</h2>
        <button id="btn_reset_filters" class="btn btn-ghost btn-sm text-gold">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>

      <!-- Specializations -->
      <div class="filter-section">
        <div class="filter-title">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</div>
        <div class="custom-dropdown" id="dd_specializations"></div>
      </div>

      <!-- Grade -->
      <div class="filter-section">
        <div class="filter-title">–ì—Ä–µ–π–¥</div>
        <div class="custom-dropdown" id="dd_grades"></div>
      </div>

      <!-- Work Format -->
      <div class="filter-section">
        <div class="filter-title">–§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã</div>
        <div class="custom-dropdown" id="dd_work_formats"></div>
      </div>

      <!-- Employment Type -->
      <div class="filter-section">
        <div class="filter-title">–¢–∏–ø –∑–∞–Ω—è—Ç–æ—Å—Ç–∏</div>
        <div class="custom-dropdown" id="dd_employment_types"></div>
      </div>

      <!-- English Level -->
      <div class="filter-section">
        <div class="filter-title">–£—Ä–æ–≤–µ–Ω—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ</div>
        <div class="custom-dropdown" id="dd_english_levels"></div>
      </div>

      <!-- Skills -->
      <div class="filter-section">
        <div class="filter-title">–ù–∞–≤—ã–∫–∏</div>
        <div class="custom-dropdown" id="dd_skills"></div>
      </div>

      <!-- Status -->
      <div class="filter-section">
        <div class="filter-title">–°—Ç–∞—Ç—É—Å</div>
        <div class="custom-dropdown" id="dd_statuses"></div>
      </div>
    </aside>

    <!-- Main Content -->
    <main>
      <div class="candidates-list-header">
        <h1 class="h2 mb-0 text-white">üë• –ú–æ–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã <span id="candidate_counter" class="text-muted fs-5 ms-2">({{ candidates|length if candidates is defined else 0 }})</span></h1>
        <div class="d-flex align-items-center gap-3">
          <a href="/candidate/add" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
          </a>
        </div>
      </div>

      <div class="search-sort-container mb-4">
        <div class="search-input-wrapper">
          <i class="bi bi-search"></i>
          <input
            type="text"
            id="search-input"
            class="form-input"
            placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏..."
            value="{{ current_search }}"
          >
        </div>
        <div class="sort-controls">
          <select id="sort_by" class="form-select form-select-sm" style="background-color: var(--color-bg-surface); border-color: rgba(255,255,255,0.1); color: white; width: auto;">
            <option value="">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
            <option value="rate_asc">–ü–æ —Å—Ç–∞–≤–∫–µ ‚Üë</option>
            <option value="rate_desc">–ü–æ —Å—Ç–∞–≤–∫–µ ‚Üì</option>
            <option value="date_asc">–ü–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ‚Üë</option>
            <option value="date_desc">–ü–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ‚Üì</option>
          </select>
        </div>
      </div>

      <div id="candidates_list" class="card">
        {% if candidates and candidates|length > 0 %}
          <div class="table-container">
            <ul class="candidates-list">
              {% for item in candidates %}
                {% set c = item.candidate %}
                {% set completeness = item.completeness %}
                <li class="candidate-item">
                  <div class="candidate-avatar {% if c.photo_path %}has-photo{% endif %}">
                    {% if c.photo_path %}
                      <img src="{{ c.photo_path }}" alt="{{ c.first_name or '' }} {{ c.last_name or '' }}" onerror="this.style.display='none'; this.parentElement.classList.remove('has-photo');">
                    {% endif %}
                    {% set initials = (c.first_name[0] if c.first_name else "") ~ (c.last_name[0] if c.last_name else "") %}
                    <span {% if c.photo_path %}style="display:none;"{% endif %}>{{ initials if initials else "üë§" }}</span>
                  </div>
                  <div class="candidate-content">
                    <div class="candidate-header">
                      <div class="candidate-header-info">
                        <h3 class="candidate-name">
                          {% if c.first_name and c.last_name and c.middle_name %}
                            {{ c.first_name ~ " " ~ c.last_name ~ " " ~ c.middle_name }}
                          {% elif c.first_name and c.last_name %}
                            {{ c.first_name ~ " " ~ c.last_name }}
                          {% else %}
                            {{ c.first_name or c.last_name or "–ë–µ–∑ –∏–º–µ–Ω–∏" }}
                          {% endif %}
                        </h3>
                        {% if c.title %}
                          <p class="candidate-position">{{ c.title }}</p>
                        {% endif %}
                      </div>
                      <div class="candidate-actions">
                        <a href="/candidate/open/{{ c.number_for_user }}" class="btn btn-primary btn-sm">
                          <i class="bi bi-eye me-1"></i>–û—Ç–∫—Ä—ã—Ç—å
                        </a>
                        <a href="/candidate/edit/{{ c.number_for_user }}" class="btn btn-secondary btn-sm">
                          <i class="bi bi-pencil me-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </a>
                        <button class="btn btn-ghost btn-sm text-danger" type="button" data-id="{{ c.number_for_user }}" onclick="deleteCandidate(this.dataset.id)">
                          <i class="bi bi-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å
                        </button>
                      </div>
                    </div>
                    
                    <!-- –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Å—Ç—Ä–æ–∫—É -->
                    {% if c.specializations %}
                    <div class="candidate-row">
                      {% set specs = c.specializations.split(',') %}
                      {% for spec in specs %}
                        <span class="chip chip-neutral">{{ spec.strip() }}</span>
                      {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- –°–∫–∏–ª–ª—ã –≤ —Å—Ç—Ä–æ–∫—É -->
                    {% if c.skills %}
                    <div class="candidate-row">
                      {% set skills_list = c.skills.split(',') %}
                      {% for skill in skills_list[:5] %}
                        <span class="chip chip-neutral" style="font-size: 0.75rem;">{{ skill.strip() }}</span>
                      {% endfor %}
                      {% if skills_list|length > 5 %}
                        <span class="chip chip-neutral" style="font-size: 0.75rem;">+{{ skills_list|length - 5 }}</span>
                      {% endif %}
                    </div>
                    {% endif %}

                    <!-- –°—Ç–∞—Ç—É—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Å—Ç–∞—Ç—É—Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É -->
                    <div class="candidate-row">
                      {% if completeness == "complete" %}
                        <span class="chip chip-success">
                          <i class="bi bi-check-circle me-1"></i>–í—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
                        </span>
                      {% elif completeness == "incomplete" %}
                        <span class="chip chip-warning">
                          <i class="bi bi-exclamation-triangle me-1"></i>–ï—Å—Ç—å –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è
                        </span>
                      {% endif %}
                      
                      {% if c.status %}
                        {% if c.status == "–í –∞–∫—Ç–∏–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ" %}
                          <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                            <i class="bi bi-search me-1"></i>–í –∞–∫—Ç–∏–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ
                          </span>
                        {% elif c.status == "–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è" %}
                          <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                            <i class="bi bi-eye me-1"></i>–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                          </span>
                        {% elif c.status == "–ù–µ –∏—â–µ—Ç —Ä–∞–±–æ—Ç—É" %}
                          <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                            <i class="bi bi-pause-circle me-1"></i>–ù–µ –∏—â–µ—Ç —Ä–∞–±–æ—Ç—É
                          </span>
                        {% elif c.status == "–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω" %}
                          <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                            <i class="bi bi-clock me-1"></i>–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
                            {% if c.status_until %}
                              <span style="font-size: 0.85em; opacity: 0.9;">(–¥–æ {{ c.status_until[:10] }})</span>
                            {% endif %}
                          </span>
                        {% else %}
                          <span class="chip" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-accent-gold); color: var(--color-accent-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);">
                            {{ c.status }}
                          </span>
                        {% endif %}
                      {% endif %}
                    </div>
                    
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É -->
                    <div class="candidate-row">
                      {% if c.email %}
                        <div class="d-flex align-items-center gap-2 bg-surface p-2 rounded" style="font-size: 0.85rem;">
                          <i class="bi bi-envelope text-gold"></i>
                          <span>{{ c.email }}</span>
                          <button 
                            class="btn btn-ghost btn-sm p-1" 
                            style="font-size: 0.75rem;"
                            data-candidate-id="{{ c.number_for_user }}"
                            data-message-type="email"
                            onclick="addChat(this)"
                            title="–°–æ–∑–¥–∞—Ç—å —á–∞—Ç (Email)">
                            <b>+ –ß–∞—Ç</b>
                          </button>
                        </div>
                      {% endif %}
                      
                      {% if c.telegram %}
                        <div class="d-flex align-items-center gap-2 bg-surface p-2 rounded" style="font-size: 0.85rem;">
                          <i class="bi bi-telegram text-gold"></i>
                          <span>{{ c.telegram }}</span>
                          <button 
                            class="btn btn-ghost btn-sm p-1" 
                            style="font-size: 0.75rem;"
                            data-candidate-id="{{ c.number_for_user }}"
                            data-message-type="telegram"
                            onclick="addChat(this)"
                            title="–°–æ–∑–¥–∞—Ç—å —á–∞—Ç (Telegram)">
                            <b>+ –ß–∞—Ç</b>
                          </button>
                        </div>
                      {% endif %}

                      {% if c.phone %}
                        <div class="d-flex align-items-center gap-2 bg-surface p-2 rounded" 
                             style="font-size: 0.85rem; cursor: pointer;" 
                             onclick="copyToClipboard('{{ c.phone }}', this)" 
                             title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                          <i class="bi bi-telephone text-gold"></i>
                          <span>{{ c.phone }}</span>
                        </div>
                      {% endif %}
                    </div>

                    <!-- –°—Ç–∞–≤–∫–∞ –≤ —Å—Ç—Ä–æ–∫—É -->
                    {% if c.base_rate_amount is not none or c.rate_rub is not none or c.rate_usd is not none or c.rate_eur is not none or c.rate_byn is not none or c.salary_usd is not none %}
                    <div class="candidate-row">
                      <i class="bi bi-currency-exchange text-gold" style="font-size: 1rem;"></i>
                      <strong class="text-gold" style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; margin-right: 8px;">–°—Ç–∞–≤–∫–∞:</strong>
                      {% if c.rate_rub is not none %}
                        <span class="chip candidate-rate-chip">
                          ‚ÇΩ {{ c.rate_rub|round|int }} RUB
                        </span>
                      {% endif %}
                      {% if c.rate_usd is not none %}
                        <span class="chip candidate-rate-chip">
                          $ {{ c.rate_usd|round|int }} USD
                        </span>
                      {% elif c.salary_usd is not none %}
                        <span class="chip candidate-rate-chip">
                          $ {{ c.salary_usd|round|int }} USD
                        </span>
                      {% endif %}
                      {% if c.rate_eur is not none %}
                        <span class="chip candidate-rate-chip">
                          ‚Ç¨ {{ c.rate_eur|round|int }} EUR
                        </span>
                      {% endif %}
                      {% if c.rate_byn is not none %}
                        <span class="chip candidate-rate-chip">
                          Br {{ c.rate_byn|round|int }} BYN
                        </span>
                      {% endif %}
                      {% if c.base_rate_amount is not none and c.base_rate_currency and c.rate_rub is none and c.rate_usd is none and c.rate_eur is none and c.rate_byn is none and c.salary_usd is none %}
                        <span class="chip candidate-rate-chip">
                          {% if c.base_rate_currency == "RUB" %}‚ÇΩ{% elif c.base_rate_currency == "USD" %}${% elif c.base_rate_currency == "EUR" %}‚Ç¨{% elif c.base_rate_currency == "BYN" %}Br{% endif %}
                          {{ c.base_rate_amount|round|int }} {{ c.base_rate_currency }}
                        </span>
                      {% endif %}
                    </div>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <h3 class="empty-title">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</h3>
            <p class="empty-text">–ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</p>
            <a href="/candidate/add" class="btn btn-primary">
              <i class="bi bi-plus-lg me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
            </a>
          </div>
        {% endif %}
      </div>
    </main>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  async function deleteCandidate(id) {
    if (!id) return;
    if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞?")) return;
    try {
      const resp = await fetch("/candidate/delete/" + encodeURIComponent(id), {
        method: "DELETE",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      if (resp.ok) {
        location.reload();
      } else {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞");
      }
    } catch (e) {
      console.error(e);
      alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞");
    }
  }

  async function copyToClipboard(text, el) {
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      const originalBg = el.style.backgroundColor;
      el.style.backgroundColor = 'rgba(46, 204, 113, 0.2)';
      el.style.transition = 'all 0.2s';
      setTimeout(() => {
        el.style.backgroundColor = originalBg;
      }, 500);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  }
  
  async function addChat(buttonElement) {
    const candidateId = buttonElement.dataset.candidateId;
    const messageType = buttonElement.dataset.messageType;
    
    if (!candidateId || !messageType) {
      alert('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏–ª–∏ —Ç–∏–ø —á–∞—Ç–∞');
      return;
    }

    const originalContent = buttonElement.innerHTML;
    buttonElement.disabled = true;
    buttonElement.innerHTML = '<span>‚è≥</span>';

    try {
      const response = await fetch(`/candidate/add-chat/${candidateId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message_type: messageType }),
      });

      const data = await response.json();

      if (response.ok) {
        if (data.already_exists) {
          alert(`–ß–∞—Ç ${messageType === 'telegram' ? 'Telegram' : 'Email'} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞`);
          buttonElement.innerHTML = originalContent;
          buttonElement.disabled = false;
        } else {
          buttonElement.innerHTML = '<span>‚úì</span>';
          buttonElement.classList.add('text-success');
          buttonElement.disabled = true;
        }
      } else {
        throw new Error(data.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
      alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞: ${error.message}`);
      buttonElement.innerHTML = originalContent;
      buttonElement.disabled = false;
    }
  }

  // Debounce Helper
  function debounce(fn, delay) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  // Main Search Trigger - AJAX –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  async function triggerSearch() {
    collectFilters();
    updateURL();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const candidatesList = document.getElementById('candidates_list');
    const originalContent = candidatesList.innerHTML;
    candidatesList.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-gold" role="status"><span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div></div>';
    
    try {
      // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å
      const url = buildURL();
      const response = await fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
      }
      
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –±–ª–æ–∫ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
      const newCandidatesList = doc.getElementById('candidates_list');
      if (newCandidatesList) {
        candidatesList.innerHTML = newCandidatesList.innerHTML;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        const counter = doc.getElementById('candidate_counter');
        if (counter) {
          document.getElementById('candidate_counter').textContent = counter.textContent;
        }
        
        // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        reinitializeEventHandlers();
      } else {
        candidatesList.innerHTML = originalContent;
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:', error);
      candidatesList.innerHTML = originalContent;
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    }
  }
  
  // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ AJAX –∑–∞–≥—Ä—É–∑–∫–∏
  function reinitializeEventHandlers() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ onclick, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —á–∞—Ç–∞ —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ onclick
  }

  // Collect Filters
  function collectFilters() {
    filters.search = document.getElementById('search-input')?.value.trim() || '';
    filters.sort_by = document.getElementById('sort_by')?.value || '';
    
    filters.specializations = dropdowns['dd_specializations']?.getValue() || '';
    filters.grades = dropdowns['dd_grades']?.getValue() || '';
    filters.work_formats = dropdowns['dd_work_formats']?.getValue() || '';
    filters.employment_types = dropdowns['dd_employment_types']?.getValue() || '';
    filters.english_levels = dropdowns['dd_english_levels']?.getValue() || '';
    filters.skills = dropdowns['dd_skills']?.getValue() || '';
    filters.statuses = dropdowns['dd_statuses']?.getValue() || '';
  }

  function buildURL() {
    const params = new URLSearchParams();
    if (filters.search) params.set('search', filters.search);
    if (filters.sort_by) params.set('sort_by', filters.sort_by);
    if (filters.specializations) params.set('specializations', filters.specializations);
    if (filters.grades) params.set('grade', filters.grades);
    if (filters.work_formats) params.set('work_format', filters.work_formats);
    if (filters.employment_types) params.set('employment_type', filters.employment_types);
    if (filters.english_levels) params.set('english_level', filters.english_levels);
    if (filters.skills) params.set('skills', filters.skills);
    if (filters.statuses) params.set('status', filters.statuses);
    
    return '/candidate' + (params.toString() ? '?' + params.toString() : '');
  }

  function updateURL() {
    const newURL = buildURL();
    window.history.pushState({}, '', newURL);
  }

  const filters = {
    search: '',
    sort_by: '',
    specializations: '',
    grades: '',
    work_formats: '',
    employment_types: '',
    english_levels: '',
    skills: '',
    statuses: '',
  };

  // MultiSelect Dropdown Class
  class MultiSelectDropdown {
    constructor(containerId, apiUrl, placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ...') {
      this.container = document.getElementById(containerId);
      this.selectedValues = new Set();
      this.allItems = [];
      this.filteredItems = [];
      this.placeholder = placeholder;
      this.apiUrl = apiUrl;
      this.isLoading = false;
      this.searchTimeout = null;
      
      if (!this.container) return;
      
      this.renderStructure();
      this.attachEvents();
      this.loadInitialItems();
    }

    renderStructure() {
      this.container.innerHTML = `
        <div class="dropdown-header">
          <span class="header-text">${this.placeholder}</span>
        </div>
        <div class="selected-chips-container"></div>
        <div class="dropdown-body">
          <div class="dropdown-search">
            <input type="text" placeholder="–ü–æ–∏—Å–∫..." autocomplete="off">
          </div>
          <div class="dropdown-list"></div>
        </div>
      `;
      
      this.header = this.container.querySelector('.dropdown-header');
      this.headerText = this.container.querySelector('.header-text');
      this.chipsContainer = this.container.querySelector('.selected-chips-container');
      this.listContainer = this.container.querySelector('.dropdown-list');
      this.searchInput = this.container.querySelector('.dropdown-search input');
      this.body = this.container.querySelector('.dropdown-body');
    }

    attachEvents() {
      this.header.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggle();
      });

      document.addEventListener('click', (e) => {
        if (!this.container.contains(e.target)) {
          this.close();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.container.classList.contains('open')) {
          this.close();
        }
      });

      this.searchInput.addEventListener('input', debounce((e) => {
        const query = e.target.value.trim();
        if (query.length >= 2) {
          this.searchItems(query);
        } else if (query.length === 0) {
          this.loadInitialItems();
        } else {
          this.filterItemsLocally(query);
        }
      }, 300));

      this.body.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }

    async loadInitialItems() {
      try {
        this.showLoading();
        const res = await fetch(this.apiUrl);
        const data = await res.json();
        this.allItems = data;
        this.filteredItems = data;
        this.renderItems();
      } catch (e) {
        console.error(`Error loading items for ${this.apiUrl}:`, e);
        this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
      }
    }

    async searchItems(query) {
      if (this.isLoading) return;
      this.isLoading = true;
      this.showLoading();
      
      try {
        const url = `${this.apiUrl}?q=${encodeURIComponent(query)}&limit=100`;
        const res = await fetch(url);
        const data = await res.json();
        this.filteredItems = data;
        this.renderItems();
      } catch (e) {
        console.error(`Error searching items:`, e);
        this.showError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
      } finally {
        this.isLoading = false;
      }
    }

    filterItemsLocally(query) {
      const lower = query.toLowerCase();
      this.filteredItems = this.allItems.filter(item => 
        item.toLowerCase().includes(lower)
      );
      this.renderItems();
    }

    showLoading() {
      this.listContainer.innerHTML = '<div class="dropdown-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    }

    showError(message) {
      this.listContainer.innerHTML = `<div class="dropdown-empty">${message}</div>`;
    }

    toggle() {
      document.querySelectorAll('.custom-dropdown.open').forEach(el => {
        if (el.id !== this.container.id) {
          el.classList.remove('open');
        }
      });
      
      this.container.classList.toggle('open');
      if (this.container.classList.contains('open')) {
        this.searchInput.focus();
        if (this.filteredItems.length === 0 && !this.isLoading) {
          this.loadInitialItems();
        }
      }
    }

    close() {
      this.container.classList.remove('open');
      this.searchInput.value = '';
    }

    renderItems() {
      this.listContainer.innerHTML = '';
      
      if (this.filteredItems.length === 0) {
        this.listContainer.innerHTML = '<div class="dropdown-empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
      }

      this.filteredItems.forEach(item => {
        const div = document.createElement('div');
        const isSelected = this.selectedValues.has(item);
        div.className = `dropdown-list-item ${isSelected ? 'selected' : ''}`;
        
        div.innerHTML = `
          <input type="checkbox" ${isSelected ? 'checked' : ''} value="${this.escapeHtml(item)}">
          <span>${this.escapeHtml(item)}</span>
        `;
        
        const checkbox = div.querySelector('input');
        
        div.addEventListener('click', (e) => {
          if (e.target === checkbox) return;
          checkbox.checked = !checkbox.checked;
          this.toggleSelection(item, checkbox.checked);
        });

        checkbox.addEventListener('change', (e) => {
          e.stopPropagation();
          this.toggleSelection(item, e.target.checked);
        });
        
        this.listContainer.appendChild(div);
      });
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    toggleSelection(value, isSelected) {
      if (isSelected) {
        this.selectedValues.add(value);
      } else {
        this.selectedValues.delete(value);
      }
      this.updateChips();
      this.updateHeader();
      this.renderItems();
      triggerSearch();
    }

    updateChips() {
      this.chipsContainer.innerHTML = '';
      this.selectedValues.forEach(val => {
        const chip = document.createElement('div');
        chip.className = 'selected-chip';
        chip.innerHTML = `
          <span>${this.escapeHtml(val)}</span>
          <span class="close-btn" title="–£–¥–∞–ª–∏—Ç—å">&times;</span>
        `;
        
        chip.querySelector('.close-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleSelection(val, false);
        });
        
        this.chipsContainer.appendChild(chip);
      });
    }

    updateHeader() {
      const count = this.selectedValues.size;
      if (count > 0) {
        this.headerText.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;
      } else {
        this.headerText.textContent = this.placeholder;
      }
    }

    getValue() {
      return Array.from(this.selectedValues).join(',');
    }
    
    reset() {
      this.selectedValues.clear();
      this.searchInput.value = '';
      this.updateChips();
      this.updateHeader();
      this.loadInitialItems();
    }

    setValue(value) {
      if (!value) return;
      const values = value.split(',').map(v => v.trim()).filter(v => v);
      values.forEach(v => this.selectedValues.add(v));
      this.updateChips();
      this.updateHeader();
    }
  }

  const dropdowns = {};

  // Init Dropdowns
  dropdowns['dd_specializations'] = new MultiSelectDropdown('dd_specializations', '/dropdown/candidate-specializations', '–í—Å–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
  dropdowns['dd_grades'] = new MultiSelectDropdown('dd_grades', '/dropdown/candidate-grades', '–í—Å–µ –≥—Ä–µ–π–¥—ã');
  dropdowns['dd_work_formats'] = new MultiSelectDropdown('dd_work_formats', '/dropdown/candidate-work-formats', '–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã');
  dropdowns['dd_employment_types'] = new MultiSelectDropdown('dd_employment_types', '/dropdown/candidate-employment-types', '–í—Å–µ —Ç–∏–ø—ã');
  dropdowns['dd_english_levels'] = new MultiSelectDropdown('dd_english_levels', '/dropdown/candidate-english-levels', '–í—Å–µ —É—Ä–æ–≤–Ω–∏');
  dropdowns['dd_skills'] = new MultiSelectDropdown('dd_skills', '/dropdown/candidate-skills', '–í—Å–µ –Ω–∞–≤—ã–∫–∏');
  dropdowns['dd_statuses'] = new MultiSelectDropdown('dd_statuses', '/dropdown/candidate-statuses', '–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã');

  // Event Listeners
  document.getElementById('search-input')?.addEventListener('input', debounce(() => triggerSearch(), 500));
  document.getElementById('sort_by')?.addEventListener('change', () => triggerSearch());

  // Reset Filters
  document.getElementById('btn_reset_filters')?.addEventListener('click', () => {
    document.getElementById('search-input').value = '';
    document.getElementById('sort_by').value = '';
    
    Object.values(dropdowns).forEach(dd => {
      if (dd && typeof dd.reset === 'function') {
        dd.reset();
      }
    });
    
    filters.search = '';
    filters.sort_by = '';
    filters.specializations = '';
    filters.grades = '';
    filters.work_formats = '';
    filters.employment_types = '';
    filters.english_levels = '';
    filters.skills = '';
    filters.statuses = '';
    
    triggerSearch();
  });

  // Load filters from URL on page load
  function loadFiltersFromURL() {
    const params = new URLSearchParams(window.location.search);
    
    if (params.has('search')) {
      document.getElementById('search-input').value = params.get('search');
      filters.search = params.get('search');
    }
    
    if (params.has('sort_by')) {
      document.getElementById('sort_by').value = params.get('sort_by');
      filters.sort_by = params.get('sort_by');
    }
    
    if (params.has('specializations') && dropdowns['dd_specializations']) {
      dropdowns['dd_specializations'].setValue(params.get('specializations'));
      filters.specializations = params.get('specializations');
    }
    
    if (params.has('grade') && dropdowns['dd_grades']) {
      dropdowns['dd_grades'].setValue(params.get('grade'));
      filters.grades = params.get('grade');
    }
    
    if (params.has('work_format') && dropdowns['dd_work_formats']) {
      dropdowns['dd_work_formats'].setValue(params.get('work_format'));
      filters.work_formats = params.get('work_format');
    }
    
    if (params.has('employment_type') && dropdowns['dd_employment_types']) {
      dropdowns['dd_employment_types'].setValue(params.get('employment_type'));
      filters.employment_types = params.get('employment_type');
    }
    
    if (params.has('english_level') && dropdowns['dd_english_levels']) {
      dropdowns['dd_english_levels'].setValue(params.get('english_level'));
      filters.english_levels = params.get('english_level');
    }
    
    if (params.has('skills') && dropdowns['dd_skills']) {
      dropdowns['dd_skills'].setValue(params.get('skills'));
      filters.skills = params.get('skills');
    }
    
    if (params.has('status') && dropdowns['dd_statuses']) {
      dropdowns['dd_statuses'].setValue(params.get('status'));
      filters.statuses = params.get('status');
    }
  }

  // Wait for dropdowns to initialize, then load filters from URL
  setTimeout(() => {
    loadFiltersFromURL();
  }, 500);
</script>
{% endblock %}
