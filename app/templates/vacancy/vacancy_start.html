{% extends "layouts/base.html" %}

{% block title %}–í–∞–∫–∞–Ω—Å–∏–∏ ‚Äî Omega Hire{% endblock %}

{% block head %}
<style>
  /* Page Layout */
  .vacancy-page {
    max-width: 1400px;
    margin: 0 auto;
  }

  .layout-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 992px) {
    .layout-grid {
      grid-template-columns: 1fr;
    }
    
    .filters-sidebar {
      position: static;
      margin-bottom: 24px;
      max-height: none;
      overflow-y: visible;
    }
    
    .filter-chips {
      gap: 6px;
    }
    
    .chip-label {
      font-size: 0.8rem;
      padding: 5px 10px;
    }
    
    .filter-section {
      margin-bottom: 20px;
      padding-bottom: 16px;
    }
  }
  
  @media (max-width: 576px) {
    .vacancy-list-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .sort-controls {
      width: 100%;
    }
    
    .sort-controls select {
      width: 100%;
    }
    
    .filter-chips {
      gap: 4px;
    }
    
    .chip-label {
      font-size: 0.75rem;
      padding: 4px 8px;
    }
  }

  /* Filters Sidebar */
  .filters-sidebar {
    background: var(--color-bg-surface);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    position: sticky;
    top: 90px; /* Header height + gap */
    max-height: calc(100vh - 110px);
    overflow-y: auto;
  }

  .filter-section {
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .filter-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .filter-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text-heading);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Custom MultiSelect Dropdown */
  .custom-dropdown {
    position: relative;
    width: 100%;
  }

  .dropdown-header {
    background-color: var(--color-bg-surface-2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    min-height: 38px;
  }
  
  .dropdown-header::after {
    content: '';
    border: solid white;
    border-width: 0 2px 2px 0;
    display: inline-block;
    padding: 3px;
    transform: rotate(45deg);
    transition: transform 0.2s;
    margin-left: 8px;
  }
  
  .custom-dropdown.open .dropdown-header::after {
    transform: rotate(-135deg);
  }

  .selected-chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    min-height: 24px;
  }

  .selected-chip {
    display: inline-flex;
    align-items: center;
    background: rgba(255, 215, 0, 0.15);
    border: 1px solid var(--color-accent-gold);
    color: var(--color-accent-gold);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 0.8rem;
    gap: 6px;
  }

  .selected-chip .close-btn {
    cursor: pointer;
    font-weight: bold;
    font-size: 1.1rem;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    transition: background 0.2s;
  }
  
  .selected-chip .close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .dropdown-body {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    width: 100%;
    z-index: 1000;
    background-color: var(--color-bg-surface);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    display: none;
    max-height: 300px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  }
  
  .custom-dropdown.open .dropdown-body {
    display: flex;
    flex-direction: column;
  }

  .dropdown-search {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: sticky;
    top: 0;
    background-color: var(--color-bg-surface);
    z-index: 1;
  }
  
  .dropdown-search input {
    width: 100%;
    background: var(--color-bg-surface-2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 8px 12px;
    color: white;
    font-size: 0.9rem;
    outline: none;
  }

  .dropdown-search input:focus {
    border-color: var(--color-accent-gold);
    box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.1);
  }

  .dropdown-list {
    overflow-y: auto;
    max-height: 240px;
  }

  .dropdown-list-item {
    padding: 10px 12px;
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
    color: var(--color-text-primary);
    font-size: 0.9rem;
    user-select: none;
  }
  
  .dropdown-list-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }
  
  .dropdown-list-item input[type="checkbox"] {
    margin-right: 10px;
    cursor: pointer;
    width: 18px;
    height: 18px;
    accent-color: var(--color-accent-gold);
  }

  .dropdown-list-item.selected {
    background-color: rgba(255, 215, 0, 0.1);
  }

  .dropdown-loading {
    padding: 12px;
    text-align: center;
    color: var(--color-text-primary);
    font-size: 0.85rem;
  }

  .dropdown-empty {
    padding: 12px;
    text-align: center;
    color: var(--color-text-muted);
    font-size: 0.85rem;
  }

  /* Chip Checkboxes */
  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .chip-checkbox {
    position: relative;
    cursor: pointer;
    user-select: none;
  }

  .chip-checkbox input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .chip-label {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 99px;
    background: var(--color-bg-surface-2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--color-text-primary);
    font-size: 0.85rem;
    transition: all 0.2s ease;
  }

  .chip-checkbox input:checked + .chip-label {
    background: rgba(255, 215, 0, 0.15);
    border-color: var(--color-accent-gold);
    color: var(--color-accent-gold);
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
  }

  /* Main Content */
  .vacancy-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .sort-controls {
    display: flex;
    gap: 12px;
  }

  .vacancy-card {
    background: var(--color-bg-surface);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    margin-bottom: 16px;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .vacancy-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    border-color: rgba(255, 215, 0, 0.3);
  }

  .vacancy-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--color-accent-gold);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .vacancy-card:hover::before {
    opacity: 1;
  }

  .vacancy-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }

  .vacancy-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-text-heading);
    margin: 0;
  }

  .vacancy-meta {
    display: flex;
    gap: 16px;
    color: var(--color-text-primary);
    font-size: 0.9rem;
    margin-bottom: 16px;
  }

  .vacancy-meta span {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .vacancy-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
  }

  .tag {
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.05);
    color: var(--color-text-primary);
  }

  .salary-badge {
    background: rgba(46, 204, 113, 0.15);
    color: #2ECC71;
    padding: 4px 10px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="vacancy-page">
  <div class="layout-grid">
    <!-- Sidebar -->
    <aside class="filters-sidebar">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h5 mb-0 text-white">–§–∏–ª—å—Ç—Ä—ã</h2>
        <button id="btn_reset_filters" class="btn btn-ghost btn-sm text-gold">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>

      <!-- Search -->
      <div class="filter-section">
        <div class="position-relative">
          <input type="text" id="search_title" placeholder="–ü–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–∏..." class="form-control" style="padding-left: 36px; background-color: var(--color-bg-surface-2); border-color: rgba(255,255,255,0.1); color: white;">
          <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
        </div>
      </div>

      <!-- Work Format -->
      <div class="filter-section">
        <div class="filter-title">–§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã</div>
        <div id="filter_work_format_group" class="filter-chips">
          <label class="chip-checkbox">
            <input type="checkbox" value="office">
            <span class="chip-label">Office</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="remote">
            <span class="chip-label">Remote</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="hybrid">
            <span class="chip-label">Hybrid</span>
          </label>
        </div>
      </div>

      <!-- Grade -->
      <div class="filter-section">
        <div class="filter-title">–ì—Ä–µ–π–¥</div>
        <div id="filter_grade" class="filter-chips">
          <label class="chip-checkbox">
            <input type="checkbox" value="Junior">
            <span class="chip-label">Junior</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="Junior+">
            <span class="chip-label">Junior+</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="Middle">
            <span class="chip-label">Middle</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="Middle+">
            <span class="chip-label">Middle+</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="Senior">
            <span class="chip-label">Senior</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="Senior+">
            <span class="chip-label">Senior+</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="Lead">
            <span class="chip-label">Lead</span>
          </label>
        </div>
      </div>

      <!-- Employment Type -->
      <div class="filter-section">
        <div class="filter-title">–¢–∏–ø –∑–∞–Ω—è—Ç–æ—Å—Ç–∏</div>
        <div id="filter_employment_type" class="filter-chips">
          <label class="chip-checkbox">
            <input type="checkbox" value="full-time">
            <span class="chip-label">Full-time</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="part-time">
            <span class="chip-label">Part-time</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="project">
            <span class="chip-label">Project</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="internship">
            <span class="chip-label">Internship</span>
          </label>
        </div>
      </div>

      <!-- English Level -->
      <div class="filter-section">
        <div class="filter-title">–£—Ä–æ–≤–µ–Ω—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ</div>
        <div id="filter_english_level" class="filter-chips">
          <label class="chip-checkbox">
            <input type="checkbox" value="A1">
            <span class="chip-label">A1</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="A2">
            <span class="chip-label">A2</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="B1">
            <span class="chip-label">B1</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="B2">
            <span class="chip-label">B2</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="C1">
            <span class="chip-label">C1</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="C2">
            <span class="chip-label">C2</span>
          </label>
        </div>
      </div>

      <!-- Date -->
      <div class="filter-section">
        <div class="filter-title">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</div>
        <select id="filter_days_ago" class="form-select" style="background-color: var(--color-bg-surface-2); border-color: rgba(255,255,255,0.1); color: white;">
          <option value="">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
          <option value="1">–ó–∞ —Å–µ–≥–æ–¥–Ω—è</option>
          <option value="3">–ó–∞ 3 –¥–Ω—è</option>
          <option value="7">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="30">–ó–∞ –º–µ—Å—è—Ü</option>
        </select>
      </div>

      <!-- Quick Filters -->
      <div class="filter-section">
        <div class="filter-title">–ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</div>
        <div id="filter_by_group" class="filter-chips">
          <label class="chip-checkbox">
            <input type="checkbox" value="with_salary">
            <span class="chip-label">–° –∑–∞—Ä–ø–ª–∞—Ç–æ–π</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="recent_week">
            <span class="chip-label">–ó–∞ –Ω–µ–¥–µ–ª—é</span>
          </label>
          <label class="chip-checkbox">
            <input type="checkbox" value="recent_month">
            <span class="chip-label">–ó–∞ –º–µ—Å—è—Ü</span>
          </label>
        </div>
      </div>
      
      <!-- Specializations -->
      <div class="filter-section">
        <div class="filter-title">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</div>
        <div class="custom-dropdown" id="dd_specializations">
           <!-- Rendered by JS -->
        </div>
      </div>

      <!-- Skills -->
      <div class="filter-section">
        <div class="filter-title">–ù–∞–≤—ã–∫–∏</div>
        <div class="custom-dropdown" id="dd_skills"></div>
      </div>

      <!-- Domains -->
      <div class="filter-section">
        <div class="filter-title">–î–æ–º–µ–Ω</div>
        <div class="custom-dropdown" id="dd_domains"></div>
      </div>

      <!-- Location -->
      <div class="filter-section">
        <div class="filter-title">–õ–æ–∫–∞—Ü–∏—è</div>
        <div class="custom-dropdown" id="dd_locations"></div>
      </div>

      <!-- Manager -->
      <div class="filter-section">
        <div class="filter-title">–ú–µ–Ω–µ–¥–∂–µ—Ä</div>
        <div class="custom-dropdown" id="dd_managers"></div>
      </div>

      <!-- Customer -->
      <div class="filter-section">
        <div class="filter-title">–ó–∞–∫–∞–∑—á–∏–∫</div>
        <div class="custom-dropdown" id="dd_customers"></div>
      </div>

      <!-- Categories -->
      <div class="filter-section">
        <div class="filter-title">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <div class="custom-dropdown" id="dd_categories"></div>
      </div>

      <!-- Subcategories -->
      <div class="filter-section">
        <div class="filter-title">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <div class="custom-dropdown" id="dd_subcategories"></div>
      </div>
      
    </aside>

    <!-- Main Content -->
    <main>
      <div class="vacancy-list-header">
        <h1 class="h2 mb-0 text-white">–í–∞–∫–∞–Ω—Å–∏–∏ <span id="vacancy_counter" class="text-muted fs-5 ms-2">(0)</span></h1>
        
        <div class="sort-controls">
          <select id="sort_by" class="form-select form-select-sm" style="background-color: var(--color-bg-surface); border-color: rgba(255,255,255,0.1); color: white; width: auto;">
            <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
            <option value="salary_desc">–ü–æ –∑–∞—Ä–ø–ª–∞—Ç–µ (‚Üì)</option>
          </select>
        </div>
      </div>

      <div id="vacancy_list" class="vacancy-list">
        <!-- Vacancies will be loaded here -->
        <div class="text-center py-5">
          <div class="spinner-border text-gold" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      
      <div id="no_results" class="text-center py-5" style="display: none;">
        <div class="display-1 mb-3">üîç</div>
        <h4 class="text-white">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
        <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
      </div>
      
      <div id="vacancy_loading" class="text-center py-3" style="display: none;">
        <span class="spinner-border spinner-border-sm text-gold me-2"></span> –ó–∞–≥—Ä—É–∑–∫–∞...
      </div>
    </main>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const VACANCY_BASE_URL = '/vacancy/';

    const filters = {
      work_format: [],
      grade: [],
      employment_type: [],
      english_level: [],
      title: '',
      days_ago: null,
      sort_by: 'newest',
      page: 1,
      page_size: 20,
      specializations: [],
      skills: [],
      domains: [],
      categories: [],
      subcategories: [],
      location: '',
      manager: '',
      customer: '',
      filter_by: []
    };

    // Elements
    const elVacancyList = document.getElementById('vacancy_list');
    const elCounter = document.getElementById('vacancy_counter');
    const elNoResults = document.getElementById('no_results');
    const elLoading = document.getElementById('vacancy_loading');
    
    // Inputs
    const elTitleSearch = document.getElementById('search_title');
    const elWorkFormatBlock = document.getElementById('filter_work_format_group');
    const elGradeBlock = document.getElementById('filter_grade');
    const elEmploymentTypeBlock = document.getElementById('filter_employment_type');
    const elEnglishLevelBlock = document.getElementById('filter_english_level');
    const elFilterByBlock = document.getElementById('filter_by_group');
    const elDaysAgo = document.getElementById('filter_days_ago');
    const elSortBy = document.getElementById('sort_by');
    const btnResetFilters = document.getElementById('btn_reset_filters');

    let isLoading = false;
    let hasMore = true;

    // Debounce Helper
    function debounce(fn, delay) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    }

    // Main Search Trigger
    function triggerSearch(resetPage = true) {
      if (resetPage) {
        filters.page = 1;
        hasMore = true;
      }
      collectFilters();
      loadVacancies(filters.page > 1);
    }

    // Collect Filters
    function collectFilters() {
      filters.title = elTitleSearch.value.trim();
      filters.days_ago = elDaysAgo.value ? parseInt(elDaysAgo.value) : null;
      filters.sort_by = elSortBy.value;
      
      // Checkboxes helper
      const getChecked = (container) => {
        return Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
      };
      
      filters.work_format = getChecked(elWorkFormatBlock);
      filters.grade = getChecked(elGradeBlock);
      filters.employment_type = getChecked(elEmploymentTypeBlock);
      filters.english_level = getChecked(elEnglishLevelBlock);
      filters.filter_by = getChecked(elFilterByBlock);

      // Dropdowns - use the instances
      filters.specializations = dropdowns['dd_specializations']?.getValue() || '';
      filters.skills = dropdowns['dd_skills']?.getValue() || '';
      filters.domains = dropdowns['dd_domains']?.getValue() || '';
      filters.location = dropdowns['dd_locations']?.getValue() || '';
      filters.manager = dropdowns['dd_managers']?.getValue() || '';
      filters.customer = dropdowns['dd_customers']?.getValue() || '';
      filters.categories = dropdowns['dd_categories']?.getValue() || '';
      filters.subcategories = dropdowns['dd_subcategories']?.getValue() || '';
    }

    // Load Data
    async function loadVacancies(append = false) {
      if (isLoading || (!hasMore && append)) return;
      isLoading = true;
      
      if (!append) {
        elVacancyList.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-gold" role="status"></div></div>';
        elNoResults.style.display = 'none';
      } else {
        elLoading.style.display = 'block';
      }

      // Build Query String
      const params = new URLSearchParams();
      params.set('page', filters.page);
      params.set('page_size', filters.page_size);
      if (filters.title) params.set('title', filters.title);
      if (filters.sort_by) params.set('sort_by', filters.sort_by);
      if (filters.days_ago) params.set('days_ago', filters.days_ago);
      if (filters.work_format.length) params.set('work_format', filters.work_format.join(','));
      if (filters.grade.length) params.set('grade', filters.grade.join(','));
      if (filters.employment_type.length) params.set('employment_type', filters.employment_type.join(','));
      if (filters.english_level.length) params.set('english_level', filters.english_level.join(','));
      if (filters.filter_by.length) params.set('filter_by', filters.filter_by.join(','));
      
      if (filters.specializations) params.set('specializations', filters.specializations);
      if (filters.skills) params.set('skills', filters.skills);
      if (filters.domains) params.set('domains', filters.domains);
      if (filters.location) params.set('location', filters.location);
      if (filters.manager) params.set('manager', filters.manager);
      if (filters.customer) params.set('customer', filters.customer);
      if (filters.categories) params.set('categories', filters.categories);
      if (filters.subcategories) params.set('subcategories', filters.subcategories);

      try {
        const res = await fetch(`/vacancies/search?${params.toString()}`);
        const data = await res.json();
        
        const items = data.items || data.vacancies || [];
        const total = data.total ?? items.length;
        
        if (!append) {
          elVacancyList.innerHTML = '';
          elCounter.textContent = `(${total})`;
        }

        if (items.length === 0 && !append) {
          elNoResults.style.display = 'block';
          hasMore = false;
        } else {
          renderVacancies(items);
          hasMore = items.length === filters.page_size; // Simple pagination check
        }
      } catch (e) {
        console.error("Error loading vacancies:", e);
        if (!append) elVacancyList.innerHTML = '<div class="text-center text-danger py-5">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
      } finally {
        isLoading = false;
        elLoading.style.display = 'none';
      }
    }

    // Render Items
    function renderVacancies(items) {
      items.forEach(v => {
        const card = document.createElement('div');
        card.className = 'vacancy-card';
        card.onclick = () => window.open(`/vacancy/${v.vacancy_id}`, '_blank');
        
        // Format Date
        let dateStr = '–ù–µ–¥–∞–≤–Ω–æ';
        if (v.created_at) {
            const d = new Date(v.created_at);
            dateStr = d.toLocaleDateString('ru-RU');
        }

        // Salary
        let salaryHtml = '';
        if (v.salary) {
            salaryHtml = `<span class="salary-badge">${v.salary}</span>`;
        }

        // Tags
        let tagsHtml = '';
        const tags = [v.work_format, v.grade, v.location].filter(Boolean);
        tags.forEach(t => {
            tagsHtml += `<span class="tag">${t}</span>`;
        });

        card.innerHTML = `
          <div class="vacancy-header">
            <div>
                <h3 class="vacancy-title">${v.title}</h3>
                <div class="text-muted small mt-1">#${v.vacancy_id}</div>
            </div>
            ${salaryHtml}
          </div>
          <div class="vacancy-meta">
            <span><i class="bi bi-calendar3"></i> ${dateStr}</span>
            ${v.location ? `<span><i class="bi bi-geo-alt"></i> ${v.location}</span>` : ''}
          </div>
          <div class="vacancy-tags">
            ${tagsHtml}
          </div>
        `;
        
        elVacancyList.appendChild(card);
      });
    }

    // Event Listeners
    elTitleSearch.addEventListener('input', debounce(() => triggerSearch(true), 500));
    elSortBy.addEventListener('change', () => triggerSearch(true));
    elDaysAgo.addEventListener('change', () => triggerSearch(true));
    
    // Chip Clicks
    const setupChips = (container) => {
      container.addEventListener('change', (e) => {
        if (e.target.tagName === 'INPUT') triggerSearch(true);
      });
    };
    setupChips(elWorkFormatBlock);
    setupChips(elGradeBlock);
    setupChips(elEmploymentTypeBlock);
    setupChips(elEnglishLevelBlock);
    setupChips(elFilterByBlock);

    // Reset
    btnResetFilters.addEventListener('click', () => {
      elTitleSearch.value = '';
      elDaysAgo.value = '';
      elSortBy.value = 'newest';
      document.querySelectorAll('.chip-checkbox input').forEach(cb => cb.checked = false);
      
      // Reset all dropdowns
      Object.values(dropdowns).forEach(dd => {
        if (dd && typeof dd.reset === 'function') {
          dd.reset();
        }
      });
      
      // Reset filter state
      filters.work_format = [];
      filters.grade = [];
      filters.employment_type = [];
      filters.english_level = [];
      filters.filter_by = [];
      filters.title = '';
      filters.days_ago = null;
      filters.sort_by = 'newest';
      filters.specializations = '';
      filters.skills = '';
      filters.domains = '';
      filters.location = '';
      filters.manager = '';
      filters.customer = '';
      filters.categories = '';
      filters.subcategories = '';
      
      triggerSearch(true);
    });

    // Infinite Scroll
    window.addEventListener('scroll', () => {
      if (!hasMore || isLoading) return;
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
        filters.page++;
        loadVacancies(true);
      }
    });

    // MultiSelect Dropdown Class
    class MultiSelectDropdown {
      constructor(containerId, apiUrl, placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ...') {
        this.container = document.getElementById(containerId);
        this.selectedValues = new Set();
        this.allItems = [];
        this.filteredItems = [];
        this.placeholder = placeholder;
        this.apiUrl = apiUrl;
        this.isLoading = false;
        this.searchTimeout = null;
        
        if (!this.container) return;
        
        this.renderStructure();
        this.attachEvents();
        this.loadInitialItems();
      }

      renderStructure() {
        this.container.innerHTML = `
          <div class="dropdown-header">
            <span class="header-text">${this.placeholder}</span>
          </div>
          <div class="selected-chips-container"></div>
          <div class="dropdown-body">
            <div class="dropdown-search">
              <input type="text" placeholder="–ü–æ–∏—Å–∫..." autocomplete="off">
            </div>
            <div class="dropdown-list"></div>
          </div>
        `;
        
        this.header = this.container.querySelector('.dropdown-header');
        this.headerText = this.container.querySelector('.header-text');
        this.chipsContainer = this.container.querySelector('.selected-chips-container');
        this.listContainer = this.container.querySelector('.dropdown-list');
        this.searchInput = this.container.querySelector('.dropdown-search input');
        this.body = this.container.querySelector('.dropdown-body');
      }

      attachEvents() {
        // Toggle dropdown
        this.header.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggle();
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
          if (!this.container.contains(e.target)) {
            this.close();
          }
        });

        // Close when pressing Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.container.classList.contains('open')) {
            this.close();
          }
        });

        // Search with API call
        this.searchInput.addEventListener('input', debounce((e) => {
          const query = e.target.value.trim();
          if (query.length >= 2) {
            this.searchItems(query);
          } else if (query.length === 0) {
            this.loadInitialItems();
          } else {
            this.filterItemsLocally(query);
          }
        }, 300));

        // Prevent body close when clicking inside
        this.body.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }

      async loadInitialItems() {
        try {
          this.showLoading();
          const res = await fetch(this.apiUrl);
          const data = await res.json();
          this.allItems = data;
          this.filteredItems = data;
          this.renderItems();
        } catch (e) {
          console.error(`Error loading items for ${this.apiUrl}:`, e);
          this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        }
      }

      async searchItems(query) {
        if (this.isLoading) return;
        this.isLoading = true;
        this.showLoading();
        
        try {
          const url = `${this.apiUrl}?q=${encodeURIComponent(query)}&limit=100`;
          const res = await fetch(url);
          const data = await res.json();
          this.filteredItems = data;
          this.renderItems();
        } catch (e) {
          console.error(`Error searching items:`, e);
          this.showError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
        } finally {
          this.isLoading = false;
        }
      }

      filterItemsLocally(query) {
        const lower = query.toLowerCase();
        this.filteredItems = this.allItems.filter(item => 
          item.toLowerCase().includes(lower)
        );
        this.renderItems();
      }

      showLoading() {
        this.listContainer.innerHTML = '<div class="dropdown-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      }

      showError(message) {
        this.listContainer.innerHTML = `<div class="dropdown-empty">${message}</div>`;
      }

      toggle() {
        // Close other dropdowns first
        document.querySelectorAll('.custom-dropdown.open').forEach(el => {
          if (el.id !== this.container.id) {
            el.classList.remove('open');
          }
        });
        
        this.container.classList.toggle('open');
        if (this.container.classList.contains('open')) {
          this.searchInput.focus();
          // Reload items if list is empty
          if (this.filteredItems.length === 0 && !this.isLoading) {
            this.loadInitialItems();
          }
        }
      }

      close() {
        this.container.classList.remove('open');
        // Clear search when closing
        this.searchInput.value = '';
      }

      renderItems() {
        this.listContainer.innerHTML = '';
        
        if (this.filteredItems.length === 0) {
          this.listContainer.innerHTML = '<div class="dropdown-empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
          return;
        }

        this.filteredItems.forEach(item => {
          const div = document.createElement('div');
          const isSelected = this.selectedValues.has(item);
          div.className = `dropdown-list-item ${isSelected ? 'selected' : ''}`;
          
          div.innerHTML = `
            <input type="checkbox" ${isSelected ? 'checked' : ''} value="${this.escapeHtml(item)}">
            <span>${this.escapeHtml(item)}</span>
          `;
          
          const checkbox = div.querySelector('input');
          
          // Handle click on item
          div.addEventListener('click', (e) => {
            // Don't toggle if clicking on checkbox (it handles itself)
            if (e.target === checkbox) return;
            
            checkbox.checked = !checkbox.checked;
            this.toggleSelection(item, checkbox.checked);
            
            // Do NOT close on selection to allow multiple picks
            // if (!checkbox.checked) { ... }
          });

          // Handle checkbox change
          checkbox.addEventListener('change', (e) => {
            e.stopPropagation();
            this.toggleSelection(item, e.target.checked);
          });
          
          this.listContainer.appendChild(div);
        });
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      toggleSelection(value, isSelected) {
        if (isSelected) {
          this.selectedValues.add(value);
        } else {
          this.selectedValues.delete(value);
        }
        this.updateChips();
        this.updateHeader();
        this.renderItems(); // Re-render to update checkboxes
        
        // Trigger global search update
        triggerSearch(true);
      }

      updateChips() {
        this.chipsContainer.innerHTML = '';
        this.selectedValues.forEach(val => {
          const chip = document.createElement('div');
          chip.className = 'selected-chip';
          chip.innerHTML = `
            <span>${this.escapeHtml(val)}</span>
            <span class="close-btn" title="–£–¥–∞–ª–∏—Ç—å">&times;</span>
          `;
          
          chip.querySelector('.close-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleSelection(val, false);
          });
          
          this.chipsContainer.appendChild(chip);
        });
      }

      updateHeader() {
        const count = this.selectedValues.size;
        if (count > 0) {
          this.headerText.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;
        } else {
          this.headerText.textContent = this.placeholder;
        }
      }

      getValue() {
        return Array.from(this.selectedValues).join(',');
      }
      
      reset() {
        this.selectedValues.clear();
        this.searchInput.value = '';
        this.updateChips();
        this.updateHeader();
        this.loadInitialItems();
      }
    }

    const dropdowns = {};

    // Init Dropdowns
    dropdowns['dd_specializations'] = new MultiSelectDropdown('dd_specializations', '/dropdown/specializations', '–í—Å–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
    dropdowns['dd_skills'] = new MultiSelectDropdown('dd_skills', '/dropdown/skills', '–í—Å–µ –Ω–∞–≤—ã–∫–∏');
    dropdowns['dd_domains'] = new MultiSelectDropdown('dd_domains', '/dropdown/domains', '–í—Å–µ –¥–æ–º–µ–Ω—ã');
    dropdowns['dd_locations'] = new MultiSelectDropdown('dd_locations', '/dropdown/locations', '–í—Å–µ –ª–æ–∫–∞—Ü–∏–∏');
    dropdowns['dd_managers'] = new MultiSelectDropdown('dd_managers', '/dropdown/managers', '–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã');
    dropdowns['dd_customers'] = new MultiSelectDropdown('dd_customers', '/dropdown/customers', '–í—Å–µ –∑–∞–∫–∞–∑—á–∏–∫–∏');
    dropdowns['dd_categories'] = new MultiSelectDropdown('dd_categories', '/dropdown/categories', '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
    dropdowns['dd_subcategories'] = new MultiSelectDropdown('dd_subcategories', '/dropdown/subcategories', '–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏');

    // Load filters from URL on page load
    function loadFiltersFromURL() {
      const params = new URLSearchParams(window.location.search);
      
      // Title
      if (params.has('title')) {
        elTitleSearch.value = params.get('title');
        filters.title = params.get('title');
      }
      
      // Days ago
      if (params.has('days_ago')) {
        elDaysAgo.value = params.get('days_ago');
        filters.days_ago = parseInt(params.get('days_ago'));
      }
      
      // Sort by
      if (params.has('sort_by')) {
        elSortBy.value = params.get('sort_by');
        filters.sort_by = params.get('sort_by');
      }
      
      // Work format
      if (params.has('work_format')) {
        const values = params.get('work_format').split(',');
        values.forEach(val => {
          const checkbox = elWorkFormatBlock.querySelector(`input[value="${val.trim()}"]`);
          if (checkbox) checkbox.checked = true;
        });
        filters.work_format = values.map(v => v.trim());
      }
      
      // Grade
      if (params.has('grade')) {
        const values = params.get('grade').split(',');
        values.forEach(val => {
          const checkbox = elGradeBlock.querySelector(`input[value="${val.trim()}"]`);
          if (checkbox) checkbox.checked = true;
        });
        filters.grade = values.map(v => v.trim());
      }
      
      // Employment type
      if (params.has('employment_type')) {
        const values = params.get('employment_type').split(',');
        values.forEach(val => {
          const checkbox = elEmploymentTypeBlock.querySelector(`input[value="${val.trim()}"]`);
          if (checkbox) checkbox.checked = true;
        });
        filters.employment_type = values.map(v => v.trim());
      }
      
      // English level
      if (params.has('english_level')) {
        const values = params.get('english_level').split(',');
        values.forEach(val => {
          const checkbox = elEnglishLevelBlock.querySelector(`input[value="${val.trim()}"]`);
          if (checkbox) checkbox.checked = true;
        });
        filters.english_level = values.map(v => v.trim());
      }
      
      // Filter by
      if (params.has('filter_by')) {
        const values = params.get('filter_by').split(',');
        values.forEach(val => {
          const checkbox = elFilterByBlock.querySelector(`input[value="${val.trim()}"]`);
          if (checkbox) checkbox.checked = true;
        });
        filters.filter_by = values.map(v => v.trim());
      }
      
      // Page
      if (params.has('page')) {
        filters.page = parseInt(params.get('page')) || 1;
      }
    }

    // Update URL without reload
    function updateURL() {
      collectFilters();
      const params = new URLSearchParams();
      
      if (filters.title) params.set('title', filters.title);
      if (filters.days_ago) params.set('days_ago', filters.days_ago);
      if (filters.sort_by && filters.sort_by !== 'newest') params.set('sort_by', filters.sort_by);
      if (filters.work_format.length) params.set('work_format', filters.work_format.join(','));
      if (filters.grade.length) params.set('grade', filters.grade.join(','));
      if (filters.employment_type.length) params.set('employment_type', filters.employment_type.join(','));
      if (filters.english_level.length) params.set('english_level', filters.english_level.join(','));
      if (filters.filter_by.length) params.set('filter_by', filters.filter_by.join(','));
      if (filters.specializations) params.set('specializations', filters.specializations);
      if (filters.skills) params.set('skills', filters.skills);
      if (filters.domains) params.set('domains', filters.domains);
      if (filters.location) params.set('location', filters.location);
      if (filters.manager) params.set('manager', filters.manager);
      if (filters.customer) params.set('customer', filters.customer);
      if (filters.categories) params.set('categories', filters.categories);
      if (filters.subcategories) params.set('subcategories', filters.subcategories);
      if (filters.page > 1) params.set('page', filters.page);
      
      const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.history.pushState({}, '', newURL);
    }

    // Override triggerSearch to update URL
    const originalTriggerSearch = triggerSearch;
    triggerSearch = function(resetPage = true) {
      originalTriggerSearch(resetPage);
      updateURL();
    };

    // Wait a bit for dropdowns to initialize, then load filters from URL and vacancies
    setTimeout(() => {
      loadFiltersFromURL();
      
      // Load dropdown values from URL after initialization
      const params = new URLSearchParams(window.location.search);
      ['specializations', 'skills', 'domains', 'locations', 'managers', 'customers', 'categories', 'subcategories'].forEach(key => {
        const paramKey = key === 'locations' ? 'location' : key === 'customers' ? 'customer' : key;
        if (params.has(paramKey)) {
          const values = params.get(paramKey).split(',');
          const dropdownId = `dd_${key}`;
          if (dropdowns[dropdownId]) {
            values.forEach(val => {
              dropdowns[dropdownId].toggleSelection(val.trim(), true);
            });
            filters[paramKey] = values.join(',');
          }
        }
      });
      
      loadVacancies();
    }, 500);
</script>
{% endblock %}
