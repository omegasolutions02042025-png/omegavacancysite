# Диаграмма потоков архивации пользователей

## 🔄 Поток архивации

```
┌─────────────────────────────────────────────────────────────────┐
│                    АДМИНИСТРАТОР                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Открывает панель │
                    │  /admin/dashboard│
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Находит активного│
                    │   пользователя   │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Нажимает кнопку  │
                    │   "🗄️ Архив"    │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   Подтверждает   │
                    │     действие     │
                    └──────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     POST /admin/archive-user            │
        │     - Проверка авторизации админа       │
        │     - Вызов user_repo.archive_user()    │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     UserRepository.archive_user()       │
        │     - is_archived = True                │
        │     - archived_at = now()               │
        │     - archived_by_admin = admin_id      │
        │     - Сохранение в БД                   │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     Отправка Email уведомления          │
        │     "Аккаунт переведен в архив"         │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     Обновление UI                       │
        │     - Статус: "Архив" (красный)         │
        │     - Фон строки: серый                 │
        │     - Кнопка: "↩️ Восстановить"        │
        └─────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ ✅ ПОЛЬЗОВАТЕЛЬ  │
                    │   В АРХИВЕ       │
                    └──────────────────┘
```

---

## 🔓 Поток восстановления

```
┌─────────────────────────────────────────────────────────────────┐
│                    АДМИНИСТРАТОР                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Открывает панель │
                    │  /admin/dashboard│
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Находит архивного│
                    │   пользователя   │
                    │   (серый фон)    │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Нажимает кнопку  │
                    │ "↩️ Восстановить"│
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   Подтверждает   │
                    │     действие     │
                    └──────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     POST /admin/unarchive-user          │
        │     - Проверка авторизации админа       │
        │     - Вызов user_repo.unarchive_user()  │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     UserRepository.unarchive_user()     │
        │     - is_archived = False               │
        │     - archived_at = None                │
        │     - archived_by_admin = None          │
        │     - Сохранение в БД                   │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     Отправка Email уведомления          │
        │     "Аккаунт восстановлен"              │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     Обновление UI                       │
        │     - Статус: "Активен" (зеленый)       │
        │     - Фон строки: белый                 │
        │     - Полный набор кнопок               │
        └─────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ ✅ ПОЛЬЗОВАТЕЛЬ  │
                    │    АКТИВЕН       │
                    └──────────────────┘
```

---

## 🚫 Поток блокировки входа

```
┌─────────────────────────────────────────────────────────────────┐
│                АРХИВНЫЙ ПОЛЬЗОВАТЕЛЬ                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Открывает страницу│
                    │   /auth/login    │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  Вводит email и  │
                    │     пароль       │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Нажимает "Войти" │
                    └──────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     POST /auth/login                    │
        │     - Получение email и password        │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │     user_repo.authenticate()            │
        │     - Проверка email                    │
        │     - Проверка пароля                   │
        └─────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Пользователь     │
                    │   найден?        │
                    └──────────────────┘
                         │         │
                    ❌ НЕТ       ✅ ДА
                         │         │
                         ▼         ▼
              ┌──────────────┐  ┌──────────────┐
              │ HTTP 400     │  │ Проверка     │
              │ "Неверный    │  │ is_archived  │
              │ email/пароль"│  └──────────────┘
              └──────────────┘         │
                                       ▼
                              ┌──────────────────┐
                              │  is_archived =   │
                              │     True?        │
                              └──────────────────┘
                                   │         │
                              ✅ ДА       ❌ НЕТ
                                   │         │
                                   ▼         ▼
                    ┌──────────────────┐  ┌──────────────┐
                    │ HTTP 403         │  │ Создание JWT │
                    │ "Аккаунт в       │  │ токена       │
                    │  архиве"         │  └──────────────┘
                    └──────────────────┘         │
                              │                  ▼
                              │         ┌──────────────┐
                              │         │ Установка    │
                              │         │ cookie       │
                              │         └──────────────┘
                              │                  │
                              │                  ▼
                              │         ┌──────────────┐
                              │         │ Редирект на  │
                              │         │ /auth/profile│
                              │         └──────────────┘
                              │                  │
                              │                  ▼
                              │         ┌──────────────┐
                              │         │ ✅ УСПЕШНЫЙ  │
                              │         │    ВХОД      │
                              │         └──────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ 🚫 ВХОД          │
                    │   ЗАБЛОКИРОВАН   │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Сообщение:       │
                    │ "Ваш аккаунт     │
                    │  находится в     │
                    │  архиве..."      │
                    └──────────────────┘
```

---

## 📊 Состояния пользователя

```
┌─────────────────────────────────────────────────────────────────┐
│                      ЖИЗНЕННЫЙ ЦИКЛ                              │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐
    │  СОЗДАН АДМИНОМ  │
    │  is_archived =   │
    │     False        │
    └──────────────────┘
              │
              │ (по умолчанию)
              ▼
    ┌──────────────────┐
    │     АКТИВЕН      │◄─────────────────┐
    │  🟢 Может войти  │                  │
    │  🟢 Может работать│                  │
    └──────────────────┘                  │
              │                           │
              │ (архивация)               │
              ▼                           │
    ┌──────────────────┐                  │
    │      АРХИВ       │                  │
    │  🔴 Вход запрещен│                  │
    │  🔴 Работа запрещена                │
    │  ✅ Данные сохранены                │
    └──────────────────┘                  │
              │                           │
              │ (восстановление)          │
              └───────────────────────────┘
```

---

## 🗄️ Структура базы данных

```
┌─────────────────────────────────────────────────────────────────┐
│                       Таблица: users                             │
├─────────────────────────────────────────────────────────────────┤
│ id                  INTEGER PRIMARY KEY                          │
│ email               VARCHAR UNIQUE                               │
│ password            VARCHAR                                      │
│ ...                 (другие поля)                                │
│                                                                  │
│ ┌────────────────────────────────────────────────────────────┐  │
│ │              НОВЫЕ ПОЛЯ ДЛЯ АРХИВАЦИИ                      │  │
│ ├────────────────────────────────────────────────────────────┤  │
│ │ is_archived         BOOLEAN DEFAULT FALSE                  │  │
│ │ archived_at         VARCHAR (ISO timestamp)                │  │
│ │ archived_by_admin   INTEGER FK -> admins(id)              │  │
│ └────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

Примеры значений:

┌────────────────────────────────────────────────────────────────┐
│ АКТИВНЫЙ ПОЛЬЗОВАТЕЛЬ                                          │
├────────────────────────────────────────────────────────────────┤
│ is_archived:       false                                       │
│ archived_at:       null                                        │
│ archived_by_admin: null                                        │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│ АРХИВНЫЙ ПОЛЬЗОВАТЕЛЬ                                          │
├────────────────────────────────────────────────────────────────┤
│ is_archived:       true                                        │
│ archived_at:       "2024-12-02T15:30:45.123456"               │
│ archived_by_admin: 1                                           │
└────────────────────────────────────────────────────────────────┘
```

---

## 🎨 UI состояния в админ-панели

```
┌─────────────────────────────────────────────────────────────────┐
│                    АКТИВНЫЙ ПОЛЬЗОВАТЕЛЬ                         │
├─────────────────────────────────────────────────────────────────┤
│ ID    Email              Пароль    Статус    Действия           │
├─────────────────────────────────────────────────────────────────┤
│ #5    user@mail.com      pass123   🟢 Активен                   │
│                                                                  │
│       [🔐 Доступ] [🔑 Пароль] [📊 Сверки]                      │
│       [👥 Кандидаты] [🗄️ Архив]                               │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    АРХИВНЫЙ ПОЛЬЗОВАТЕЛЬ                         │
│                    (серый фон строки)                            │
├─────────────────────────────────────────────────────────────────┤
│ ID    Email              Пароль    Статус    Действия           │
├─────────────────────────────────────────────────────────────────┤
│ #5    user@mail.com      pass123   🔴 Архив                     │
│       🗄️ В архиве                                              │
│                                                                  │
│       [↩️ Восстановить] [📊 Сверки] [👥 Кандидаты]            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📧 Email уведомления

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПРИ АРХИВАЦИИ                                 │
├─────────────────────────────────────────────────────────────────┤
│ От:     noreply@omegahire.tech                                  │
│ Кому:   user@mail.com                                           │
│ Тема:   Аккаунт переведен в архив - OmegaHire                  │
│                                                                  │
│ Здравствуйте!                                                   │
│                                                                  │
│ Ваш аккаунт в системе OmegaHire был переведен в архив          │
│ администратором.                                                │
│                                                                  │
│ Вы больше не можете войти в систему.                           │
│                                                                  │
│ Если у вас есть вопросы, обратитесь к администратору.          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  ПРИ ВОССТАНОВЛЕНИИ                              │
├─────────────────────────────────────────────────────────────────┤
│ От:     noreply@omegahire.tech                                  │
│ Кому:   user@mail.com                                           │
│ Тема:   Аккаунт восстановлен - OmegaHire                       │
│                                                                  │
│ Здравствуйте!                                                   │
│                                                                  │
│ Ваш аккаунт в системе OmegaHire был восстановлен из архива     │
│ администратором.                                                │
│                                                                  │
│ Теперь вы снова можете войти в систему, используя свои         │
│ учетные данные.                                                 │
│                                                                  │
│ Войти: http://omegahire.tech/auth/login                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔐 Матрица доступа

```
┌─────────────────────────────────────────────────────────────────┐
│              ЧТО МОЖЕТ ДЕЛАТЬ ПОЛЬЗОВАТЕЛЬ                       │
├─────────────────────────────────────────────────────────────────┤
│ Действие                    │ Активный │ Архивный              │
├─────────────────────────────┼──────────┼───────────────────────┤
│ Войти в систему             │    ✅    │    ❌                 │
│ Просмотр профиля            │    ✅    │    ❌                 │
│ Создание кандидатов         │    ✅    │    ❌                 │
│ Проведение сверок           │    ✅    │    ❌                 │
│ Отправка сообщений          │    ✅    │    ❌                 │
│ Изменение настроек          │    ✅    │    ❌                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│            ЧТО МОЖЕТ ДЕЛАТЬ АДМИНИСТРАТОР                        │
├─────────────────────────────────────────────────────────────────┤
│ Действие                    │ Активный │ Архивный              │
├─────────────────────────────┼──────────┼───────────────────────┤
│ Просмотр данных             │    ✅    │    ✅                 │
│ Просмотр кандидатов         │    ✅    │    ✅                 │
│ Просмотр сверок             │    ✅    │    ✅                 │
│ Управление доступом         │    ✅    │    ❌                 │
│ Смена пароля                │    ✅    │    ❌                 │
│ Архивация                   │    ✅    │    ❌                 │
│ Восстановление              │    ❌    │    ✅                 │
└─────────────────────────────────────────────────────────────────┘
```

---

**Легенда:**
- ✅ = Разрешено
- ❌ = Запрещено
- 🟢 = Активный статус
- 🔴 = Архивный статус
- 🗄️ = Архив
- ↩️ = Восстановление

